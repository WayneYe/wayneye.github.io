---
title: Setup MongoDB with sharding infrastructure
categories:
  - Hack
tags:
  - Hack
permalink: Setup_MongoDB_With_Sharding_Infrastructure
---

<h2 id="SettingupMongoDBwithshardinginfrastructure-Thelandscape">The landscape&nbsp;</h2>
<p>Sharding is the strategy that MongoDB uses to horizentally scale the entire data store infrustructure and meet the demands of data,growth, the infrastructure can be demonstrated as image below:</p>
<p><img class="confluence-embedded-image" alt="sharding" src="https://ejlfia.dm2301.livefilestore.com/y2p9rDBHBoQyOPgwqzq_r8IFm0VjCKQcXtIBeV1CqrWSCZys2zy3HoAkcRGctX2nuet133GdHvphYKi7tXLqYNYqu3TyHwBYOd65E0_1UIhDoE/ShardReplica.jpg?psid=1" /></p>
<h2 id="SettingupMongoDBwithshardinginfrastructure-Preparation">Preparation</h2>
<p>To simulate a production like environment, a minimum number of <strong>7 physical/virtual servers</strong> are required, the role of them are:</p>
<ul>
<li><strong>3 for Mongo config servers</strong></li>
<li><strong>1 for&nbsp;Mongo shard server (mongos)</strong></li>
<li><strong>3 for a Mongo shard (<strong>Replica set</strong>), 1&nbsp;<strong><a class="external-link" href="http://docs.mongodb.org/manual/reference/glossary/#term-primary" rel="nofollow">primary&nbsp;</a>and 2&nbsp;<a class="external-link" href="http://docs.mongodb.org/manual/reference/glossary/#term-secondary" rel="nofollow">secondary</a>&nbsp;(or 1 secondary and 1 arbiter).</strong></strong></li>
</ul>
<p>Note: all the machines above need have <em>mongod</em> installed, for installation, refer: <a class="external-link" href="http://docs.mongodb.org/manual/installation/" rel="nofollow">Install MongoDB</a>.</p>
$More$
<h2 id="SettingupMongoDBwithshardinginfrastructure-SetUpSteps">SetUp Steps</h2>
<p>Concentrated steps of setting up sharded MongoDB are summarized below;&nbsp;a complete tutorial from MongoDB's official website can be found at:&nbsp;<strong><a class="external-link" href="http://docs.mongodb.org/manual/tutorial/deploy-shard-cluster/" rel="nofollow">Deploy a Sharded Cluster</a></strong>.:</p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-1.SetupConfigserver">1. Setup Config server</h3>
<p>sudo mkdir -p /data/configdb<br />sudo mongod --configsvr --dbpath /data/configdb --port 27019</p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-2.SetupMongoShardserver%28mongos%29">2. Setup Mongo Shard server (mongos)</h3>
<p>mongos --configdb [config_server_ip/host]</p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-3.SetupShard1~N">3. Setup Shard 1~N</h3>
<p>In MangoDB production deployment, a "shard" should be a replica set, a<span style="background-color: transparent; line-height: 1.4285715;">&nbsp;typical "three member" replica sets architecture is like below:</span></p>
<p><img class="confluence-embedded-image confluence-external-resource" alt="" src="http://docs.mongodb.org/master/_images/replica-set-primary-with-two-secondaries.png" data-image-src="http://docs.mongodb.org/master/_images/replica-set-primary-with-two-secondaries.png" /></p>
<p>Or</p>
<p><img class="confluence-embedded-image confluence-external-resource" alt="" src="http://docs.mongodb.org/master/_images/replica-set-primary-with-secondary-and-arbiter.png" data-image-src="http://docs.mongodb.org/master/_images/replica-set-primary-with-secondary-and-arbiter.png" /></p>
<p>"Three member" essentially are three <strong><em>mongod</em> </strong>processes with heartbeat and full replication between each other, they can run on one physical machine (for development/test use) or on separate machines (real production), this infrastructure provides "<strong>additional fault tolerance and high availability</strong>".&nbsp;</p>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Setupprimary">Setup primary</h4>
<ol>
<li>
<p>Modify /etc/mongo.conf and ensure the following value are set correctly:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_663228" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">port = 27017</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">bind_ip = 0.0.0.0</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">dbpath = </code><code class="bash plain">/media/mongo_volume/db/</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">fork = </code><code class="bash functions">true</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">replSet = rs0</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
<li>Start the mongod process:<br /><em>mongod --config /etc/mongodb.conf</em></li>
<li>rs.initiate() # or explicitly:&nbsp;rs.initiate({_id: "rs1", members: [{_id: 0, host: "rs1-1"}]})</li>
<li>rs.conf()</li>
<li>rs.add("{secondary_host}")</li>
</ol>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Setupsecondary">Setup secondary</h4>
<ol>
<li>
<p>Modify /etc/mongo.conf and ensure the following value are set correctly:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_193651" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">port = 27017</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">bind_ip = 0.0.0.0</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">dbpath = </code><code class="bash plain">/media/mongo_volume/db/</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">fork = </code><code class="bash functions">true</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">replSet = rs0</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
<li>Start the mongod process:<br /><em>mongod --config /etc/mongodb.conf</em></li>
<li>rs.initiate()</li>
<li>rs.conf()</li>
</ol>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Setuparbiter">Setup&nbsp;<a class="external-link" href="http://docs.mongodb.org/manual/core/replica-set-arbiter/" rel="nofollow">arbiter</a></h4>
<p>Arbiter is like a "guard process" and consumers no dedicated hardware resource, for out concrete case, I setup arbiter on the mongos server.</p>
<ol>
<li>mkdir /var/lib/mongo/arb/</li>
<li>mongod --port 30000 --dbpath /var/lib/mongo/arb/ --replSet rs0 --smallfiles</li>
<li>Connect to the mongo shell of the primary and run:<br />rs.addArb("{arbiter_host}<a class="external-link" href="http://net:30000/" rel="nofollow">:30000</a>")&nbsp;</li>
</ol>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Verification">Verification</h4>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>rs.conf()</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_41421" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">rs0:PRIMARY&gt; rs.conf()</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">{</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"rs0"</code><code class="bash plain">,</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"version"</code> <code class="bash plain">: 3,</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"members"</code> <code class="bash plain">: [</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 0,</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"rs1-2"</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 1,</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"rs1-1"</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 2,</code></div>
<div class="line number16 index15 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"mongos"</code><code class="bash plain">,</code></div>
<div class="line number17 index16 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"arbiterOnly"</code> <code class="bash plain">: </code><code class="bash functions">true</code></div>
<div class="line number18 index17 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div>
<div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">]</code></div>
<div class="line number20 index19 alt1"><code class="bash plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>rs.status()</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_945508" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">rs0:PRIMARY&gt; rs.status()</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">{</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"set"</code> <code class="bash plain">: </code><code class="bash string">"rs0"</code><code class="bash plain">,</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"date"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:41Z"</code><code class="bash plain">),</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"myState"</code> <code class="bash plain">: 1,</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"members"</code> <code class="bash plain">: [</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 0,</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"name"</code> <code class="bash plain">: </code><code class="bash string">"rs1-2"</code><code class="bash plain">,</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"health"</code> <code class="bash plain">: 1,</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"state"</code> <code class="bash plain">: 2,</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"stateStr"</code> <code class="bash plain">: </code><code class="bash string">"SECONDARY"</code><code class="bash plain">,</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"uptime"</code> <code class="bash plain">: 299,</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optime"</code> <code class="bash plain">: Timestamp(1387270069, 1),</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optimeDate"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:47:49Z"</code><code class="bash plain">),</code></div>
<div class="line number16 index15 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeat"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:40Z"</code><code class="bash plain">),</code></div>
<div class="line number17 index16 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeatRecv"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:39Z"</code><code class="bash plain">),</code></div>
<div class="line number18 index17 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"pingMs"</code> <code class="bash plain">: 0,</code></div>
<div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"syncingTo"</code> <code class="bash plain">: </code><code class="bash string">"rs1-1"</code></div>
<div class="line number20 index19 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number21 index20 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number22 index21 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 1,</code></div>
<div class="line number23 index22 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"name"</code> <code class="bash plain">: </code><code class="bash string">"rs1-1"</code><code class="bash plain">,</code></div>
<div class="line number24 index23 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"health"</code> <code class="bash plain">: 1,</code></div>
<div class="line number25 index24 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"state"</code> <code class="bash plain">: 1,</code></div>
<div class="line number26 index25 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"stateStr"</code> <code class="bash plain">: </code><code class="bash string">"PRIMARY"</code><code class="bash plain">,</code></div>
<div class="line number27 index26 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"uptime"</code> <code class="bash plain">: 317,</code></div>
<div class="line number28 index27 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optime"</code> <code class="bash plain">: Timestamp(1387270069, 1),</code></div>
<div class="line number29 index28 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optimeDate"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:47:49Z"</code><code class="bash plain">),</code></div>
<div class="line number30 index29 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"self"</code> <code class="bash plain">: </code><code class="bash functions">true</code></div>
<div class="line number31 index30 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number32 index31 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number33 index32 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 2,</code></div>
<div class="line number34 index33 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"name"</code> <code class="bash plain">: </code><code class="bash string">"mongos"</code><code class="bash plain">,</code></div>
<div class="line number35 index34 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"health"</code> <code class="bash plain">: 0,</code></div>
<div class="line number36 index35 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"state"</code> <code class="bash plain">: 8,</code></div>
<div class="line number37 index36 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"stateStr"</code> <code class="bash plain">: </code><code class="bash string">"(not reachable/healthy)"</code><code class="bash plain">,</code></div>
<div class="line number38 index37 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"uptime"</code> <code class="bash plain">: 0,</code></div>
<div class="line number39 index38 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeat"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:24Z"</code><code class="bash plain">),</code></div>
<div class="line number40 index39 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeatRecv"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"1970-01-01T00:00:00Z"</code><code class="bash plain">),</code></div>
<div class="line number41 index40 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"pingMs"</code> <code class="bash plain">: 0</code></div>
<div class="line number42 index41 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div>
<div class="line number43 index42 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">],</code></div>
<div class="line number44 index43 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"ok"</code> <code class="bash plain">: 1</code></div>
<div class="line number45 index44 alt2"><code class="bash plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Troubleshooting">Trouble shooting</h4>
<p>For experimental made mistakes, we can run the following command on mongo config server to "reset" the sharding status:</p>
<p><em>&gt; use config</em><br /><em>&gt; db.shards.drop()&nbsp;</em></p>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Officialdocumentations">Official documentations</h4>
<ul>
<li><a class="external-link" href="http://docs.mongodb.org/manual/tutorial/deploy-replica-set/" rel="nofollow">Deploy a replica set</a></li>
<li><a class="external-link" href="http://docs.mongodb.org/manual/tutorial/add-replica-set-arbiter/" rel="nofollow">Add an Arbiter to Replica Set</a>&nbsp;</li>
</ul>
<blockquote><strong>Caveats</strong>: In real production environment, a minimum of&nbsp;<strong>3 replica-sets</strong>&nbsp;is required. With two nodes, it can get replication of data (i.e.: they will copy each other), but it will not get automatic fail-over or high availability, hence we should never run production data with less than 3 nodes!</blockquote>
<p>After replica set are all setup we can add it to mongo sharding server as a "<strong>shard</strong>":</p>
<p>First we need make sure the local mongod process is running on each shard, then we can use mongo shell to connect to the mongos server and tell the mongos add each shard respectively:<br /><em>mongo --host [mongos_server_ip/host]</em></p>
<p><em style="line-height: 1.4285715;">&gt; <em>sh.addShard("[<strong>replSetName</strong>: e.g.&nbsp;rs0/[<strong>mongod_ip</strong>/port]") # e.g. sh.addShard("rs0/ &nbsp;</em><em>For single mongod in development environment,&nbsp;</em>sh.addShard("[shard_ip/host]:27017") #&nbsp;</em></p>
<p><em>&gt; sh.enableSharding("[database]") # Sharding a database</em><br /><em>&gt; sh.shardCollection("[database].[collection]", shard-key-pattern) # Sharding a collection with a shard key</em></p>
<p>Concrete example of setting up a Mongo shard for "Collection_Name"<br /><em>mongo --host mongos</em><br /><em>sh.addShard("rs1-0")</em><br /><em>sh.enableSharding("{Database name}")</em><br /><em>sh.shardCollection("{Database name}.{Collection name}", {user_id:1})</em></p>
<p>#&nbsp;Verify the sharding status by running "<strong><em>sh.status()</em></strong>" in mongo shell:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>sh.status()</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_466316" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">mongos&gt; sh.status()</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">--- Sharding Status --- </code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">sharding version: {</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 1,</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"version"</code> <code class="bash plain">: 3,</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"minCompatibleVersion"</code> <code class="bash plain">: 3,</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"currentVersion"</code> <code class="bash plain">: 4,</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"clusterId"</code> <code class="bash plain">: ObjectId(</code><code class="bash string">"5264c5c753b45824c363f402"</code><code class="bash plain">)</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">}</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">shards:</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"shard0"</code> <code class="bash plain">}</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"shard0001"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"rs1-0"</code> <code class="bash plain">}</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">databases:</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"admin"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">false</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"config"</code> <code class="bash plain">}</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"test"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">false</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code> <code class="bash plain">}</code></div>
<div class="line number16 index15 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"mongo_demo"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">false</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code> <code class="bash plain">}</code></div>
<div class="line number17 index16 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"{Database name}"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">true</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code> <code class="bash plain">}</code></div>
<div class="line number18 index17 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{Database name}.EntendedProfiles</code></div>
<div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard key: { </code><code class="bash string">"user_id"</code> <code class="bash plain">: 1 }</code></div>
<div class="line number20 index19 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chunks:</code></div>
<div class="line number21 index20 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</code></div>
<div class="line number22 index21 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{ </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$minKey"</code> <code class="bash plain">: 1 } } --&gt;&gt; { </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$maxKey"</code> <code class="bash plain">: 1 } } on : shard0000 Timestamp(1, 0) </code></div>
<div class="line number23 index22 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{Database name}.{Collection name}</code></div>
<div class="line number24 index23 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard key: { </code><code class="bash string">"user_id"</code> <code class="bash plain">: 1 }</code></div>
<div class="line number25 index24 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chunks:</code></div>
<div class="line number26 index25 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</code></div>
<div class="line number27 index26 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{ </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$minKey"</code> <code class="bash plain">: 1 } } --&gt;&gt; { </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$maxKey"</code> <code class="bash plain">: 1 } } on : shard0000 Timestamp(1, 0)</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<h4 id="SettingupMongoDBwithshardinginfrastructure-FinalinfrastructureforOxygen%27s{Collection name}"><span style="font-size: 1.5em;">Additional notes&nbsp;</span></h4>
<h3 id="SettingupMongoDBwithshardinginfrastructure-AmazonEBSvolume"><span style="background-color: transparent; line-height: 1.4285715;">Amazon EBS volume</span></h3>
<p><span style="background-color: transparent; line-height: 1.4285715;">If we are setting up shards on Amazon: we need mount the Amazon </span><strong style="background-color: transparent; line-height: 1.4285715;">EBS</strong><span style="background-color: transparent; line-height: 1.4285715;"> (Elastic Block Storage) and use the EBS to store Mongo logs and DB data, run the following command on a shard instance:</span></p>
<p><em>sudo su</em><br /><em>Fdisk -l &nbsp;#To examine all disk partitions, find the partition we want to mount</em><br /><em>mkfs -t ext4 /dev/xvdf &nbsp;# Format the partition to ext4 file format (/dev/xvdf could be /dev/sdb, /dev/sdh etc) </em><br /><em>mkdir /media/mongo_volume # Make the directory where we supposed to mount the partition and store MongoDB data</em><br /><em>mount /dev/xvdf /media/mongo_volume</em></p>
<p>#Modify /etc/mongo.conf, ensure Mongo used the mounted partision to store logs and DB data<br /><em>logpath=/media/mongo_volume/log/mongod.log</em><br /><em>dbpath=/media/mongo_volume/db</em></p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-Replicasetrecoverynotes">Replica set recovery notes</h3>
<p>There are periodically heartbeats between replica sets and mongos server, once a primary/secondary gets down, mongos will try to reconnect.</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_755250" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:00:13.308 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:00:13.311 [ReplicaSetMonitorWatcher] reconnect rs1-2 failed couldn't connect to server rs1-2</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:00:13.315 [Balancer] distributed lock </code><code class="bash string">'balancer/ip-10-244-81-61:27017:1389060087:1804289383'</code> <code class="bash plain">unlocked.</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:00:15.156 [WriteBackListener-rs1-2] WriteBackListener exception : socket exception [CONNECT_ERROR] </code><code class="bash keyword">for</code> <code class="bash plain">rs1-2</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">...</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:00:28.341 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:00:28.344 [ReplicaSetMonitorWatcher] reconnect rs1-2 ok</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>There are heartbeats between each member within a replica set, once a primary gets down, a election will occur automatically and one of them will become primary, the old primary will join back as secondary once recover:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_975735" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:09:34.825 [rsHealthPoll] replset info rs1-0 heartbeat failed, retrying</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet info rs1-0 is down (or slow to respond):</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet member rs1-0 is now </code><code class="bash keyword">in</code> <code class="bash plain">state DOWN</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:09:35.746 [rsMgr] replSet info electSelf 1</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:09:36.378 [rsMgr] replSet PRIMARY</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>&nbsp;</p>
