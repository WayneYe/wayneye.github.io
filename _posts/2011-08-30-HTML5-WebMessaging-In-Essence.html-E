---
title: HTML5 WebMessaging In Essence
categories:
  - Hack
tags:
  - Hack
permalink: HTML5-WebMessaging-In-Essence
---

<p><a href="http://www.codeproject.com/KB/HTML/HTML5-WebMessaging/HTML5_Cross-Domain_WebMessaging_Demo.zip">Download HTML5_Cross-Domain_WebMessaging_Demo.zip - 2.97 KB</a></p>
<p>As a web developer, sometimes we are easy to encounter one problem:<strong> Cross-Domain communication</strong>, conforming <a title="Same-Origin-Policy" href="http://en.wikipedia.org/wiki/Same_origin_policy" target="_blank">Same-Origin-Policy</a>, JavaScript code cannot access code stay in different <strong>domain</strong>(or sub-domain) or&nbsp;<strong>protocol </strong>(HTTP/HTTPs) or&nbsp;<strong>port</strong>, so there was no direct (or I can say: simple) way to achieve Cross-Domain Communication. However, those kinds of requirements does happen: page A and page B are in different domain, &nbsp;B is "embedded" in A, i.e., there is an "iframe" in page A whose "src" is page B's URL, now page A wants to control page B and vise-versa.&nbsp;</p>
<p>By limiting the solution to be done by 100% client JavaScript, beforehand HTML5, there are a number of tricky "hacks", such as:</p>
<ol>
<li>URL long polling: container page A changes the iframe page B's URL hash, and B periodically checks the hash, once the hash changed, it takes action according to the contracted hash value. [BTW, the pattern can be revised to be non-polling by HTML5 <a title="onhashchange event" href="http://www.w3.org/TR/html5/history.html#event-hashchange" target="_blank">onchashchange event</a>]</li>
<li><a title="CrossFrame" href="http://www.julienlecomte.net/blog/2007/11/31/" target="_blank">CrossFrame</a>, a Safe Communication Mechanism Across Documents and Across Domains.</li>
<li>Window Size Monitoring: update the iframe's window size once, and the containning window subscribes its "onresize" event then takes corresponding action(s). <a title="Google Mapplets" href="http://code.google.com/apis/maps/documentation/mapplets/basics.html" target="_blank">Google Mapplets</a> adopted this pattern.</li>
</ol>
<p>Well, personally I really don't like all of them... either inelegant, or violates the original functionalities of DOM elements, or too complecated. I believe many people don't like them too even the pattern inventors I bet... That why WHATWG created Cross-Domain communication in HTML5: <strong><a href="http://www.w3.org/TR/webmessaging" target="_blank">Web Messaging</a></strong>.</p>
<p>As an HTML5 crazy advocator I like it very much, complete client communication, no server impact, efficient, secure (at least in theory).</p>
<h3>How to</h3>
<p>"Child" can be an iframe or an popup window by invocking window.open, "parent page" A contains source code is like below:</p>
<pre class="source" style="font-family: Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #e3ceab;">&lt;iframe</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"ifr"</span> <span style="color: #efef8f;">src=</span><span style="color: #cc9393;">"http://domainB.com/B.htm" onload="sendCommand();"</span><span style="color: #e3ceab;">&gt;</span><br /> &nbsp; No frame!<br /> <span style="color: #e3ceab;">&lt;/iframe&gt;</span><br /> <br /> <span style="color: #e3ceab;">&lt;script </span><span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"text/javascript"</span><span style="color: #e3ceab;">&gt;</span> &nbsp; <br /> &nbsp; <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">sendCommand</span>() <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">ifr</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"ifr"</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">ifr</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">contentWindow</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #cc9393;">"Hello"</span><span style="color: #dcdccc;">,</span> <span style="color: #cc9393;">"http://domainB.com"</span>);<br /> &nbsp; <span style="color: #dcdccc;">}</span><br /> <span style="color: #e3ceab;">&lt;/script&gt;</span></pre>
<blockquote>
<p>Notice, make sure post message <strong>only when the iframe is loaded</strong>, otherwise the contentWindow will be still in same domain with the container page.</p>
</blockquote>
<p>Child page B contains code like below:</p>
<pre class="source" style="font-family: Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"button"</span> <span style="color: #efef8f;">value=</span><span style="color: #cc9393;">"Cross domain call"</span> <span style="color: #efef8f;">onclick=</span><span style="color: #cc9393;">"sendMsg();"</span> <span style="color: #e3ceab;">/&gt;</span><br /> <br /> <span style="color: #e3ceab;">&lt;script&gt;</span><br /> <span style="color: #f0dfaf; font-weight: bold;">window</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">addEventListener</span>(<span style="color: #cc9393;">"message"</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">receiveMessage</span><span style="color: #dcdccc;">,</span> <span style="color: #e3ceab;">false</span>);<br /> <br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">receiveMessage</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">"Page B received message from origin: %s."</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">origin</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">"Event data: %s"</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">//evt.source will be a window who sent the message, it can be used to post message to it</span><br /> &nbsp;&nbsp;&nbsp; <br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// Take action(s)</span><br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #e3ceab;">&lt;/script&gt;</span></pre>
<p>The demo code above is one direction: parent sends message to child (iframe), actually bi-directional message trasfer can also be done, similar with "Parent control child", child page posts message to container window, only different is call "<code>parent.postMessage</code>".</p>
<pre class="source" style="font-family: '[object HTMLOptionElement]', Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">receiveMessage</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">source</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postmessage</span>(<span style="color: #cc9393;">"Hello caller"</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// or parent.postmessage("Hello parent");</span><br /> <span style="color: #dcdccc;">}</span></pre>
<h3>Web Messaging Essential</h3>
<p>In a nutshell, HTML5 Web Messaging is a suite of JavaScript API exposed by web browser, to communicate between different&nbsp;<a title="Browsing context" href="http://www.w3.org/TR/html5/browsers.html#browsing-context" target="_blank">browsing context</a>, when JavaScript code in one browser tab/window trys to deliver a message to another tab/window, web browser locates the target tab/window under the specified domain, and file a <a href="http://www.w3.org/TR/webmessaging/#messageevent" target="_blank">MessageEvent</a>&nbsp;(which inherits from DOMEvent) to the target tab/window, so if the target tab/window already subscribed the message event, it will gets notified, eventually the message got delivered through <code>MessageEvent.data</code>.</p>
<h3>Live Demo</h3>
<p>I've done a demo in my dev machine, I override my local hosts file to let &nbsp;Container.com, DomainA.com, DomainB.com and DomainC.com all point to 127.0.0.1:</p>
<blockquote><strong>127.0.1.1 Container.com<br />127.0.0.1 DomainA.com</strong><br /><strong>127.0.0.1 DomainB.com</strong><br /><strong>127.0.0.1 DomainC.com</strong></blockquote>
<p>I prepared a Container page which contains code below:</p>
<pre class="source" style="font-family: '[object HTMLOptionElement]', Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #e3ceab;">&lt;h3&gt;</span>HTML5 Cross-Domain post message demo<span style="color: #e3ceab;">&lt;/h3&gt;</span><br /> <span style="color: #e3ceab;">&lt;p</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"infoBar"</span><span style="color: #e3ceab;">&gt;&lt;/p&gt;</span><br /> <span style="color: #e3ceab;">&lt;div</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"wrapperA"</span><span style="color: #e3ceab;">&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"text"</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"txtA"</span> <span style="color: #e3ceab;">/&gt;&lt;br</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"button"</span> <span style="color: #efef8f;">value=</span><span style="color: #cc9393;">"Post Message"</span> <span style="color: #efef8f;">onclick=</span><span style="color: #cc9393;">"postMsgToIfr('A');"</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;br</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;iframe</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"ifrA"</span> <span style="color: #efef8f;">src=</span><span style="color: #cc9393;">"http://DomainA.com/A.htm"</span><span style="color: #e3ceab;">&gt;&lt;/iframe&gt;</span><br /> <span style="color: #e3ceab;">&lt;/div&gt;</span><br /> <span style="color: #e3ceab;">&lt;div</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"wrapperB"</span><span style="color: #e3ceab;">&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"text"</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"txtB"</span> <span style="color: #e3ceab;">/&gt;&lt;br</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"button"</span> <span style="color: #efef8f;">value=</span><span style="color: #cc9393;">"Post Message"</span> <span style="color: #efef8f;">onclick=</span><span style="color: #cc9393;">"postMsgToIfr('B');"</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;br</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;iframe</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"ifrB"</span> <span style="color: #efef8f;">src=</span><span style="color: #cc9393;">"http://DomainB.com/B.htm"</span><span style="color: #e3ceab;">&gt;&lt;/iframe&gt;</span><br /> <span style="color: #e3ceab;">&lt;/div&gt;</span><br /> <span style="color: #e3ceab;">&lt;div</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"wrapperC"</span><span style="color: #e3ceab;">&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"text"</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"txtC"</span> <span style="color: #e3ceab;">/&gt;&lt;br</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"button"</span> <span style="color: #efef8f;">value=</span><span style="color: #cc9393;">"Post Message"</span> <span style="color: #efef8f;">onclick=</span><span style="color: #cc9393;">"postMsgToIfr('C');"</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;br</span> <span style="color: #e3ceab;">/&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">&lt;iframe</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"ifrC"</span> <span style="color: #efef8f;">src=</span><span style="color: #cc9393;">"http://DomainC.com/C.htm"</span><span style="color: #e3ceab;">&gt;&lt;/iframe&gt;</span><br /> <span style="color: #e3ceab;">&lt;/div&gt;</span><br /> <span style="color: #e3ceab;">&lt;div</span> <span style="color: #efef8f;">style=</span><span style="color: #cc9393;">"clear: both"</span><span style="color: #e3ceab;">&gt;</span><br /> <span style="color: #e3ceab;">&lt;/div&gt;</span><br /> <span style="color: #e3ceab;">&lt;script </span><span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"text/javascript"</span><span style="color: #e3ceab;">&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #f0dfaf; font-weight: bold;">window</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">addEventListener</span>(<span style="color: #cc9393;">"message"</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">receiveMessage</span><span style="color: #dcdccc;">,</span> <span style="color: #e3ceab;">false</span>);<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">infoBar</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"infoBar"</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">receiveMessage</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">infoBar</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">innerHTML</span> <span style="color: #dcdccc;">+=</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">origin</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">": "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">"&lt;br /&gt;"</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">postMsgToIfr</span>(<span style="color: #dcdccc;">domain</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">switch</span> (<span style="color: #dcdccc;">domain</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">case</span> <span style="color: #cc9393;">"A"</span><span style="color: #dcdccc;">:</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">ifr</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"ifrA"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">ifr</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">contentWindow</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"txtA"</span><span style="color: #dcdccc;">).</span><span style="color: #dcdccc;">value</span><span style="color: #dcdccc;">,</span> <span style="color: #cc9393;">"http://DomainA.com"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">break</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">case</span> <span style="color: #cc9393;">"B"</span><span style="color: #dcdccc;">:</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">ifr</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"ifrB"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">ifr</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">contentWindow</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"txtB"</span><span style="color: #dcdccc;">).</span><span style="color: #dcdccc;">value</span><span style="color: #dcdccc;">,</span> <span style="color: #cc9393;">"http://DomainB.com"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">break</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">case</span> <span style="color: #cc9393;">"C"</span><span style="color: #dcdccc;">:</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">ifr</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"ifrC"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">ifr</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">contentWindow</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"txtC"</span><span style="color: #dcdccc;">).</span><span style="color: #dcdccc;">value</span><span style="color: #dcdccc;">,</span> <span style="color: #cc9393;">"http://DomainC.com"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">break</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">default</span><span style="color: #dcdccc;">:</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">throw</span> <span style="color: #e3ceab;">new</span> <span style="color: #dcdccc;">error</span>(<span style="color: #cc9393;">"No such domain!"</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /> <span style="color: #e3ceab;">&lt;/script&gt;</span></pre>
<p>And three pages: A.htm located in DomainA.com,&nbsp;B.htm located in DomainB.com,&nbsp;C.htm located in DomainC.com, phisically they all located under C:\inetpub\wwwrooot, while in the browser I manually type DomainA/B/C.com to make the cheat<img style="background-image: url('http://wayneye.com/Images/winLiveEmotions.gif'); background-position: -0px -0px; width: 19px; height: 19px;" src="http://wayneye.com/Images/invis.gif" alt="Smile" />, the code in the A/B/C page are similar, showing below:</p>
<pre class="source" style="font-family: '[object HTMLOptionElement]', Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #e3ceab;">&lt;h4&gt;</span>DomainA/A.htm1<span style="color: #e3ceab;">&lt;/h4&gt;</span><br /> <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"button"</span> <span style="color: #efef8f;">value=</span><span style="color: #cc9393;">"Cross domain call"</span> <span style="color: #efef8f;">onclick=</span><span style="color: #cc9393;">"doClick();"</span> <span style="color: #e3ceab;">/&gt;</span><br /> <span style="color: #e3ceab;">&lt;div</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"d"</span><span style="color: #e3ceab;">&gt;</span><br /> <span style="color: #e3ceab;">&lt;/div&gt;</span><br /> <span style="color: #e3ceab;">&lt;script&gt;</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #f0dfaf; font-weight: bold;">window</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">addEventListener</span>(<span style="color: #cc9393;">"message"</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">receiveMessage</span><span style="color: #dcdccc;">,</span> <span style="color: #e3ceab;">false</span>);<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">doClick</span>() <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">parent</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #cc9393;">"Message sent from "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">location</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">host</span><span style="color: #dcdccc;">,</span> <span style="color: #cc9393;">"http://container.com"</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">d</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"d"</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">receiveMessage</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">d</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">innerHTML</span> <span style="color: #dcdccc;">+=</span> <span style="color: #cc9393;">"Received message \"&lt;span style=\"color:red\"&gt;"</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">"&lt;/span&gt;\" from domain: "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">origin</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">"&lt;br /&gt;"</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> <span style="color: #e3ceab;">&lt;/script&gt;</span></pre>
<p>I recorded a gif image below to demonstrate the Cross-Domain messaging:</p>
<p><img title="HTML5 Cross-Domain Messaging Demo" src="http://ww2.sinaimg.cn/large/76a6d6a2gw1dkq13gnv6ig.gif" alt="HTML5 Cross-Domain Messaging Demo" width="567" height="382" /></p>
<p>See the message passed through different domain in bi-direction? Isn't it cool?</p>
<h3>MessageChannel</h3>
<p>To support independent communication under different <a title="Browsing context" href="http://www.w3.org/TR/html5/browsers.html#browsing-context" target="_blank">browsing context</a>, HTML5 introduced&nbsp;<strong><a title="Message Channel" href="http://www.w3.org/TR/html5/comms.html#message-channels">Message Channel</a></strong>&nbsp;to post message independently, its official definition is showing below:</p>
<blockquote>
<p>Communication channels in this mechanisms are implemented as two-ways pipes, with a port at each end. Messages sent in one port are delivered at the other port, and vice-versa. Messages are asynchronous, and delivered as DOM events.&nbsp;</p>
</blockquote>
<p>I spent about half a day in investigating the Message Channel and finally got it worked, my code is showing below:</p>
<h4>Container page source code</h4>
<pre class="source" style="font-family: '[object HTMLOptionElement]', Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #e3ceab;">&lt;iframe</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"ifr"</span> <span style="color: #efef8f;">src=</span><span style="color: #cc9393;">"http://wayneye.me/WebProjects/HRMS/Opener.html"</span> <span style="color: #efef8f;">onload=</span><span style="color: #cc9393;">"initMessaging()"</span><span style="color: #e3ceab;">&gt;&lt;/iframe&gt;</span><br /> <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"button"</span> <span style="color: #efef8f;">value=</span><span style="color: #cc9393;">"Post Message"</span> <span style="color: #efef8f;">onclick=</span><span style="color: #cc9393;">"postMsg();"</span> <span style="color: #e3ceab;">/&gt;</span><br /> <span style="color: #e3ceab;">&lt;div</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"d"</span><span style="color: #e3ceab;">&gt;&lt;/div&gt;</span><br /> <span style="color: #e3ceab;">&lt;script&gt;</span><br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">d</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"d"</span>);<br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">channel</span> <span style="color: #dcdccc;">=</span> <span style="color: #e3ceab;">new</span> <span style="color: #dcdccc;">MessageChannel</span>();<br /> <span style="color: #dcdccc;">channel</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">port1</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onmessage</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">d</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">innerHTML</span> <span style="color: #dcdccc;">+=</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">origin</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">": "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">"&lt;br /&gt;"</span>;<br /> <span style="color: #dcdccc;">};</span><br /> <br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">initMessaging</span>() <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">child</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"ifr"</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">child</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">contentWindow</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #cc9393;">'hello'</span><span style="color: #dcdccc;">,</span> <span style="color: #cc9393;">'http://wayneye.me'</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">[</span><span style="color: #dcdccc;">channel</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">port2</span><span style="color: #dcdccc;">]);</span><br /> <span style="color: #dcdccc;">}</span><br /> <br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">postMsg</span>() <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">channel</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">port1</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #cc9393;">'Message sent from '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">location</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">host</span>);<br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #e3ceab;">&lt;/script&gt;</span></pre>
<h4>iframe page source code</h4>
<pre class="source" style="font-family: '[object HTMLOptionElement]', Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #e3ceab;">&lt;div</span> <span style="color: #efef8f;">id=</span><span style="color: #cc9393;">"info"</span><span style="color: #e3ceab;">&gt;&lt;/div&gt;</span><br /> <span style="color: #e3ceab;">&lt;input</span> <span style="color: #efef8f;">type=</span><span style="color: #cc9393;">"button"</span> <span style="color: #efef8f;">value=</span><span style="color: #cc9393;">"Post Message"</span> <span style="color: #efef8f;">onclick=</span><span style="color: #cc9393;">"postMsg();"</span> <span style="color: #e3ceab;">/&gt;</span><br /> <span style="color: #e3ceab;">&lt;script&gt;</span><br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">info</span> <span style="color: #dcdccc;">=</span> <span style="color: #f0dfaf; font-weight: bold;">document</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">getElementById</span>(<span style="color: #cc9393;">"info"</span>);<br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">port</span> <span style="color: #dcdccc;">=</span> <span style="color: #e3ceab;">null</span>;<br /> <span style="color: #f0dfaf; font-weight: bold;">window</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">addEventListener</span>(<span style="color: #cc9393;">"message"</span><span style="color: #dcdccc;">,</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">e</span>) <span style="color: #dcdccc;">{</span><br /> <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #dcdccc;">e</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">if</span>(<span style="color: #dcdccc;">e</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ports</span> <span style="color: #dcdccc;">&amp;&amp;</span> <span style="color: #dcdccc;">e</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ports</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">length</span> <span style="color: #dcdccc;">&gt;</span> <span style="color: #8cd0d3;">0</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">port</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">e</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ports</span><span style="color: #dcdccc;">[</span><span style="color: #8cd0d3;">0</span><span style="color: #dcdccc;">];</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">port</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">start</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">port</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">addEventListener</span>(<span style="color: #cc9393;">"message"</span><span style="color: #dcdccc;">,</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">info</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">innerHTML</span> <span style="color: #dcdccc;">+=</span> <span style="color: #cc9393;">"Received message \""</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">"\" from domain: "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">origin</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">"&lt;br /&gt;"</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">},</span> <span style="color: #e3ceab;">false</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> <span style="color: #dcdccc;">},</span> <span style="color: #e3ceab;">false</span>);<br /> <br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">postMsg</span>() <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">if</span>(<span style="color: #dcdccc;">port</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">port</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">postMessage</span>(<span style="color: #cc9393;">"Data sent from "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">location</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">host</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #e3ceab;">&lt;/script&gt;</span></pre>
<p>The entire process can be described as:</p>
<ol>
<li>Container page (A) embedded an iframe whose src is pointing to a page (B) in different domain.</li>
<li>Once the iframe loaded, the container posts a message to page B with a <a title="MessagePortArray" href="http://www.w3.org/TR/webmessaging/#messageportarray" target="_blank">MessagePortArray</a>. &nbsp;</li>
<li>Page B received the message as well as the array containing a list of MessagePort objects.</li>
<li>Page B registers onmessage event on port instance.</li>
<li>Page B invokes <code>port.postmessage</code> to send a message to page A through this MessageChannel.&nbsp;</li>
</ol>
<blockquote>At this timestamp, I seems only Opera correctly supports MessageChannel, Google Chrome and IE10 Platform Preview 2 failed to deliver the ports array, Safari cannot gets the onmessage event fired. Firefox 7.0 beta event doesn't support MessageChannel object.</blockquote>
<blockquote>Note: Ports can also enable communication between HTML5 Web Workers.</blockquote>
<p>One more thing (plagiarize Steve Jobs<img style="background-image: url('http://wayneye.com/Images/winLiveEmotions.gif'); background-position: -0px -0px; width: 19px; height: 19px;" src="http://wayneye.com/Images/invis.gif" alt="Smile" />), to use Message Channel one noticable point is, web developer should explicitly close the channel once there is no need, otherwise there will be a strong reference between two pages, as W3 official page emphasized below:</p>
<blockquote>
<p>Authors are strongly encouraged to explicitly close&nbsp;<code>MessagePort</code>&nbsp;objects to disentangle them, so that their resources can be recollected. Creating many&nbsp;<code>MessagePort</code>&nbsp;objects and discarding them without closing them can lead to high memory usage.</p>
</blockquote>
<h3>Further reading</h3>
<p><a href="http://www.w3.org/TR/webmessaging" target="_blank">HTML5 Web Messaging</a></p>
<p><a href="https://developer.mozilla.org/en/DOM/window.postMessage" target="_blank">window.postMessage - MDN Docs</a></p>
<p><a href="http://html5demos.com/postmessage2" target="_blank">HTML5 Demo: postMessage (cross domain)</a></p>
<p><a href="http://davidwalsh.name/window-postmessage" target="_blank">HTML5&prime;s window.postMessage AP</a></p>
<p><a href="http://msdn.microsoft.com/en-us/ie/hh272905" target="_blank">Internet Explorer 10 Platform Preview: HTML5</a></p>
<p><a href="http://ithelp.ithome.com.tw/question/10057709" target="_blank">http://ithelp.ithome.com.tw/question/10057709</a></p>
<p>&nbsp;</p>
<p>Also posted on CodeProject:&nbsp;<a href="http://www.codeproject.com/KB/HTML/HTML5-WebMessaging.aspx">http://www.codeproject.com/KB/HTML/HTML5-WebMessaging.aspx</a></p>
