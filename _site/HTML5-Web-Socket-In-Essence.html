<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>HTML5 Web Socket in Essence - Wayneâ€™s Geek Life</title>
<meta name="description" content="HTML5 WebSocket defines a bi-directional, full-duplex communication channel operates through a single TCP connection, this article discusses its fantastic performance, the WebSocket protocol principle and its handshake mechanism, and develop a WebSocket application in action (Team Poker).&lt;/embed&gt;Embeded youku video link because Youtube is outside of the largest &quot;intranet&quot; in the entire universe!!Table of ContentIntroductionBackgroundWebSocket In EssenceExperimental DemosBrowser SupportWebSocket JavaScript APIDevelop WebSocket In Action - Team PokerOpen IssuesConclusionReferences &amp; Resources&nbsp;IntroductionHTML5 WebSocket&nbsp;defines a bi-directional, full-duplex communication channel that operates through a single TCP socket over the Web, it provides efficient, low-latency and low cost connection between web client and server, based on WebSocket, developers can build&nbsp;scalable,&nbsp;real-time&nbsp;web applications in the future. Section below is the official definition of WebSocket copied from&nbsp;IETF WebSocket protocol&nbsp;page:&nbsp;The WebSocket protocol enables two-way communication between a user agent running untrusted code running in a controlled environment to a remote host that has opted-in to communications from that code. &nbsp;The security model used for this is the Origin-based security model commonly used by Web browsers. &nbsp;The protocol consists of an initial handshake followed by basic message framing, layered over TCP. &nbsp;The goal of this technology is to provide a mechanism for browser-based applications that need two-way communication with servers that does not rely on opening multiple HTTP connections (e.g. using XMLHttpRequest or &lt;iframe&gt;s and long polling).This article is trying to go through WebSocket basic concept, the problems it is going to solve, explain it in essence,&nbsp;watch some experimental Demos, develop a simple WebSocket&nbsp;application in action (Team Poker), and describe current open issues of WebSocket. I sincerely hope it will be&nbsp;systematically,&nbsp;easy to understand,&nbsp;from surface to deep&nbsp;so that eventually readers would not only learn what WebSocket is from high level but also&nbsp;understand it in depth!&nbsp;Any thoughts, suggestions or criticism&nbsp;you may have after reading this article will help me to improve in the future, i would appreciate it if you could leave a comment.BackgroundIn traditional web applications, in order to achieve some real-time interaction with server, developers had to employ several tricky ways such as Ajax polling,&nbsp;Comet&nbsp;(A.K.A Ajax push,&nbsp;Full Duplex Ajax,&nbsp;HTTP Streaming, etc.),&nbsp;those technologies either periodically fire HTTP requests to server or hold the HTTP connection with server for a long time, which&nbsp;&quot;contain lots of additional, unnecessary header data and introduce latency&quot; and resulted in &quot;an outrageously high price tag&quot;.&nbsp;websocket.org explained the problems exhaustively, compared the performance&nbsp;of Ajax polling and WebSocket in detail, built up two simple web pages, one periodically communicated with server using traditional HTTP and the other used HTML5 WebSocket, in the testing each HTTP&nbsp;request/response header is approximate 871 byte, while data length of WebSocket connection is much shorter: 2 bytes after connection established, as the transfer count getting larger, the result will be:Traditional HTTP Request&nbsp;Use case A: 1,000 clients polling every second: Network throughput is (871 x 1,000) = 871,000 bytes = 6,968,000 bits per second (6.6 Mbps)Use case B: 10,000 clients polling every second: Network throughput is (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits per second (66 Mbps)Use case C: 100,000 clients polling every 1 second: Network throughput is (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits per second (665 Mbps)HTML5 WebSocketUse case A: 1,000 clients receive 1 message per second: Network throughput is (2 x 1,000) = 2,000 bytes = 16,000 bits per second (0.015 Mbps)Use case B: 10,000 clients receive 1 message per second: Network throughput is (2 x 10,000) = 20,000 bytes = 160,000 bits per second (0.153 Kbps)Use case C: 100,000 clients receive 1 message per second: Network throughput is (2 x 100,000) = 200,000 bytes = 1,600,000 bits per second (1.526 Kbps)Finally a more readable diagram:&nbsp;&quot;HTML5 Web Sockets can provide a 500:1 or &mdash; depending on the size of the HTTP headers &mdash; even a 1000:1 reduction in unnecessary HTTP header traffic and 3:1 reduction in latency&quot;. &nbsp;--WebSocket.orgWebSocket In EssenceThe motivation of creating WebSocket is to replace polling and long polling(Comet), and endow HTML5 web application the ability of real-time communication. Browser based web application can fire WebSocket connection request through JavaScript API, and then transfer data with server over only one TCP connection.This is achieved by the new protocol - The WebSocket Protocol, which is essentially an&nbsp;independent TCP-based protocol.&nbsp;To establish a WebSocket connection client/browser forms an HTTP request with &quot;Upgrade: WebSocket&quot; header which indicates a protocol upgrade request, and the handshake key(s) will be interpreted by HTTP servers and handshake response will be returned (the detailed handshake mechanism will be described below), afterwards the connection is established (figuratively speaking, the &#39;sockets&#39; have been plugged in at both client and server ends),&nbsp;both sides can&nbsp;transfer/receive data&nbsp;independently, no more redundant header information, and the connection&nbsp;won&#39;t be closed until one side sends close signal, that&#39;s why WebSocket is bidirectional and full duplex, in additional, comparing the request/response paradigm of HTTP, WebSocket layers a framing mechanism on top on TCP, each data frame is minimally just 2 bytes.  Now it is time for us to delve deep into this protocol, let&#39;s start with WebSocket version draft-hixie-thewebsocketprotocol-76 which is now supported by browsers (Chrome 6+, Firefox 4+, Opera 11) and many WebSocket servers (please refer to&nbsp;Browser/Server Support&nbsp;section below for details). A typical WebSocket request/response example is shown below:Request GET /demo HTTP/1.1Upgrade: WebSocketConnection: UpgradeHost: example.comOrigin: http://example.comSec-WebSocket-Key1: 4 @1 46546xW%0l 1 5Sec-WebSocket-Key2: 12998 5 Y3 1 .P00 ^n:ds[4U&nbsp;  Response HTTP/1.1 101 WebSocket Protocol HandshakeUpgrade: WebSocketConnection: UpgradeSec-WebSocket-Origin: http://example.comSec-WebSocket-Location: ws://example.com/demoSec-WebSocket-Protocol: sample 8jKS&#39;y:G*Co,Wxa-&nbsp;The entire process could be described as: the client raise a &quot;special&quot; HTTP request which request &quot;Upgrade&quot; connecting protocol to &quot;WebSocket&quot;, on domain &quot;example.com&quot; with path &quot;/demo&quot;, with three &quot;handshake&quot; fields:&nbsp;Sec-WebSocket-Key1, Sec-WebSocket-Key2 and&nbsp;8 bytes ({^n:ds[4U}) after the fields are random tokens which the WebSocket server uses to construct a 16-byte security hash&nbsp;at the end of its handshake to prove that it has read the client&#39;s handshake.Since WebSocket protocol is NOT finalized and is being improved and standardized by&nbsp;IETF Hypertext Bidirectional (HyBi) Working Group,&nbsp;at the time I wrote this article, the latest WebSocket version is &quot;draft-ietf-hybi-thewebsocketprotocol-08&quot; lasted updated by Ian Fette&nbsp;on June 7, 2011, in which both request/response headers are changed comparing to version 76, the handshake mechanism was changed as well, Sec-WebSocket-Key1 and&nbsp;Sec-WebSocket-Key1 are replaced with one&nbsp;Sec-WebSocket-Key.WebSocket request/response in the latest&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:RequestGET /demo HTTP/1.1Host: example.comUpgrade: websocketConnection: UpgradeSec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Origin: http://example.comSec-WebSocket-Protocol: chat, superchatSec-WebSocket-Version: 8ResponseHTTP/1.1 101 Switching ProtocolsUpgrade: websocketConnection: UpgradeSec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Sec-WebSocket-Protocol: chatThe Sec-WebSocket-Key is a base64 encoded randomly generated 16-byte value, in the case above it is &quot;WebSocket rocks!&quot;, the server reads the key, concats with a magic GUID &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, to &quot;V2ViU29ja2V0IHJvY2tzIQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, then compute its SHA1 hash, get result &quot;540b8681a34307fade550a467c317c297799c79a&quot;, finally based64 encodes the hash and append the value to header &quot;Sec-WebSocket-Accept&quot;.I&#39;ve written C# code below to demonstrate how to compute the Sec-WebSocket-Accept conforming to&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:&nbsp; /// &lt;summary&gt; /// Computes server security hash for HTML5 WebSocket, handshake mechanism  /// based on draft-ietf-hybi-thewebsocketprotocol-08 /// http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08#page-27 /// &lt;/summary&gt; /// &lt;param name=&quot;secWebSocketKey&quot;&gt;The handshake key &quot;Sec-WebSocket-Key&quot; from client.&lt;/param&gt; /// &lt;returns&gt;The computed security hash to fill &quot;Sec-WebSocket-Accept&quot; header.&lt;/returns&gt; public static String ComputeWebSocketHandshakeSecurityHash08(String secWebSocketKey) { &nbsp;&nbsp;&nbsp; const String MagicKEY = &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;; &nbsp;&nbsp;&nbsp; String secWebSocketAccept = String.Empty;  &nbsp;&nbsp;&nbsp; // 1. Combine the request Sec-WebSocket-Key with magic key. &nbsp;&nbsp;&nbsp; String ret = secWebSocketKey + MagicKEY;  &nbsp;&nbsp;&nbsp; // 2. Compute the SHA1 hash &nbsp;&nbsp;&nbsp; SHA1 sha = new SHA1CryptoServiceProvider();  &nbsp;&nbsp;&nbsp; byte[] sha1Hash = sha.ComputeHash(Encoding.UTF8.GetBytes(ret));  &nbsp;&nbsp;&nbsp; // 3. Base64 encode the hash &nbsp;&nbsp;&nbsp; secWebSocketAccept = Convert.ToBase64String(sha1Hash);  &nbsp;&nbsp;&nbsp; return secWebSocketAccept; }Unit test code: String secWebSocketKey = Convert.ToBase64String(Encoding.UTF8.GetBytes(&quot;WebSocket rocks!&quot;)); Console.WriteLine(&quot;Sec-WebSocket-Key: {0}&quot;, secWebSocketKey);  String secWebSocketAccept = ComputeWebSocketHandshakeSecurityHash08(secWebSocketKey); Console.WriteLine(&quot;Sec-WebSocket-Accept: &quot; + secWebSocketAccept);We would see the result by running code above:Sec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Please note draft-ietf-hybi-thewebsocketprotocol-08 is NOT supported by any common web browsers since it was just published on June 7, 2011. However, we can learn it so that we know what is happening now with WebSocket and where it&#39;s going in the future.Experimental DemosSo far there are already many experimental WebSocket Demos built based on either draft-hixie-thewebsocketprotocol-75&nbsp;or&nbsp;draft-hixie-thewebsocketprotocol-76.http://rumpetroll.com/&nbsp;Play a tadpole in canvas and can chat with other tadpoles, tadpoles location and char messages could be seen by everyone in real-time. http://html5labs.interoperabilitybridges.com/prototypes/websockets/websockets/info&nbsp;WebSocket Demos in Microsoft HTML5 Labs http://html5demos.com/web-socketA very simple &quot;Chat room&quot; demo using WebSocket.  http://kaazing.me/Refresh stock, weather, news and twits in real-time powered by Kaazing&#39;s real-time message delivery network solution. Mr. Doob&#39;s Multiuser SketchpadIn this multi-user&nbsp;&lt;canvas&gt;&nbsp;drawing application, Web Sockets are used to pass along the coordinates of the lines that other users draw back to each client as they happen.And so on.. You will also see a simple demo developed by me below.Browser/Server SupportWebSocket is not only designed for browser/server communication, client application can also use it. However, I guess browser will still be the major platform for WebSocket protocol taken into account the emerging handsets and the coming cloud. At the time I wrote this article, WebSocket protocol version draft-ietf-hybi-thewebsocketprotocol-76 was supported by Safari 5+/Google chrome 6+ (link), Mozilla Firefox 4+ (disabled by default&nbsp;link) and Opera 11 (disabled by default&nbsp;link), IE 9/10 does not support... but on not supported browsers we can use Flash shim/fallback by adopting&nbsp;web-socket-js.The awesome&nbsp;Can I uses it&nbsp;is&nbsp;maintaining HTML5 new features&nbsp;support&nbsp;in all popular browsers, screenshot below shows WebSocket support:There are also a number of WebSocket servers available:http://socket.io&nbsp; - Provides seamless support for a variety of transports (WebSocket, WebSocket over Flash, XHR polling, JSONP polling, etc.) intended for real-time communication developed by&nbsp;Guillermo Rauch&nbsp;node.ws.js&nbsp;- A simple WebSocket server (support both&nbsp;draft-hixie-thewebsocketprotocol-75 and draft-hixie-thewebsocketprotocol-76) developed based on node.websocket.js.web-socket-js&nbsp;- HTML5 Web Socket implementation powered by Flashhttp://nugget.codeplex.com&nbsp;- A web socket server implemented in C#.jWebSocket.org&nbsp;- The Open Source Java WebSocket Serverphpwebsocket - PHP version of WebSocket server.WebSocket JavaScript APIW3C defined&nbsp;WebSocket interface&nbsp;as below: [Constructor(in DOMString url, in optional DOMString protocols)] [Constructor(in DOMString url, in optional DOMString[] protocols)] interface WebSocket { &nbsp; readonly attribute DOMString url;  &nbsp; // ready state &nbsp; const unsigned short CONNECTING = 0; &nbsp; const unsigned short OPEN = 1; &nbsp; const unsigned short CLOSING = 2; &nbsp; const unsigned short CLOSED = 3; &nbsp; readonly attribute unsigned short readyState; &nbsp; readonly attribute unsigned long bufferedAmount;  &nbsp; // networking &nbsp;&nbsp;attribute Function onopen; &nbsp;&nbsp;attribute Function onmessage; &nbsp;&nbsp;attribute Function onerror; &nbsp;&nbsp;attribute Function onclose; &nbsp; readonly attribute DOMString protocol; &nbsp; void send(in DOMString data); &nbsp; void close(); }; WebSocket implements EventTarget;The url attribute is the WebSocket server Url, the protocol is usually &quot;ws&quot; (for unencrypted plain text WebSocket) or &quot;wss&quot; (for secure WebSocket), send method sends data to server after connected, close is to send close signal, besides there are four important events: onopen, onmessage, onerror and onclose, I borrowed a nice picture below from nettuts.onopen: When a socket has opened, i.e. after TCP three-way handshake and WebSocket handshake.onmessage: When a message has been received from WebSocket server.onerror: Triggered when error occurred.onclose: When a socket has been closed.JavaScript code below is to setup WebSocket connection and retrieve data: var wsUrl = &#39;ws://localhost:8888/DummyPath&#39;; var websocket = new WebSocket(wsUrl); websocket.onopen = function (evt) { onOpen(evt) }; websocket.onclose = function (evt) { onClose(evt) }; websocket.onmessage = function (evt) { onMessage(evt) }; websocket.onerror = function (evt) { onError(evt) };  &nbsp;&nbsp;&nbsp;  function onOpen(evt) { &nbsp;&nbsp;&nbsp; console.log(&quot;Connected to WebSocket server.&quot;); &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; websocket.send(&quot;HTML5 WebSocket rocks!&quot;); } function onClose(evt) { console.log(&quot;Disconnected&quot;); } function onMessage(evt) { &nbsp;&nbsp;&nbsp; console.log(&#39;Retrieved data from server: &#39; + evt.data);  &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; // Update UI... } function onError(evt) { console.log(&#39;Error occured: &#39; + evt.data); }Develop WebSocket In Action - Team Poker Demo&nbsp;Estimating user story effort by using&nbsp;Planning Poker Cards&nbsp;is well-known and widely used in Agile/Scrum development, Program Manager/Scrum Master prepare user stories beforehand, hold meeting with stake holders and have them play poker to represent one&#39;s estimation on each story, the higher the card value is, the harder to implement, on the contrary, the lower the value is, the easier to implement, &quot;0&quot; indicates &quot;no effort&quot; or &quot;has been done&quot;, &quot;?&quot; indicates &quot;mission impossible&quot; or &quot;unclear requirement&quot;.Actually there is a website - http://pokerplanning.com&nbsp;does the exact work described above, my co-workers and I used it for several times, however, we found it is getting slower and slower as more team members joining the game or after several rounds of voting, we did experience the worst result: no one can vote anymore because everyone&#39;s voting page got stucked.&nbsp;I strongly suspect the major reason for this is its Ajax Polling strategy in order to ensure everyone got real-time voting status. By tracking its network activities I guess I was right.Ajax polling in&nbsp;http://pokerplanning.com:I believe HTML5 WebSocket will solve the problem! So I developed a simple demo (I named it Team Poker) which currently only has limited and basic functionalities described as below:User can login to poker room after inputting his/her nickname.Everyone gets notified when one user players a poker.Everyone gets notified when new player joins.Newly joined player can see the current participants and voting status.The login screenshot for requirement #1:New participant(s), new voted poker(s) status update screenshot for requirement #2 and #3 (please click on the image to enlarge):Newly joined participant(s) can see current game status, story #4:Please note the Team Poker demo is concentrated on&nbsp;demonstrating the power of WebSocket, in real world, player shouldn&#39;t see the poker values played by other players, and there is functionalities like moderator customizing user stories, storing game status on server side, and there is no fancy UI/animation. However, I&#39;ve share all the source code at the beginning of this article, in additional, I&#39;ve uploaded the source code on github: https://github.com/WayneYe/TeamPoker,&nbsp;wish some people make it better and productive, will you fork it with me? Dear reader:).Ok, now coding time, since all clients need to get notified about other client&#39;s changes (new player joining or new poker played), in additional, new joint player needs to know current status, I defined two communication contracts:ClientMessage&nbsp;indicates message sent from client, contains&nbsp;a Type property reflects enumeration class MessageType - NewParticipaint, NewVoteInfo, and a Data property to store data.ServerStatus, stores current playing players as well as current voting status - a hashtable [{PlayerName}, {VoteValue}], broadcast to all clients once receiving new client message. var TeamPoker = TeamPoker || function () { };  TeamPoker.VoteInfo = function (playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } TeamPoker.MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; TeamPoker.ClientMessage = function (type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; TeamPoker.ServerStatus = function () { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus = []; };&nbsp;On client side,&nbsp;a WebSocket connection will be established after user clicking &quot;Login&quot; button, the nickname will be sent to WebSocket server running on nodejs, the kernal client code is shown below: TeamPoker.connectToWsServer = function () { &nbsp;&nbsp;&nbsp; // Init Web Socket connect &nbsp;&nbsp;&nbsp; var WSURI = &quot;ws://192.168.1.6:8888&quot;; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient = new WebSocket(WSURI);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onopen = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Successfully connected to WebSocket server.&#39;); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.joinGame(); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onclose = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Connection closed.&#39;); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onmessage = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Retrived msg from server: &#39; + evt.data); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.updateGameStatus(evt.data); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onerror = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;An error occured: &#39; + evt.data); &nbsp;&nbsp;&nbsp; }; };  TeamPoker.joinGame = function () { &nbsp;&nbsp;&nbsp; var joinGameMsg = new TeamPoker.ClientMessage(TeamPoker.MessageType.NewParticipaint, TeamPoker.CurrentPlayerName);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.send(JSON.stringify(joinGameMsg)); } TeamPoker.updateGameStatus = function (data) { &nbsp;&nbsp;&nbsp; // Format/fill the data from server side to HTML }On server side, one important task is to maintain all active client WebSocket connections so that it can &quot;broadcast&quot; messages to every client, and remove the closed client to avoid sending message to &quot;dead&quot; client. Other than this, the logic is very simple, validate message type sent from client, update players/vote status repository and then broadcast to all client: /* WebSocket server based on https://github.com/ncr/node.ws.js Written By Wayne Ye 6/4/2011 http://wayneye.com */  var sys = require(&quot;sys&quot;), &nbsp;&nbsp;&nbsp; ws = require(&quot;./ws&quot;);  var clients = [], players = [], voteStatus = [];  ws.createServer(function (websocket) { &nbsp;&nbsp;&nbsp; websocket.addListener(&quot;connect&quot;, function (resource) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted after handshake &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;Client connected on path: &quot; + resource);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Add to our list of clients &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.push(websocket);  &nbsp;&nbsp;&nbsp; }).addListener(&quot;data&quot;, function (data) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var clinetMsg = JSON.parse(data);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (clinetMsg.Type) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewParticipaint: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newPlayer = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New Participaint: &#39; + newPlayer); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; players.push(newPlayer);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewVoteInfo: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newVoteInfo = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New VoteInfo: &#39; + newVoteInfo.PlayerName + &#39; voted &#39; + newVoteInfo.VoteValue); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; voteStatus.push(newVoteInfo); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Notify all clients except the one just sent data &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var serverStatus = new ServerStatus(); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.Players = players; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.VoteStatus = voteStatus;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var srvMsgData = JSON.stringify(serverStatus);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;Broadcast server status to all clients: &#39; + srvMsgData); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients[i].write(srvMsgData); &nbsp;&nbsp;&nbsp; }).addListener(&quot;close&quot;, function () { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted when server or client closes connection  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Remove from our connections list so we don&#39;t send &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # to a dead socket &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (clients[i] == websocket) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;close with client: &quot; + websocket); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.splice(i); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp; }); }).listen(8888);  var MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; function ClientMessage(type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; function VoteInfo(playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } function ServerStatus() { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus &lt;span style=&quot;color: ">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Wayne's Geek Life">
<meta property="og:title" content="HTML5 Web Socket in Essence">
<meta property="og:url" content="https://wayneye.com/HTML5-Web-Socket-In-Essence">


  <meta property="og:description" content="HTML5 WebSocket defines a bi-directional, full-duplex communication channel operates through a single TCP connection, this article discusses its fantastic performance, the WebSocket protocol principle and its handshake mechanism, and develop a WebSocket application in action (Team Poker).&lt;/embed&gt;Embeded youku video link because Youtube is outside of the largest &quot;intranet&quot; in the entire universe!!Table of ContentIntroductionBackgroundWebSocket In EssenceExperimental DemosBrowser SupportWebSocket JavaScript APIDevelop WebSocket In Action - Team PokerOpen IssuesConclusionReferences &amp; Resources&nbsp;IntroductionHTML5 WebSocket&nbsp;defines a bi-directional, full-duplex communication channel that operates through a single TCP socket over the Web, it provides efficient, low-latency and low cost connection between web client and server, based on WebSocket, developers can build&nbsp;scalable,&nbsp;real-time&nbsp;web applications in the future. Section below is the official definition of WebSocket copied from&nbsp;IETF WebSocket protocol&nbsp;page:&nbsp;The WebSocket protocol enables two-way communication between a user agent running untrusted code running in a controlled environment to a remote host that has opted-in to communications from that code. &nbsp;The security model used for this is the Origin-based security model commonly used by Web browsers. &nbsp;The protocol consists of an initial handshake followed by basic message framing, layered over TCP. &nbsp;The goal of this technology is to provide a mechanism for browser-based applications that need two-way communication with servers that does not rely on opening multiple HTTP connections (e.g. using XMLHttpRequest or &lt;iframe&gt;s and long polling).This article is trying to go through WebSocket basic concept, the problems it is going to solve, explain it in essence,&nbsp;watch some experimental Demos, develop a simple WebSocket&nbsp;application in action (Team Poker), and describe current open issues of WebSocket. I sincerely hope it will be&nbsp;systematically,&nbsp;easy to understand,&nbsp;from surface to deep&nbsp;so that eventually readers would not only learn what WebSocket is from high level but also&nbsp;understand it in depth!&nbsp;Any thoughts, suggestions or criticism&nbsp;you may have after reading this article will help me to improve in the future, i would appreciate it if you could leave a comment.BackgroundIn traditional web applications, in order to achieve some real-time interaction with server, developers had to employ several tricky ways such as Ajax polling,&nbsp;Comet&nbsp;(A.K.A Ajax push,&nbsp;Full Duplex Ajax,&nbsp;HTTP Streaming, etc.),&nbsp;those technologies either periodically fire HTTP requests to server or hold the HTTP connection with server for a long time, which&nbsp;&quot;contain lots of additional, unnecessary header data and introduce latency&quot; and resulted in &quot;an outrageously high price tag&quot;.&nbsp;websocket.org explained the problems exhaustively, compared the performance&nbsp;of Ajax polling and WebSocket in detail, built up two simple web pages, one periodically communicated with server using traditional HTTP and the other used HTML5 WebSocket, in the testing each HTTP&nbsp;request/response header is approximate 871 byte, while data length of WebSocket connection is much shorter: 2 bytes after connection established, as the transfer count getting larger, the result will be:Traditional HTTP Request&nbsp;Use case A: 1,000 clients polling every second: Network throughput is (871 x 1,000) = 871,000 bytes = 6,968,000 bits per second (6.6 Mbps)Use case B: 10,000 clients polling every second: Network throughput is (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits per second (66 Mbps)Use case C: 100,000 clients polling every 1 second: Network throughput is (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits per second (665 Mbps)HTML5 WebSocketUse case A: 1,000 clients receive 1 message per second: Network throughput is (2 x 1,000) = 2,000 bytes = 16,000 bits per second (0.015 Mbps)Use case B: 10,000 clients receive 1 message per second: Network throughput is (2 x 10,000) = 20,000 bytes = 160,000 bits per second (0.153 Kbps)Use case C: 100,000 clients receive 1 message per second: Network throughput is (2 x 100,000) = 200,000 bytes = 1,600,000 bits per second (1.526 Kbps)Finally a more readable diagram:&nbsp;&quot;HTML5 Web Sockets can provide a 500:1 or &mdash; depending on the size of the HTTP headers &mdash; even a 1000:1 reduction in unnecessary HTTP header traffic and 3:1 reduction in latency&quot;. &nbsp;--WebSocket.orgWebSocket In EssenceThe motivation of creating WebSocket is to replace polling and long polling(Comet), and endow HTML5 web application the ability of real-time communication. Browser based web application can fire WebSocket connection request through JavaScript API, and then transfer data with server over only one TCP connection.This is achieved by the new protocol - The WebSocket Protocol, which is essentially an&nbsp;independent TCP-based protocol.&nbsp;To establish a WebSocket connection client/browser forms an HTTP request with &quot;Upgrade: WebSocket&quot; header which indicates a protocol upgrade request, and the handshake key(s) will be interpreted by HTTP servers and handshake response will be returned (the detailed handshake mechanism will be described below), afterwards the connection is established (figuratively speaking, the &#39;sockets&#39; have been plugged in at both client and server ends),&nbsp;both sides can&nbsp;transfer/receive data&nbsp;independently, no more redundant header information, and the connection&nbsp;won&#39;t be closed until one side sends close signal, that&#39;s why WebSocket is bidirectional and full duplex, in additional, comparing the request/response paradigm of HTTP, WebSocket layers a framing mechanism on top on TCP, each data frame is minimally just 2 bytes.  Now it is time for us to delve deep into this protocol, let&#39;s start with WebSocket version draft-hixie-thewebsocketprotocol-76 which is now supported by browsers (Chrome 6+, Firefox 4+, Opera 11) and many WebSocket servers (please refer to&nbsp;Browser/Server Support&nbsp;section below for details). A typical WebSocket request/response example is shown below:Request GET /demo HTTP/1.1Upgrade: WebSocketConnection: UpgradeHost: example.comOrigin: http://example.comSec-WebSocket-Key1: 4 @1 46546xW%0l 1 5Sec-WebSocket-Key2: 12998 5 Y3 1 .P00 ^n:ds[4U&nbsp;  Response HTTP/1.1 101 WebSocket Protocol HandshakeUpgrade: WebSocketConnection: UpgradeSec-WebSocket-Origin: http://example.comSec-WebSocket-Location: ws://example.com/demoSec-WebSocket-Protocol: sample 8jKS&#39;y:G*Co,Wxa-&nbsp;The entire process could be described as: the client raise a &quot;special&quot; HTTP request which request &quot;Upgrade&quot; connecting protocol to &quot;WebSocket&quot;, on domain &quot;example.com&quot; with path &quot;/demo&quot;, with three &quot;handshake&quot; fields:&nbsp;Sec-WebSocket-Key1, Sec-WebSocket-Key2 and&nbsp;8 bytes ({^n:ds[4U}) after the fields are random tokens which the WebSocket server uses to construct a 16-byte security hash&nbsp;at the end of its handshake to prove that it has read the client&#39;s handshake.Since WebSocket protocol is NOT finalized and is being improved and standardized by&nbsp;IETF Hypertext Bidirectional (HyBi) Working Group,&nbsp;at the time I wrote this article, the latest WebSocket version is &quot;draft-ietf-hybi-thewebsocketprotocol-08&quot; lasted updated by Ian Fette&nbsp;on June 7, 2011, in which both request/response headers are changed comparing to version 76, the handshake mechanism was changed as well, Sec-WebSocket-Key1 and&nbsp;Sec-WebSocket-Key1 are replaced with one&nbsp;Sec-WebSocket-Key.WebSocket request/response in the latest&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:RequestGET /demo HTTP/1.1Host: example.comUpgrade: websocketConnection: UpgradeSec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Origin: http://example.comSec-WebSocket-Protocol: chat, superchatSec-WebSocket-Version: 8ResponseHTTP/1.1 101 Switching ProtocolsUpgrade: websocketConnection: UpgradeSec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Sec-WebSocket-Protocol: chatThe Sec-WebSocket-Key is a base64 encoded randomly generated 16-byte value, in the case above it is &quot;WebSocket rocks!&quot;, the server reads the key, concats with a magic GUID &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, to &quot;V2ViU29ja2V0IHJvY2tzIQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, then compute its SHA1 hash, get result &quot;540b8681a34307fade550a467c317c297799c79a&quot;, finally based64 encodes the hash and append the value to header &quot;Sec-WebSocket-Accept&quot;.I&#39;ve written C# code below to demonstrate how to compute the Sec-WebSocket-Accept conforming to&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:&nbsp; /// &lt;summary&gt; /// Computes server security hash for HTML5 WebSocket, handshake mechanism  /// based on draft-ietf-hybi-thewebsocketprotocol-08 /// http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08#page-27 /// &lt;/summary&gt; /// &lt;param name=&quot;secWebSocketKey&quot;&gt;The handshake key &quot;Sec-WebSocket-Key&quot; from client.&lt;/param&gt; /// &lt;returns&gt;The computed security hash to fill &quot;Sec-WebSocket-Accept&quot; header.&lt;/returns&gt; public static String ComputeWebSocketHandshakeSecurityHash08(String secWebSocketKey) { &nbsp;&nbsp;&nbsp; const String MagicKEY = &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;; &nbsp;&nbsp;&nbsp; String secWebSocketAccept = String.Empty;  &nbsp;&nbsp;&nbsp; // 1. Combine the request Sec-WebSocket-Key with magic key. &nbsp;&nbsp;&nbsp; String ret = secWebSocketKey + MagicKEY;  &nbsp;&nbsp;&nbsp; // 2. Compute the SHA1 hash &nbsp;&nbsp;&nbsp; SHA1 sha = new SHA1CryptoServiceProvider();  &nbsp;&nbsp;&nbsp; byte[] sha1Hash = sha.ComputeHash(Encoding.UTF8.GetBytes(ret));  &nbsp;&nbsp;&nbsp; // 3. Base64 encode the hash &nbsp;&nbsp;&nbsp; secWebSocketAccept = Convert.ToBase64String(sha1Hash);  &nbsp;&nbsp;&nbsp; return secWebSocketAccept; }Unit test code: String secWebSocketKey = Convert.ToBase64String(Encoding.UTF8.GetBytes(&quot;WebSocket rocks!&quot;)); Console.WriteLine(&quot;Sec-WebSocket-Key: {0}&quot;, secWebSocketKey);  String secWebSocketAccept = ComputeWebSocketHandshakeSecurityHash08(secWebSocketKey); Console.WriteLine(&quot;Sec-WebSocket-Accept: &quot; + secWebSocketAccept);We would see the result by running code above:Sec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Please note draft-ietf-hybi-thewebsocketprotocol-08 is NOT supported by any common web browsers since it was just published on June 7, 2011. However, we can learn it so that we know what is happening now with WebSocket and where it&#39;s going in the future.Experimental DemosSo far there are already many experimental WebSocket Demos built based on either draft-hixie-thewebsocketprotocol-75&nbsp;or&nbsp;draft-hixie-thewebsocketprotocol-76.http://rumpetroll.com/&nbsp;Play a tadpole in canvas and can chat with other tadpoles, tadpoles location and char messages could be seen by everyone in real-time. http://html5labs.interoperabilitybridges.com/prototypes/websockets/websockets/info&nbsp;WebSocket Demos in Microsoft HTML5 Labs http://html5demos.com/web-socketA very simple &quot;Chat room&quot; demo using WebSocket.  http://kaazing.me/Refresh stock, weather, news and twits in real-time powered by Kaazing&#39;s real-time message delivery network solution. Mr. Doob&#39;s Multiuser SketchpadIn this multi-user&nbsp;&lt;canvas&gt;&nbsp;drawing application, Web Sockets are used to pass along the coordinates of the lines that other users draw back to each client as they happen.And so on.. You will also see a simple demo developed by me below.Browser/Server SupportWebSocket is not only designed for browser/server communication, client application can also use it. However, I guess browser will still be the major platform for WebSocket protocol taken into account the emerging handsets and the coming cloud. At the time I wrote this article, WebSocket protocol version draft-ietf-hybi-thewebsocketprotocol-76 was supported by Safari 5+/Google chrome 6+ (link), Mozilla Firefox 4+ (disabled by default&nbsp;link) and Opera 11 (disabled by default&nbsp;link), IE 9/10 does not support... but on not supported browsers we can use Flash shim/fallback by adopting&nbsp;web-socket-js.The awesome&nbsp;Can I uses it&nbsp;is&nbsp;maintaining HTML5 new features&nbsp;support&nbsp;in all popular browsers, screenshot below shows WebSocket support:There are also a number of WebSocket servers available:http://socket.io&nbsp; - Provides seamless support for a variety of transports (WebSocket, WebSocket over Flash, XHR polling, JSONP polling, etc.) intended for real-time communication developed by&nbsp;Guillermo Rauch&nbsp;node.ws.js&nbsp;- A simple WebSocket server (support both&nbsp;draft-hixie-thewebsocketprotocol-75 and draft-hixie-thewebsocketprotocol-76) developed based on node.websocket.js.web-socket-js&nbsp;- HTML5 Web Socket implementation powered by Flashhttp://nugget.codeplex.com&nbsp;- A web socket server implemented in C#.jWebSocket.org&nbsp;- The Open Source Java WebSocket Serverphpwebsocket - PHP version of WebSocket server.WebSocket JavaScript APIW3C defined&nbsp;WebSocket interface&nbsp;as below: [Constructor(in DOMString url, in optional DOMString protocols)] [Constructor(in DOMString url, in optional DOMString[] protocols)] interface WebSocket { &nbsp; readonly attribute DOMString url;  &nbsp; // ready state &nbsp; const unsigned short CONNECTING = 0; &nbsp; const unsigned short OPEN = 1; &nbsp; const unsigned short CLOSING = 2; &nbsp; const unsigned short CLOSED = 3; &nbsp; readonly attribute unsigned short readyState; &nbsp; readonly attribute unsigned long bufferedAmount;  &nbsp; // networking &nbsp;&nbsp;attribute Function onopen; &nbsp;&nbsp;attribute Function onmessage; &nbsp;&nbsp;attribute Function onerror; &nbsp;&nbsp;attribute Function onclose; &nbsp; readonly attribute DOMString protocol; &nbsp; void send(in DOMString data); &nbsp; void close(); }; WebSocket implements EventTarget;The url attribute is the WebSocket server Url, the protocol is usually &quot;ws&quot; (for unencrypted plain text WebSocket) or &quot;wss&quot; (for secure WebSocket), send method sends data to server after connected, close is to send close signal, besides there are four important events: onopen, onmessage, onerror and onclose, I borrowed a nice picture below from nettuts.onopen: When a socket has opened, i.e. after TCP three-way handshake and WebSocket handshake.onmessage: When a message has been received from WebSocket server.onerror: Triggered when error occurred.onclose: When a socket has been closed.JavaScript code below is to setup WebSocket connection and retrieve data: var wsUrl = &#39;ws://localhost:8888/DummyPath&#39;; var websocket = new WebSocket(wsUrl); websocket.onopen = function (evt) { onOpen(evt) }; websocket.onclose = function (evt) { onClose(evt) }; websocket.onmessage = function (evt) { onMessage(evt) }; websocket.onerror = function (evt) { onError(evt) };  &nbsp;&nbsp;&nbsp;  function onOpen(evt) { &nbsp;&nbsp;&nbsp; console.log(&quot;Connected to WebSocket server.&quot;); &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; websocket.send(&quot;HTML5 WebSocket rocks!&quot;); } function onClose(evt) { console.log(&quot;Disconnected&quot;); } function onMessage(evt) { &nbsp;&nbsp;&nbsp; console.log(&#39;Retrieved data from server: &#39; + evt.data);  &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; // Update UI... } function onError(evt) { console.log(&#39;Error occured: &#39; + evt.data); }Develop WebSocket In Action - Team Poker Demo&nbsp;Estimating user story effort by using&nbsp;Planning Poker Cards&nbsp;is well-known and widely used in Agile/Scrum development, Program Manager/Scrum Master prepare user stories beforehand, hold meeting with stake holders and have them play poker to represent one&#39;s estimation on each story, the higher the card value is, the harder to implement, on the contrary, the lower the value is, the easier to implement, &quot;0&quot; indicates &quot;no effort&quot; or &quot;has been done&quot;, &quot;?&quot; indicates &quot;mission impossible&quot; or &quot;unclear requirement&quot;.Actually there is a website - http://pokerplanning.com&nbsp;does the exact work described above, my co-workers and I used it for several times, however, we found it is getting slower and slower as more team members joining the game or after several rounds of voting, we did experience the worst result: no one can vote anymore because everyone&#39;s voting page got stucked.&nbsp;I strongly suspect the major reason for this is its Ajax Polling strategy in order to ensure everyone got real-time voting status. By tracking its network activities I guess I was right.Ajax polling in&nbsp;http://pokerplanning.com:I believe HTML5 WebSocket will solve the problem! So I developed a simple demo (I named it Team Poker) which currently only has limited and basic functionalities described as below:User can login to poker room after inputting his/her nickname.Everyone gets notified when one user players a poker.Everyone gets notified when new player joins.Newly joined player can see the current participants and voting status.The login screenshot for requirement #1:New participant(s), new voted poker(s) status update screenshot for requirement #2 and #3 (please click on the image to enlarge):Newly joined participant(s) can see current game status, story #4:Please note the Team Poker demo is concentrated on&nbsp;demonstrating the power of WebSocket, in real world, player shouldn&#39;t see the poker values played by other players, and there is functionalities like moderator customizing user stories, storing game status on server side, and there is no fancy UI/animation. However, I&#39;ve share all the source code at the beginning of this article, in additional, I&#39;ve uploaded the source code on github: https://github.com/WayneYe/TeamPoker,&nbsp;wish some people make it better and productive, will you fork it with me? Dear reader:).Ok, now coding time, since all clients need to get notified about other client&#39;s changes (new player joining or new poker played), in additional, new joint player needs to know current status, I defined two communication contracts:ClientMessage&nbsp;indicates message sent from client, contains&nbsp;a Type property reflects enumeration class MessageType - NewParticipaint, NewVoteInfo, and a Data property to store data.ServerStatus, stores current playing players as well as current voting status - a hashtable [{PlayerName}, {VoteValue}], broadcast to all clients once receiving new client message. var TeamPoker = TeamPoker || function () { };  TeamPoker.VoteInfo = function (playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } TeamPoker.MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; TeamPoker.ClientMessage = function (type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; TeamPoker.ServerStatus = function () { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus = []; };&nbsp;On client side,&nbsp;a WebSocket connection will be established after user clicking &quot;Login&quot; button, the nickname will be sent to WebSocket server running on nodejs, the kernal client code is shown below: TeamPoker.connectToWsServer = function () { &nbsp;&nbsp;&nbsp; // Init Web Socket connect &nbsp;&nbsp;&nbsp; var WSURI = &quot;ws://192.168.1.6:8888&quot;; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient = new WebSocket(WSURI);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onopen = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Successfully connected to WebSocket server.&#39;); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.joinGame(); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onclose = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Connection closed.&#39;); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onmessage = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Retrived msg from server: &#39; + evt.data); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.updateGameStatus(evt.data); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onerror = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;An error occured: &#39; + evt.data); &nbsp;&nbsp;&nbsp; }; };  TeamPoker.joinGame = function () { &nbsp;&nbsp;&nbsp; var joinGameMsg = new TeamPoker.ClientMessage(TeamPoker.MessageType.NewParticipaint, TeamPoker.CurrentPlayerName);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.send(JSON.stringify(joinGameMsg)); } TeamPoker.updateGameStatus = function (data) { &nbsp;&nbsp;&nbsp; // Format/fill the data from server side to HTML }On server side, one important task is to maintain all active client WebSocket connections so that it can &quot;broadcast&quot; messages to every client, and remove the closed client to avoid sending message to &quot;dead&quot; client. Other than this, the logic is very simple, validate message type sent from client, update players/vote status repository and then broadcast to all client: /* WebSocket server based on https://github.com/ncr/node.ws.js Written By Wayne Ye 6/4/2011 http://wayneye.com */  var sys = require(&quot;sys&quot;), &nbsp;&nbsp;&nbsp; ws = require(&quot;./ws&quot;);  var clients = [], players = [], voteStatus = [];  ws.createServer(function (websocket) { &nbsp;&nbsp;&nbsp; websocket.addListener(&quot;connect&quot;, function (resource) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted after handshake &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;Client connected on path: &quot; + resource);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Add to our list of clients &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.push(websocket);  &nbsp;&nbsp;&nbsp; }).addListener(&quot;data&quot;, function (data) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var clinetMsg = JSON.parse(data);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (clinetMsg.Type) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewParticipaint: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newPlayer = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New Participaint: &#39; + newPlayer); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; players.push(newPlayer);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewVoteInfo: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newVoteInfo = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New VoteInfo: &#39; + newVoteInfo.PlayerName + &#39; voted &#39; + newVoteInfo.VoteValue); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; voteStatus.push(newVoteInfo); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Notify all clients except the one just sent data &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var serverStatus = new ServerStatus(); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.Players = players; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.VoteStatus = voteStatus;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var srvMsgData = JSON.stringify(serverStatus);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;Broadcast server status to all clients: &#39; + srvMsgData); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients[i].write(srvMsgData); &nbsp;&nbsp;&nbsp; }).addListener(&quot;close&quot;, function () { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted when server or client closes connection  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Remove from our connections list so we don&#39;t send &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # to a dead socket &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (clients[i] == websocket) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;close with client: &quot; + websocket); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.splice(i); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp; }); }).listen(8888);  var MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; function ClientMessage(type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; function VoteInfo(playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } function ServerStatus() { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus &lt;span style=&quot;color: ">





  <meta name="twitter:site" content="@wayneye">
  <meta name="twitter:title" content="HTML5 Web Socket in Essence">
  <meta name="twitter:description" content="HTML5 WebSocket defines a bi-directional, full-duplex communication channel operates through a single TCP connection, this article discusses its fantastic performance, the WebSocket protocol principle and its handshake mechanism, and develop a WebSocket application in action (Team Poker).&lt;/embed&gt;Embeded youku video link because Youtube is outside of the largest &quot;intranet&quot; in the entire universe!!Table of ContentIntroductionBackgroundWebSocket In EssenceExperimental DemosBrowser SupportWebSocket JavaScript APIDevelop WebSocket In Action - Team PokerOpen IssuesConclusionReferences &amp; Resources&nbsp;IntroductionHTML5 WebSocket&nbsp;defines a bi-directional, full-duplex communication channel that operates through a single TCP socket over the Web, it provides efficient, low-latency and low cost connection between web client and server, based on WebSocket, developers can build&nbsp;scalable,&nbsp;real-time&nbsp;web applications in the future. Section below is the official definition of WebSocket copied from&nbsp;IETF WebSocket protocol&nbsp;page:&nbsp;The WebSocket protocol enables two-way communication between a user agent running untrusted code running in a controlled environment to a remote host that has opted-in to communications from that code. &nbsp;The security model used for this is the Origin-based security model commonly used by Web browsers. &nbsp;The protocol consists of an initial handshake followed by basic message framing, layered over TCP. &nbsp;The goal of this technology is to provide a mechanism for browser-based applications that need two-way communication with servers that does not rely on opening multiple HTTP connections (e.g. using XMLHttpRequest or &lt;iframe&gt;s and long polling).This article is trying to go through WebSocket basic concept, the problems it is going to solve, explain it in essence,&nbsp;watch some experimental Demos, develop a simple WebSocket&nbsp;application in action (Team Poker), and describe current open issues of WebSocket. I sincerely hope it will be&nbsp;systematically,&nbsp;easy to understand,&nbsp;from surface to deep&nbsp;so that eventually readers would not only learn what WebSocket is from high level but also&nbsp;understand it in depth!&nbsp;Any thoughts, suggestions or criticism&nbsp;you may have after reading this article will help me to improve in the future, i would appreciate it if you could leave a comment.BackgroundIn traditional web applications, in order to achieve some real-time interaction with server, developers had to employ several tricky ways such as Ajax polling,&nbsp;Comet&nbsp;(A.K.A Ajax push,&nbsp;Full Duplex Ajax,&nbsp;HTTP Streaming, etc.),&nbsp;those technologies either periodically fire HTTP requests to server or hold the HTTP connection with server for a long time, which&nbsp;&quot;contain lots of additional, unnecessary header data and introduce latency&quot; and resulted in &quot;an outrageously high price tag&quot;.&nbsp;websocket.org explained the problems exhaustively, compared the performance&nbsp;of Ajax polling and WebSocket in detail, built up two simple web pages, one periodically communicated with server using traditional HTTP and the other used HTML5 WebSocket, in the testing each HTTP&nbsp;request/response header is approximate 871 byte, while data length of WebSocket connection is much shorter: 2 bytes after connection established, as the transfer count getting larger, the result will be:Traditional HTTP Request&nbsp;Use case A: 1,000 clients polling every second: Network throughput is (871 x 1,000) = 871,000 bytes = 6,968,000 bits per second (6.6 Mbps)Use case B: 10,000 clients polling every second: Network throughput is (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits per second (66 Mbps)Use case C: 100,000 clients polling every 1 second: Network throughput is (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits per second (665 Mbps)HTML5 WebSocketUse case A: 1,000 clients receive 1 message per second: Network throughput is (2 x 1,000) = 2,000 bytes = 16,000 bits per second (0.015 Mbps)Use case B: 10,000 clients receive 1 message per second: Network throughput is (2 x 10,000) = 20,000 bytes = 160,000 bits per second (0.153 Kbps)Use case C: 100,000 clients receive 1 message per second: Network throughput is (2 x 100,000) = 200,000 bytes = 1,600,000 bits per second (1.526 Kbps)Finally a more readable diagram:&nbsp;&quot;HTML5 Web Sockets can provide a 500:1 or &mdash; depending on the size of the HTTP headers &mdash; even a 1000:1 reduction in unnecessary HTTP header traffic and 3:1 reduction in latency&quot;. &nbsp;--WebSocket.orgWebSocket In EssenceThe motivation of creating WebSocket is to replace polling and long polling(Comet), and endow HTML5 web application the ability of real-time communication. Browser based web application can fire WebSocket connection request through JavaScript API, and then transfer data with server over only one TCP connection.This is achieved by the new protocol - The WebSocket Protocol, which is essentially an&nbsp;independent TCP-based protocol.&nbsp;To establish a WebSocket connection client/browser forms an HTTP request with &quot;Upgrade: WebSocket&quot; header which indicates a protocol upgrade request, and the handshake key(s) will be interpreted by HTTP servers and handshake response will be returned (the detailed handshake mechanism will be described below), afterwards the connection is established (figuratively speaking, the &#39;sockets&#39; have been plugged in at both client and server ends),&nbsp;both sides can&nbsp;transfer/receive data&nbsp;independently, no more redundant header information, and the connection&nbsp;won&#39;t be closed until one side sends close signal, that&#39;s why WebSocket is bidirectional and full duplex, in additional, comparing the request/response paradigm of HTTP, WebSocket layers a framing mechanism on top on TCP, each data frame is minimally just 2 bytes.  Now it is time for us to delve deep into this protocol, let&#39;s start with WebSocket version draft-hixie-thewebsocketprotocol-76 which is now supported by browsers (Chrome 6+, Firefox 4+, Opera 11) and many WebSocket servers (please refer to&nbsp;Browser/Server Support&nbsp;section below for details). A typical WebSocket request/response example is shown below:Request GET /demo HTTP/1.1Upgrade: WebSocketConnection: UpgradeHost: example.comOrigin: http://example.comSec-WebSocket-Key1: 4 @1 46546xW%0l 1 5Sec-WebSocket-Key2: 12998 5 Y3 1 .P00 ^n:ds[4U&nbsp;  Response HTTP/1.1 101 WebSocket Protocol HandshakeUpgrade: WebSocketConnection: UpgradeSec-WebSocket-Origin: http://example.comSec-WebSocket-Location: ws://example.com/demoSec-WebSocket-Protocol: sample 8jKS&#39;y:G*Co,Wxa-&nbsp;The entire process could be described as: the client raise a &quot;special&quot; HTTP request which request &quot;Upgrade&quot; connecting protocol to &quot;WebSocket&quot;, on domain &quot;example.com&quot; with path &quot;/demo&quot;, with three &quot;handshake&quot; fields:&nbsp;Sec-WebSocket-Key1, Sec-WebSocket-Key2 and&nbsp;8 bytes ({^n:ds[4U}) after the fields are random tokens which the WebSocket server uses to construct a 16-byte security hash&nbsp;at the end of its handshake to prove that it has read the client&#39;s handshake.Since WebSocket protocol is NOT finalized and is being improved and standardized by&nbsp;IETF Hypertext Bidirectional (HyBi) Working Group,&nbsp;at the time I wrote this article, the latest WebSocket version is &quot;draft-ietf-hybi-thewebsocketprotocol-08&quot; lasted updated by Ian Fette&nbsp;on June 7, 2011, in which both request/response headers are changed comparing to version 76, the handshake mechanism was changed as well, Sec-WebSocket-Key1 and&nbsp;Sec-WebSocket-Key1 are replaced with one&nbsp;Sec-WebSocket-Key.WebSocket request/response in the latest&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:RequestGET /demo HTTP/1.1Host: example.comUpgrade: websocketConnection: UpgradeSec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Origin: http://example.comSec-WebSocket-Protocol: chat, superchatSec-WebSocket-Version: 8ResponseHTTP/1.1 101 Switching ProtocolsUpgrade: websocketConnection: UpgradeSec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Sec-WebSocket-Protocol: chatThe Sec-WebSocket-Key is a base64 encoded randomly generated 16-byte value, in the case above it is &quot;WebSocket rocks!&quot;, the server reads the key, concats with a magic GUID &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, to &quot;V2ViU29ja2V0IHJvY2tzIQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, then compute its SHA1 hash, get result &quot;540b8681a34307fade550a467c317c297799c79a&quot;, finally based64 encodes the hash and append the value to header &quot;Sec-WebSocket-Accept&quot;.I&#39;ve written C# code below to demonstrate how to compute the Sec-WebSocket-Accept conforming to&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:&nbsp; /// &lt;summary&gt; /// Computes server security hash for HTML5 WebSocket, handshake mechanism  /// based on draft-ietf-hybi-thewebsocketprotocol-08 /// http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08#page-27 /// &lt;/summary&gt; /// &lt;param name=&quot;secWebSocketKey&quot;&gt;The handshake key &quot;Sec-WebSocket-Key&quot; from client.&lt;/param&gt; /// &lt;returns&gt;The computed security hash to fill &quot;Sec-WebSocket-Accept&quot; header.&lt;/returns&gt; public static String ComputeWebSocketHandshakeSecurityHash08(String secWebSocketKey) { &nbsp;&nbsp;&nbsp; const String MagicKEY = &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;; &nbsp;&nbsp;&nbsp; String secWebSocketAccept = String.Empty;  &nbsp;&nbsp;&nbsp; // 1. Combine the request Sec-WebSocket-Key with magic key. &nbsp;&nbsp;&nbsp; String ret = secWebSocketKey + MagicKEY;  &nbsp;&nbsp;&nbsp; // 2. Compute the SHA1 hash &nbsp;&nbsp;&nbsp; SHA1 sha = new SHA1CryptoServiceProvider();  &nbsp;&nbsp;&nbsp; byte[] sha1Hash = sha.ComputeHash(Encoding.UTF8.GetBytes(ret));  &nbsp;&nbsp;&nbsp; // 3. Base64 encode the hash &nbsp;&nbsp;&nbsp; secWebSocketAccept = Convert.ToBase64String(sha1Hash);  &nbsp;&nbsp;&nbsp; return secWebSocketAccept; }Unit test code: String secWebSocketKey = Convert.ToBase64String(Encoding.UTF8.GetBytes(&quot;WebSocket rocks!&quot;)); Console.WriteLine(&quot;Sec-WebSocket-Key: {0}&quot;, secWebSocketKey);  String secWebSocketAccept = ComputeWebSocketHandshakeSecurityHash08(secWebSocketKey); Console.WriteLine(&quot;Sec-WebSocket-Accept: &quot; + secWebSocketAccept);We would see the result by running code above:Sec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Please note draft-ietf-hybi-thewebsocketprotocol-08 is NOT supported by any common web browsers since it was just published on June 7, 2011. However, we can learn it so that we know what is happening now with WebSocket and where it&#39;s going in the future.Experimental DemosSo far there are already many experimental WebSocket Demos built based on either draft-hixie-thewebsocketprotocol-75&nbsp;or&nbsp;draft-hixie-thewebsocketprotocol-76.http://rumpetroll.com/&nbsp;Play a tadpole in canvas and can chat with other tadpoles, tadpoles location and char messages could be seen by everyone in real-time. http://html5labs.interoperabilitybridges.com/prototypes/websockets/websockets/info&nbsp;WebSocket Demos in Microsoft HTML5 Labs http://html5demos.com/web-socketA very simple &quot;Chat room&quot; demo using WebSocket.  http://kaazing.me/Refresh stock, weather, news and twits in real-time powered by Kaazing&#39;s real-time message delivery network solution. Mr. Doob&#39;s Multiuser SketchpadIn this multi-user&nbsp;&lt;canvas&gt;&nbsp;drawing application, Web Sockets are used to pass along the coordinates of the lines that other users draw back to each client as they happen.And so on.. You will also see a simple demo developed by me below.Browser/Server SupportWebSocket is not only designed for browser/server communication, client application can also use it. However, I guess browser will still be the major platform for WebSocket protocol taken into account the emerging handsets and the coming cloud. At the time I wrote this article, WebSocket protocol version draft-ietf-hybi-thewebsocketprotocol-76 was supported by Safari 5+/Google chrome 6+ (link), Mozilla Firefox 4+ (disabled by default&nbsp;link) and Opera 11 (disabled by default&nbsp;link), IE 9/10 does not support... but on not supported browsers we can use Flash shim/fallback by adopting&nbsp;web-socket-js.The awesome&nbsp;Can I uses it&nbsp;is&nbsp;maintaining HTML5 new features&nbsp;support&nbsp;in all popular browsers, screenshot below shows WebSocket support:There are also a number of WebSocket servers available:http://socket.io&nbsp; - Provides seamless support for a variety of transports (WebSocket, WebSocket over Flash, XHR polling, JSONP polling, etc.) intended for real-time communication developed by&nbsp;Guillermo Rauch&nbsp;node.ws.js&nbsp;- A simple WebSocket server (support both&nbsp;draft-hixie-thewebsocketprotocol-75 and draft-hixie-thewebsocketprotocol-76) developed based on node.websocket.js.web-socket-js&nbsp;- HTML5 Web Socket implementation powered by Flashhttp://nugget.codeplex.com&nbsp;- A web socket server implemented in C#.jWebSocket.org&nbsp;- The Open Source Java WebSocket Serverphpwebsocket - PHP version of WebSocket server.WebSocket JavaScript APIW3C defined&nbsp;WebSocket interface&nbsp;as below: [Constructor(in DOMString url, in optional DOMString protocols)] [Constructor(in DOMString url, in optional DOMString[] protocols)] interface WebSocket { &nbsp; readonly attribute DOMString url;  &nbsp; // ready state &nbsp; const unsigned short CONNECTING = 0; &nbsp; const unsigned short OPEN = 1; &nbsp; const unsigned short CLOSING = 2; &nbsp; const unsigned short CLOSED = 3; &nbsp; readonly attribute unsigned short readyState; &nbsp; readonly attribute unsigned long bufferedAmount;  &nbsp; // networking &nbsp;&nbsp;attribute Function onopen; &nbsp;&nbsp;attribute Function onmessage; &nbsp;&nbsp;attribute Function onerror; &nbsp;&nbsp;attribute Function onclose; &nbsp; readonly attribute DOMString protocol; &nbsp; void send(in DOMString data); &nbsp; void close(); }; WebSocket implements EventTarget;The url attribute is the WebSocket server Url, the protocol is usually &quot;ws&quot; (for unencrypted plain text WebSocket) or &quot;wss&quot; (for secure WebSocket), send method sends data to server after connected, close is to send close signal, besides there are four important events: onopen, onmessage, onerror and onclose, I borrowed a nice picture below from nettuts.onopen: When a socket has opened, i.e. after TCP three-way handshake and WebSocket handshake.onmessage: When a message has been received from WebSocket server.onerror: Triggered when error occurred.onclose: When a socket has been closed.JavaScript code below is to setup WebSocket connection and retrieve data: var wsUrl = &#39;ws://localhost:8888/DummyPath&#39;; var websocket = new WebSocket(wsUrl); websocket.onopen = function (evt) { onOpen(evt) }; websocket.onclose = function (evt) { onClose(evt) }; websocket.onmessage = function (evt) { onMessage(evt) }; websocket.onerror = function (evt) { onError(evt) };  &nbsp;&nbsp;&nbsp;  function onOpen(evt) { &nbsp;&nbsp;&nbsp; console.log(&quot;Connected to WebSocket server.&quot;); &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; websocket.send(&quot;HTML5 WebSocket rocks!&quot;); } function onClose(evt) { console.log(&quot;Disconnected&quot;); } function onMessage(evt) { &nbsp;&nbsp;&nbsp; console.log(&#39;Retrieved data from server: &#39; + evt.data);  &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; // Update UI... } function onError(evt) { console.log(&#39;Error occured: &#39; + evt.data); }Develop WebSocket In Action - Team Poker Demo&nbsp;Estimating user story effort by using&nbsp;Planning Poker Cards&nbsp;is well-known and widely used in Agile/Scrum development, Program Manager/Scrum Master prepare user stories beforehand, hold meeting with stake holders and have them play poker to represent one&#39;s estimation on each story, the higher the card value is, the harder to implement, on the contrary, the lower the value is, the easier to implement, &quot;0&quot; indicates &quot;no effort&quot; or &quot;has been done&quot;, &quot;?&quot; indicates &quot;mission impossible&quot; or &quot;unclear requirement&quot;.Actually there is a website - http://pokerplanning.com&nbsp;does the exact work described above, my co-workers and I used it for several times, however, we found it is getting slower and slower as more team members joining the game or after several rounds of voting, we did experience the worst result: no one can vote anymore because everyone&#39;s voting page got stucked.&nbsp;I strongly suspect the major reason for this is its Ajax Polling strategy in order to ensure everyone got real-time voting status. By tracking its network activities I guess I was right.Ajax polling in&nbsp;http://pokerplanning.com:I believe HTML5 WebSocket will solve the problem! So I developed a simple demo (I named it Team Poker) which currently only has limited and basic functionalities described as below:User can login to poker room after inputting his/her nickname.Everyone gets notified when one user players a poker.Everyone gets notified when new player joins.Newly joined player can see the current participants and voting status.The login screenshot for requirement #1:New participant(s), new voted poker(s) status update screenshot for requirement #2 and #3 (please click on the image to enlarge):Newly joined participant(s) can see current game status, story #4:Please note the Team Poker demo is concentrated on&nbsp;demonstrating the power of WebSocket, in real world, player shouldn&#39;t see the poker values played by other players, and there is functionalities like moderator customizing user stories, storing game status on server side, and there is no fancy UI/animation. However, I&#39;ve share all the source code at the beginning of this article, in additional, I&#39;ve uploaded the source code on github: https://github.com/WayneYe/TeamPoker,&nbsp;wish some people make it better and productive, will you fork it with me? Dear reader:).Ok, now coding time, since all clients need to get notified about other client&#39;s changes (new player joining or new poker played), in additional, new joint player needs to know current status, I defined two communication contracts:ClientMessage&nbsp;indicates message sent from client, contains&nbsp;a Type property reflects enumeration class MessageType - NewParticipaint, NewVoteInfo, and a Data property to store data.ServerStatus, stores current playing players as well as current voting status - a hashtable [{PlayerName}, {VoteValue}], broadcast to all clients once receiving new client message. var TeamPoker = TeamPoker || function () { };  TeamPoker.VoteInfo = function (playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } TeamPoker.MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; TeamPoker.ClientMessage = function (type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; TeamPoker.ServerStatus = function () { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus = []; };&nbsp;On client side,&nbsp;a WebSocket connection will be established after user clicking &quot;Login&quot; button, the nickname will be sent to WebSocket server running on nodejs, the kernal client code is shown below: TeamPoker.connectToWsServer = function () { &nbsp;&nbsp;&nbsp; // Init Web Socket connect &nbsp;&nbsp;&nbsp; var WSURI = &quot;ws://192.168.1.6:8888&quot;; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient = new WebSocket(WSURI);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onopen = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Successfully connected to WebSocket server.&#39;); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.joinGame(); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onclose = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Connection closed.&#39;); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onmessage = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Retrived msg from server: &#39; + evt.data); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.updateGameStatus(evt.data); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onerror = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;An error occured: &#39; + evt.data); &nbsp;&nbsp;&nbsp; }; };  TeamPoker.joinGame = function () { &nbsp;&nbsp;&nbsp; var joinGameMsg = new TeamPoker.ClientMessage(TeamPoker.MessageType.NewParticipaint, TeamPoker.CurrentPlayerName);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.send(JSON.stringify(joinGameMsg)); } TeamPoker.updateGameStatus = function (data) { &nbsp;&nbsp;&nbsp; // Format/fill the data from server side to HTML }On server side, one important task is to maintain all active client WebSocket connections so that it can &quot;broadcast&quot; messages to every client, and remove the closed client to avoid sending message to &quot;dead&quot; client. Other than this, the logic is very simple, validate message type sent from client, update players/vote status repository and then broadcast to all client: /* WebSocket server based on https://github.com/ncr/node.ws.js Written By Wayne Ye 6/4/2011 http://wayneye.com */  var sys = require(&quot;sys&quot;), &nbsp;&nbsp;&nbsp; ws = require(&quot;./ws&quot;);  var clients = [], players = [], voteStatus = [];  ws.createServer(function (websocket) { &nbsp;&nbsp;&nbsp; websocket.addListener(&quot;connect&quot;, function (resource) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted after handshake &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;Client connected on path: &quot; + resource);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Add to our list of clients &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.push(websocket);  &nbsp;&nbsp;&nbsp; }).addListener(&quot;data&quot;, function (data) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var clinetMsg = JSON.parse(data);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (clinetMsg.Type) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewParticipaint: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newPlayer = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New Participaint: &#39; + newPlayer); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; players.push(newPlayer);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewVoteInfo: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newVoteInfo = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New VoteInfo: &#39; + newVoteInfo.PlayerName + &#39; voted &#39; + newVoteInfo.VoteValue); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; voteStatus.push(newVoteInfo); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Notify all clients except the one just sent data &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var serverStatus = new ServerStatus(); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.Players = players; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.VoteStatus = voteStatus;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var srvMsgData = JSON.stringify(serverStatus);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;Broadcast server status to all clients: &#39; + srvMsgData); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients[i].write(srvMsgData); &nbsp;&nbsp;&nbsp; }).addListener(&quot;close&quot;, function () { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted when server or client closes connection  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Remove from our connections list so we don&#39;t send &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # to a dead socket &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (clients[i] == websocket) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;close with client: &quot; + websocket); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.splice(i); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp; }); }).listen(8888);  var MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; function ClientMessage(type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; function VoteInfo(playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } function ServerStatus() { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus &lt;span style=&quot;color: ">
  <meta name="twitter:url" content="https://wayneye.com/HTML5-Web-Socket-In-Essence">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2011-06-10T00:00:00-07:00">





  

  
    <meta property="fb:app_id" content="374223339969060">
  


<link rel="canonical" href="https://wayneye.com/HTML5-Web-Socket-In-Essence">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Wayne's Geek Life Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon/favicon-16x16.png">
<link rel="manifest" href="assets/images/favicon/site.webmanifest">
<link rel="mask-icon" href="assets/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">Wayne's Geek Life</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/search/" >Search</a>
            </li><li class="masthead__menu-item">
              <a href="/album/" >Album</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/me.jpg" alt="Wayne Ye" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Wayne Ye</h3>
    
    
      <p class="author__bio" itemprop="description">
        Whatever is worth doing is worth doing well!
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">San Francisco</span>
        </li>
      

      
        
          
            <li><a href="mailto:me@wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
          
        
          
            <li><a href="https://wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> Website</a></li>
          
        
          
            <li><a href="https://twitter.com/wayneye" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://facebook.com/WayneYeDotCom" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
          
        
          
            <li><a href="https://github.com/WayneYe/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="HTML5 Web Socket in Essence">
    <meta itemprop="description" content="HTML5 WebSocket defines a bi-directional, full-duplex communication channel operates through a single TCP connection, this article discusses its fantastic performance, the WebSocket protocol principle and its handshake mechanism, and develop a WebSocket application in action (Team Poker).&lt;/embed&gt;Embeded youku video link because Youtube is outside of the largest &quot;intranet&quot; in the entire universe!!Table of ContentIntroductionBackgroundWebSocket In EssenceExperimental DemosBrowser SupportWebSocket JavaScript APIDevelop WebSocket In Action - Team PokerOpen IssuesConclusionReferences &amp; Resources&nbsp;IntroductionHTML5 WebSocket&nbsp;defines a bi-directional, full-duplex communication channel that operates through a single TCP socket over the Web, it provides efficient, low-latency and low cost connection between web client and server, based on WebSocket, developers can build&nbsp;scalable,&nbsp;real-time&nbsp;web applications in the future. Section below is the official definition of WebSocket copied from&nbsp;IETF WebSocket protocol&nbsp;page:&nbsp;The WebSocket protocol enables two-way communication between a user agent running untrusted code running in a controlled environment to a remote host that has opted-in to communications from that code. &nbsp;The security model used for this is the Origin-based security model commonly used by Web browsers. &nbsp;The protocol consists of an initial handshake followed by basic message framing, layered over TCP. &nbsp;The goal of this technology is to provide a mechanism for browser-based applications that need two-way communication with servers that does not rely on opening multiple HTTP connections (e.g. using XMLHttpRequest or &lt;iframe&gt;s and long polling).This article is trying to go through WebSocket basic concept, the problems it is going to solve, explain it in essence,&nbsp;watch some experimental Demos, develop a simple WebSocket&nbsp;application in action (Team Poker), and describe current open issues of WebSocket. I sincerely hope it will be&nbsp;systematically,&nbsp;easy to understand,&nbsp;from surface to deep&nbsp;so that eventually readers would not only learn what WebSocket is from high level but also&nbsp;understand it in depth!&nbsp;Any thoughts, suggestions or criticism&nbsp;you may have after reading this article will help me to improve in the future, i would appreciate it if you could leave a comment.BackgroundIn traditional web applications, in order to achieve some real-time interaction with server, developers had to employ several tricky ways such as Ajax polling,&nbsp;Comet&nbsp;(A.K.A Ajax push,&nbsp;Full Duplex Ajax,&nbsp;HTTP Streaming, etc.),&nbsp;those technologies either periodically fire HTTP requests to server or hold the HTTP connection with server for a long time, which&nbsp;&quot;contain lots of additional, unnecessary header data and introduce latency&quot; and resulted in &quot;an outrageously high price tag&quot;.&nbsp;websocket.org explained the problems exhaustively, compared the performance&nbsp;of Ajax polling and WebSocket in detail, built up two simple web pages, one periodically communicated with server using traditional HTTP and the other used HTML5 WebSocket, in the testing each HTTP&nbsp;request/response header is approximate 871 byte, while data length of WebSocket connection is much shorter: 2 bytes after connection established, as the transfer count getting larger, the result will be:Traditional HTTP Request&nbsp;Use case A: 1,000 clients polling every second: Network throughput is (871 x 1,000) = 871,000 bytes = 6,968,000 bits per second (6.6 Mbps)Use case B: 10,000 clients polling every second: Network throughput is (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits per second (66 Mbps)Use case C: 100,000 clients polling every 1 second: Network throughput is (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits per second (665 Mbps)HTML5 WebSocketUse case A: 1,000 clients receive 1 message per second: Network throughput is (2 x 1,000) = 2,000 bytes = 16,000 bits per second (0.015 Mbps)Use case B: 10,000 clients receive 1 message per second: Network throughput is (2 x 10,000) = 20,000 bytes = 160,000 bits per second (0.153 Kbps)Use case C: 100,000 clients receive 1 message per second: Network throughput is (2 x 100,000) = 200,000 bytes = 1,600,000 bits per second (1.526 Kbps)Finally a more readable diagram:&nbsp;&quot;HTML5 Web Sockets can provide a 500:1 or &mdash; depending on the size of the HTTP headers &mdash; even a 1000:1 reduction in unnecessary HTTP header traffic and 3:1 reduction in latency&quot;. &nbsp;--WebSocket.orgWebSocket In EssenceThe motivation of creating WebSocket is to replace polling and long polling(Comet), and endow HTML5 web application the ability of real-time communication. Browser based web application can fire WebSocket connection request through JavaScript API, and then transfer data with server over only one TCP connection.This is achieved by the new protocol - The WebSocket Protocol, which is essentially an&nbsp;independent TCP-based protocol.&nbsp;To establish a WebSocket connection client/browser forms an HTTP request with &quot;Upgrade: WebSocket&quot; header which indicates a protocol upgrade request, and the handshake key(s) will be interpreted by HTTP servers and handshake response will be returned (the detailed handshake mechanism will be described below), afterwards the connection is established (figuratively speaking, the &#39;sockets&#39; have been plugged in at both client and server ends),&nbsp;both sides can&nbsp;transfer/receive data&nbsp;independently, no more redundant header information, and the connection&nbsp;won&#39;t be closed until one side sends close signal, that&#39;s why WebSocket is bidirectional and full duplex, in additional, comparing the request/response paradigm of HTTP, WebSocket layers a framing mechanism on top on TCP, each data frame is minimally just 2 bytes.  Now it is time for us to delve deep into this protocol, let&#39;s start with WebSocket version draft-hixie-thewebsocketprotocol-76 which is now supported by browsers (Chrome 6+, Firefox 4+, Opera 11) and many WebSocket servers (please refer to&nbsp;Browser/Server Support&nbsp;section below for details). A typical WebSocket request/response example is shown below:Request GET /demo HTTP/1.1Upgrade: WebSocketConnection: UpgradeHost: example.comOrigin: http://example.comSec-WebSocket-Key1: 4 @1 46546xW%0l 1 5Sec-WebSocket-Key2: 12998 5 Y3 1 .P00 ^n:ds[4U&nbsp;  Response HTTP/1.1 101 WebSocket Protocol HandshakeUpgrade: WebSocketConnection: UpgradeSec-WebSocket-Origin: http://example.comSec-WebSocket-Location: ws://example.com/demoSec-WebSocket-Protocol: sample 8jKS&#39;y:G*Co,Wxa-&nbsp;The entire process could be described as: the client raise a &quot;special&quot; HTTP request which request &quot;Upgrade&quot; connecting protocol to &quot;WebSocket&quot;, on domain &quot;example.com&quot; with path &quot;/demo&quot;, with three &quot;handshake&quot; fields:&nbsp;Sec-WebSocket-Key1, Sec-WebSocket-Key2 and&nbsp;8 bytes ({^n:ds[4U}) after the fields are random tokens which the WebSocket server uses to construct a 16-byte security hash&nbsp;at the end of its handshake to prove that it has read the client&#39;s handshake.Since WebSocket protocol is NOT finalized and is being improved and standardized by&nbsp;IETF Hypertext Bidirectional (HyBi) Working Group,&nbsp;at the time I wrote this article, the latest WebSocket version is &quot;draft-ietf-hybi-thewebsocketprotocol-08&quot; lasted updated by Ian Fette&nbsp;on June 7, 2011, in which both request/response headers are changed comparing to version 76, the handshake mechanism was changed as well, Sec-WebSocket-Key1 and&nbsp;Sec-WebSocket-Key1 are replaced with one&nbsp;Sec-WebSocket-Key.WebSocket request/response in the latest&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:RequestGET /demo HTTP/1.1Host: example.comUpgrade: websocketConnection: UpgradeSec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Origin: http://example.comSec-WebSocket-Protocol: chat, superchatSec-WebSocket-Version: 8ResponseHTTP/1.1 101 Switching ProtocolsUpgrade: websocketConnection: UpgradeSec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Sec-WebSocket-Protocol: chatThe Sec-WebSocket-Key is a base64 encoded randomly generated 16-byte value, in the case above it is &quot;WebSocket rocks!&quot;, the server reads the key, concats with a magic GUID &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, to &quot;V2ViU29ja2V0IHJvY2tzIQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;, then compute its SHA1 hash, get result &quot;540b8681a34307fade550a467c317c297799c79a&quot;, finally based64 encodes the hash and append the value to header &quot;Sec-WebSocket-Accept&quot;.I&#39;ve written C# code below to demonstrate how to compute the Sec-WebSocket-Accept conforming to&nbsp;draft-ietf-hybi-thewebsocketprotocol-08:&nbsp; /// &lt;summary&gt; /// Computes server security hash for HTML5 WebSocket, handshake mechanism  /// based on draft-ietf-hybi-thewebsocketprotocol-08 /// http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08#page-27 /// &lt;/summary&gt; /// &lt;param name=&quot;secWebSocketKey&quot;&gt;The handshake key &quot;Sec-WebSocket-Key&quot; from client.&lt;/param&gt; /// &lt;returns&gt;The computed security hash to fill &quot;Sec-WebSocket-Accept&quot; header.&lt;/returns&gt; public static String ComputeWebSocketHandshakeSecurityHash08(String secWebSocketKey) { &nbsp;&nbsp;&nbsp; const String MagicKEY = &quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;; &nbsp;&nbsp;&nbsp; String secWebSocketAccept = String.Empty;  &nbsp;&nbsp;&nbsp; // 1. Combine the request Sec-WebSocket-Key with magic key. &nbsp;&nbsp;&nbsp; String ret = secWebSocketKey + MagicKEY;  &nbsp;&nbsp;&nbsp; // 2. Compute the SHA1 hash &nbsp;&nbsp;&nbsp; SHA1 sha = new SHA1CryptoServiceProvider();  &nbsp;&nbsp;&nbsp; byte[] sha1Hash = sha.ComputeHash(Encoding.UTF8.GetBytes(ret));  &nbsp;&nbsp;&nbsp; // 3. Base64 encode the hash &nbsp;&nbsp;&nbsp; secWebSocketAccept = Convert.ToBase64String(sha1Hash);  &nbsp;&nbsp;&nbsp; return secWebSocketAccept; }Unit test code: String secWebSocketKey = Convert.ToBase64String(Encoding.UTF8.GetBytes(&quot;WebSocket rocks!&quot;)); Console.WriteLine(&quot;Sec-WebSocket-Key: {0}&quot;, secWebSocketKey);  String secWebSocketAccept = ComputeWebSocketHandshakeSecurityHash08(secWebSocketKey); Console.WriteLine(&quot;Sec-WebSocket-Accept: &quot; + secWebSocketAccept);We would see the result by running code above:Sec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==Sec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=Please note draft-ietf-hybi-thewebsocketprotocol-08 is NOT supported by any common web browsers since it was just published on June 7, 2011. However, we can learn it so that we know what is happening now with WebSocket and where it&#39;s going in the future.Experimental DemosSo far there are already many experimental WebSocket Demos built based on either draft-hixie-thewebsocketprotocol-75&nbsp;or&nbsp;draft-hixie-thewebsocketprotocol-76.http://rumpetroll.com/&nbsp;Play a tadpole in canvas and can chat with other tadpoles, tadpoles location and char messages could be seen by everyone in real-time. http://html5labs.interoperabilitybridges.com/prototypes/websockets/websockets/info&nbsp;WebSocket Demos in Microsoft HTML5 Labs http://html5demos.com/web-socketA very simple &quot;Chat room&quot; demo using WebSocket.  http://kaazing.me/Refresh stock, weather, news and twits in real-time powered by Kaazing&#39;s real-time message delivery network solution. Mr. Doob&#39;s Multiuser SketchpadIn this multi-user&nbsp;&lt;canvas&gt;&nbsp;drawing application, Web Sockets are used to pass along the coordinates of the lines that other users draw back to each client as they happen.And so on.. You will also see a simple demo developed by me below.Browser/Server SupportWebSocket is not only designed for browser/server communication, client application can also use it. However, I guess browser will still be the major platform for WebSocket protocol taken into account the emerging handsets and the coming cloud. At the time I wrote this article, WebSocket protocol version draft-ietf-hybi-thewebsocketprotocol-76 was supported by Safari 5+/Google chrome 6+ (link), Mozilla Firefox 4+ (disabled by default&nbsp;link) and Opera 11 (disabled by default&nbsp;link), IE 9/10 does not support... but on not supported browsers we can use Flash shim/fallback by adopting&nbsp;web-socket-js.The awesome&nbsp;Can I uses it&nbsp;is&nbsp;maintaining HTML5 new features&nbsp;support&nbsp;in all popular browsers, screenshot below shows WebSocket support:There are also a number of WebSocket servers available:http://socket.io&nbsp; - Provides seamless support for a variety of transports (WebSocket, WebSocket over Flash, XHR polling, JSONP polling, etc.) intended for real-time communication developed by&nbsp;Guillermo Rauch&nbsp;node.ws.js&nbsp;- A simple WebSocket server (support both&nbsp;draft-hixie-thewebsocketprotocol-75 and draft-hixie-thewebsocketprotocol-76) developed based on node.websocket.js.web-socket-js&nbsp;- HTML5 Web Socket implementation powered by Flashhttp://nugget.codeplex.com&nbsp;- A web socket server implemented in C#.jWebSocket.org&nbsp;- The Open Source Java WebSocket Serverphpwebsocket - PHP version of WebSocket server.WebSocket JavaScript APIW3C defined&nbsp;WebSocket interface&nbsp;as below: [Constructor(in DOMString url, in optional DOMString protocols)] [Constructor(in DOMString url, in optional DOMString[] protocols)] interface WebSocket { &nbsp; readonly attribute DOMString url;  &nbsp; // ready state &nbsp; const unsigned short CONNECTING = 0; &nbsp; const unsigned short OPEN = 1; &nbsp; const unsigned short CLOSING = 2; &nbsp; const unsigned short CLOSED = 3; &nbsp; readonly attribute unsigned short readyState; &nbsp; readonly attribute unsigned long bufferedAmount;  &nbsp; // networking &nbsp;&nbsp;attribute Function onopen; &nbsp;&nbsp;attribute Function onmessage; &nbsp;&nbsp;attribute Function onerror; &nbsp;&nbsp;attribute Function onclose; &nbsp; readonly attribute DOMString protocol; &nbsp; void send(in DOMString data); &nbsp; void close(); }; WebSocket implements EventTarget;The url attribute is the WebSocket server Url, the protocol is usually &quot;ws&quot; (for unencrypted plain text WebSocket) or &quot;wss&quot; (for secure WebSocket), send method sends data to server after connected, close is to send close signal, besides there are four important events: onopen, onmessage, onerror and onclose, I borrowed a nice picture below from nettuts.onopen: When a socket has opened, i.e. after TCP three-way handshake and WebSocket handshake.onmessage: When a message has been received from WebSocket server.onerror: Triggered when error occurred.onclose: When a socket has been closed.JavaScript code below is to setup WebSocket connection and retrieve data: var wsUrl = &#39;ws://localhost:8888/DummyPath&#39;; var websocket = new WebSocket(wsUrl); websocket.onopen = function (evt) { onOpen(evt) }; websocket.onclose = function (evt) { onClose(evt) }; websocket.onmessage = function (evt) { onMessage(evt) }; websocket.onerror = function (evt) { onError(evt) };  &nbsp;&nbsp;&nbsp;  function onOpen(evt) { &nbsp;&nbsp;&nbsp; console.log(&quot;Connected to WebSocket server.&quot;); &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; websocket.send(&quot;HTML5 WebSocket rocks!&quot;); } function onClose(evt) { console.log(&quot;Disconnected&quot;); } function onMessage(evt) { &nbsp;&nbsp;&nbsp; console.log(&#39;Retrieved data from server: &#39; + evt.data);  &nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; // Update UI... } function onError(evt) { console.log(&#39;Error occured: &#39; + evt.data); }Develop WebSocket In Action - Team Poker Demo&nbsp;Estimating user story effort by using&nbsp;Planning Poker Cards&nbsp;is well-known and widely used in Agile/Scrum development, Program Manager/Scrum Master prepare user stories beforehand, hold meeting with stake holders and have them play poker to represent one&#39;s estimation on each story, the higher the card value is, the harder to implement, on the contrary, the lower the value is, the easier to implement, &quot;0&quot; indicates &quot;no effort&quot; or &quot;has been done&quot;, &quot;?&quot; indicates &quot;mission impossible&quot; or &quot;unclear requirement&quot;.Actually there is a website - http://pokerplanning.com&nbsp;does the exact work described above, my co-workers and I used it for several times, however, we found it is getting slower and slower as more team members joining the game or after several rounds of voting, we did experience the worst result: no one can vote anymore because everyone&#39;s voting page got stucked.&nbsp;I strongly suspect the major reason for this is its Ajax Polling strategy in order to ensure everyone got real-time voting status. By tracking its network activities I guess I was right.Ajax polling in&nbsp;http://pokerplanning.com:I believe HTML5 WebSocket will solve the problem! So I developed a simple demo (I named it Team Poker) which currently only has limited and basic functionalities described as below:User can login to poker room after inputting his/her nickname.Everyone gets notified when one user players a poker.Everyone gets notified when new player joins.Newly joined player can see the current participants and voting status.The login screenshot for requirement #1:New participant(s), new voted poker(s) status update screenshot for requirement #2 and #3 (please click on the image to enlarge):Newly joined participant(s) can see current game status, story #4:Please note the Team Poker demo is concentrated on&nbsp;demonstrating the power of WebSocket, in real world, player shouldn&#39;t see the poker values played by other players, and there is functionalities like moderator customizing user stories, storing game status on server side, and there is no fancy UI/animation. However, I&#39;ve share all the source code at the beginning of this article, in additional, I&#39;ve uploaded the source code on github: https://github.com/WayneYe/TeamPoker,&nbsp;wish some people make it better and productive, will you fork it with me? Dear reader:).Ok, now coding time, since all clients need to get notified about other client&#39;s changes (new player joining or new poker played), in additional, new joint player needs to know current status, I defined two communication contracts:ClientMessage&nbsp;indicates message sent from client, contains&nbsp;a Type property reflects enumeration class MessageType - NewParticipaint, NewVoteInfo, and a Data property to store data.ServerStatus, stores current playing players as well as current voting status - a hashtable [{PlayerName}, {VoteValue}], broadcast to all clients once receiving new client message. var TeamPoker = TeamPoker || function () { };  TeamPoker.VoteInfo = function (playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } TeamPoker.MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; TeamPoker.ClientMessage = function (type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; TeamPoker.ServerStatus = function () { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus = []; };&nbsp;On client side,&nbsp;a WebSocket connection will be established after user clicking &quot;Login&quot; button, the nickname will be sent to WebSocket server running on nodejs, the kernal client code is shown below: TeamPoker.connectToWsServer = function () { &nbsp;&nbsp;&nbsp; // Init Web Socket connect &nbsp;&nbsp;&nbsp; var WSURI = &quot;ws://192.168.1.6:8888&quot;; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient = new WebSocket(WSURI);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onopen = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Successfully connected to WebSocket server.&#39;); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.joinGame(); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onclose = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Connection closed.&#39;); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onmessage = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;Retrived msg from server: &#39; + evt.data); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TeamPoker.updateGameStatus(evt.data); &nbsp;&nbsp;&nbsp; }; &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.onerror = function (evt) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.log(&#39;An error occured: &#39; + evt.data); &nbsp;&nbsp;&nbsp; }; };  TeamPoker.joinGame = function () { &nbsp;&nbsp;&nbsp; var joinGameMsg = new TeamPoker.ClientMessage(TeamPoker.MessageType.NewParticipaint, TeamPoker.CurrentPlayerName);  &nbsp;&nbsp;&nbsp; TeamPoker.WsClient.send(JSON.stringify(joinGameMsg)); } TeamPoker.updateGameStatus = function (data) { &nbsp;&nbsp;&nbsp; // Format/fill the data from server side to HTML }On server side, one important task is to maintain all active client WebSocket connections so that it can &quot;broadcast&quot; messages to every client, and remove the closed client to avoid sending message to &quot;dead&quot; client. Other than this, the logic is very simple, validate message type sent from client, update players/vote status repository and then broadcast to all client: /* WebSocket server based on https://github.com/ncr/node.ws.js Written By Wayne Ye 6/4/2011 http://wayneye.com */  var sys = require(&quot;sys&quot;), &nbsp;&nbsp;&nbsp; ws = require(&quot;./ws&quot;);  var clients = [], players = [], voteStatus = [];  ws.createServer(function (websocket) { &nbsp;&nbsp;&nbsp; websocket.addListener(&quot;connect&quot;, function (resource) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted after handshake &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;Client connected on path: &quot; + resource);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Add to our list of clients &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.push(websocket);  &nbsp;&nbsp;&nbsp; }).addListener(&quot;data&quot;, function (data) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var clinetMsg = JSON.parse(data);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (clinetMsg.Type) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewParticipaint: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newPlayer = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New Participaint: &#39; + newPlayer); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; players.push(newPlayer);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case MessageType.NewVoteInfo: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var newVoteInfo = clinetMsg.Data; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;New VoteInfo: &#39; + newVoteInfo.PlayerName + &#39; voted &#39; + newVoteInfo.VoteValue); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; voteStatus.push(newVoteInfo); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Notify all clients except the one just sent data &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var serverStatus = new ServerStatus(); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.Players = players; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverStatus.VoteStatus = voteStatus;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var srvMsgData = JSON.stringify(serverStatus);  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&#39;Broadcast server status to all clients: &#39; + srvMsgData); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients[i].write(srvMsgData); &nbsp;&nbsp;&nbsp; }).addListener(&quot;close&quot;, function () { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // emitted when server or client closes connection  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; clients.length; i++) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # Remove from our connections list so we don&#39;t send &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // # to a dead socket &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (clients[i] == websocket) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.debug(&quot;close with client: &quot; + websocket); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clients.splice(i); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp; }); }).listen(8888);  var MessageType = { &nbsp;&nbsp;&nbsp; NewParticipaint: &#39;NewParticipaint&#39;, &nbsp;&nbsp;&nbsp; NewVoteInfo: &#39;NewVoteInfo&#39; }; function ClientMessage(type, data) { &nbsp;&nbsp;&nbsp; this.Type = type; &nbsp;&nbsp;&nbsp; this.Data = data; }; function VoteInfo(playerName, voteValue) { &nbsp;&nbsp;&nbsp; this.PlayerName = playerName; &nbsp;&nbsp;&nbsp; this.VoteValue = voteValue; } function ServerStatus() { &nbsp;&nbsp;&nbsp; this.Players = []; &nbsp;&nbsp;&nbsp; this.VoteStatus &lt;span style=&quot;color: ">
    <meta itemprop="datePublished" content="June 10, 2011">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">HTML5 Web Socket in Essence
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  14 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#">Table of Content</a></li>
  <li><a href="#Introduction">Introduction</a></li>
  <li><a href="#Background">Background</a></li>
  <li><a href="#WebSocketInEssence">WebSocket In Essence</a></li>
  <li><a href="#ExperimentalDemos">Experimental Demos</a></li>
  <li><a href="#BrowserSupport">Browser/Server Support</a></li>
  <li><a href="#WebSocketJavaScriptAPI">WebSocket JavaScript API</a></li>
  <li><a href="#DevelopWebSocketInAction">Develop WebSocket In Action - Team Poker DemoÂ </a></li>
</ul>
            </nav>
          </aside>
        
        <blockquote>
HTML5 WebSocket defines a bi-directional, full-duplex communication channel operates through a single TCP connection, this article discusses its fantastic performance, the WebSocket protocol principle and its handshake mechanism, and develop a WebSocket application in action (Team Poker).
</blockquote>
<p style="text-align:center">
<embed src="http://player.youku.com/player.php/sid/XMjc2ODM2NjU2/v.swf" quality="high" width="480" height="400" align="middle" allowScriptAccess="sameDomain" type="application/x-shockwave-flash"></embed>
<br />
<strong style="color:red">Embeded youku video link because Youtube is outside of the largest "intranet" in the entire universe!!</strong></p>
<h3>Table of Content</h3>
<ol>
<li><a href="#Introduction">Introduction</a></li>
<li><a href="#Background">Background</a></li>
<li><a href="#WebSocketInEssence">WebSocket In Essence</a></li>
<li><a href="#ExperimentalDemos">Experimental Demos</a></li>
<li><a href="#BrowserSupport">Browser Support</a></li>
<li><a href="#WebSocketJavaScriptAPI">WebSocket JavaScript API</a></li>
<li><a href="#DevelopWebSocketInAction">Develop WebSocket In Action - Team Poker</a></li>
<li><a href="#OpenIssues">Open Issues</a></li>
<li><a href="#Conclusion">Conclusion</a></li>
<li><a href="#References">References &amp; Resources</a>&nbsp;</li>
</ol>
<h3 id="Introduction">Introduction</h3>
<p><a title="HTML5 Web Socket" href="http://www.whatwg.org/specs/web-apps/current-work/complete/network.html#network" target="_blank">HTML5 WebSocket</a>&nbsp;defines a bi-directional, full-duplex communication channel that operates through a single TCP socket over the Web, it provides efficient, low-latency and low cost connection between web client and server, based on WebSocket, developers can build&nbsp;<strong>scalable</strong>,&nbsp;<strong>real-time</strong>&nbsp;web applications in the future. Section below is the official definition of WebSocket copied from&nbsp;<a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08" target="_blank">IETF WebSocket protocol</a>&nbsp;page:&nbsp;</p>
<blockquote>
<p>The WebSocket protocol enables two-way communication between a user agent running untrusted code running in a controlled environment to a remote host that has opted-in to communications from that code. &nbsp;The security model used for this is the Origin-based security model commonly used by Web browsers. &nbsp;The protocol consists of an initial handshake followed by basic message framing, layered over TCP. &nbsp;The goal of this technology is to provide a mechanism for browser-based applications that need two-way communication with servers that does not rely on opening multiple HTTP connections (e.g. using XMLHttpRequest or &lt;iframe&gt;s and long polling).</p>
</blockquote>
<p>This article is trying to go through WebSocket basic concept, the problems it is going to solve, explain it in essence,&nbsp;watch some experimental Demos, develop a simple WebSocket&nbsp;application in action (Team Poker), and describe current open issues of WebSocket. I sincerely hope it will be&nbsp;<strong>systematically</strong>,&nbsp;<strong>easy to understand</strong>,&nbsp;<strong>from surface to deep&nbsp;</strong>so that eventually readers would not only learn what WebSocket is from high level but also&nbsp;<strong>understand it in depth!</strong>&nbsp;Any thoughts, suggestions or criticism&nbsp;you may have after reading this article will help me to improve in the future, i would appreciate it if you could leave a comment.</p>
<h3 id="Background">Background</h3>
<p>In traditional web applications, in order to achieve some real-time interaction with server, developers had to employ several tricky ways such as <a href="http://plugins.jquery.com/plugin-tags/polling">Ajax polling</a>,&nbsp;<a title="Comet" href="http://en.wikipedia.org/wiki/Comet_(programming)">Comet</a>&nbsp;(A.K.A <a href="http://en.wikipedia.org/wiki/Ajax_Push">Ajax push</a>,&nbsp;Full Duplex Ajax,&nbsp;HTTP Streaming, etc.),&nbsp;those technologies either periodically fire HTTP requests to server or hold the HTTP connection with server for a long time, which&nbsp;"<strong>contain lots of additional, unnecessary header data and introduce latency</strong>" and resulted in "<strong>an outrageously high price tag</strong>".&nbsp;<a href="http://websocket.org/quantum.html">websocket.org</a> explained the problems exhaustively, compared the performance&nbsp;of Ajax polling and WebSocket in detail, built up two simple web pages, one periodically communicated with server using traditional HTTP and the other used HTML5 WebSocket, in the testing each HTTP&nbsp;request/response header is approximate <strong>871 byte</strong>, while data length of WebSocket connection is much shorter: <strong>2 bytes</strong> after connection established, as the transfer count getting larger, the result will be:</p>
<blockquote>
<p><strong>Traditional HTTP Request&nbsp;</strong></p>
<ul>
<li>
<p class="bodytext"><strong>Use case A</strong>: 1,000 clients polling every second: Network throughput is (871 x 1,000) = 871,000 bytes = 6,968,000 bits per second (6.6 Mbps)</p>
</li>
<li>
<p class="bodytext"><strong>Use case B</strong>: 10,000 clients polling every second: Network throughput is (871 x 10,000) = 8,710,000 bytes = 69,680,000 bits per second (66 Mbps)</p>
</li>
<li>
<p class="bodytext"><strong>Use case C</strong>: 100,000 clients polling every 1 second: Network throughput is (871 x 100,000) = 87,100,000 bytes = 696,800,000 bits per second (665 Mbps)</p>
</li>
</ul>
<p><strong>HTML5 WebSocket</strong></p>
<ul>
<li>
<p class="bodytext"><strong>Use case A</strong>: 1,000 clients receive 1 message per second: Network throughput is (2 x 1,000) = 2,000 bytes = 16,000 bits per second (0.015 Mbps)</p>
</li>
<li>
<p class="bodytext"><strong>Use case B</strong>: 10,000 clients receive 1 message per second: Network throughput is (2 x 10,000) = 20,000 bytes = 160,000 bits per second (0.153 Kbps)</p>
</li>
<li>
<p class="bodytext"><strong>Use case C</strong>: 100,000 clients receive 1 message per second: Network throughput is (2 x 100,000) = 200,000 bytes = 1,600,000 bits per second (1.526 Kbps)</p>
</li>
</ul>
</blockquote>
<p>Finally a more readable diagram:</p>
<p><img title="Polling VS WebSocket" src="http://websocket.org/img/poll-ws-compare.gif" alt="Polling VS WebSocket" width="503" height="360" /></p>
<blockquote>
<p>&nbsp;"HTML5 Web Sockets can provide a 500:1 or &mdash; depending on the size of the HTTP headers &mdash; even a 1000:1 reduction in unnecessary HTTP header traffic and 3:1 reduction in latency". &nbsp;--<a href="http://websocket.org">WebSocket.org</a></p>
</blockquote>
<h3 id="WebSocketInEssence">WebSocket In Essence</h3>
<p>The motivation of creating WebSocket is to replace polling and long polling(Comet), and endow HTML5 web application the ability of real-time communication. Browser based web application can fire WebSocket connection request through JavaScript API, and then transfer data with server <strong>over only one TCP connection</strong>.</p>
<!--more-->
<p>This is achieved by the new protocol - The <strong>WebSocket Protocol</strong>, which is essentially an&nbsp;<strong>independent TCP-based protocol.</strong>&nbsp;To establish a WebSocket connection client/browser forms an HTTP request with "<strong>Upgrade: WebSocket</strong>" header which indicates a protocol upgrade request, and the handshake key(s) will be interpreted by HTTP servers and handshake response will be returned (the detailed handshake mechanism will be described below), afterwards the connection is established (figuratively speaking, the 'sockets' have been plugged in at both client and server ends),&nbsp;both sides can&nbsp;transfer/receive data&nbsp;<strong>independently</strong>, no more redundant header information, and the connection&nbsp;<strong>won't be closed until one side sends close signal</strong>, that's why WebSocket is <strong>bidirectional </strong>and <strong>full duplex</strong>, in additional, comparing the request/response paradigm of HTTP, WebSocket layers a framing mechanism on top on TCP, each data frame is minimally just 2 bytes.  </p>
<p>Now it is time for us to delve deep into this protocol, let's start with WebSocket version <strong><a href="http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76">draft-hixie-thewebsocketprotocol-76</a></strong> which is now supported by browsers (Chrome 6+, Firefox 4+, Opera 11) and many WebSocket servers (please refer to&nbsp;<a href="#BrowserSupport">Browser/Server Support</a>&nbsp;section below for details). A typical WebSocket request/response example is shown below:</p>
<blockquote><strong>Request</strong><br /> GET /demo HTTP/1.1<br />Upgrade: WebSocket<br />Connection: Upgrade<br />Host: example.com<br />Origin: http://example.com<br />Sec-WebSocket-Key1: 4 @1 46546xW%0l 1 5<br />Sec-WebSocket-Key2: 12998 5 Y3 1 .P00<br /> <br />^n:ds[4U&nbsp;<br /> <br /> <strong>Response</strong><br /> HTTP/1.1 101 WebSocket Protocol Handshake<br />Upgrade: WebSocket<br />Connection: Upgrade<br />Sec-WebSocket-Origin: http://example.com<br />Sec-WebSocket-Location: ws://example.com/demo<br />Sec-WebSocket-Protocol: sample<br /> <br />8jKS'y:G*Co,Wxa-&nbsp;</blockquote>
<p>The entire process could be described as: the client raise a "special" HTTP request which request "Upgrade" connecting protocol to "WebSocket", on domain "example.com" with path "/demo", with three "<strong>handshake</strong>" fields:&nbsp;<strong>Sec-WebSocket-Key1</strong>, <strong>Sec-WebSocket-Key2</strong> and&nbsp;<strong>8 bytes</strong> ({^n:ds[4U}) after the fields are random tokens which the WebSocket server uses to construct a <strong>16-byte security hash</strong>&nbsp;at the end of its handshake to prove that it has read the client's handshake.</p>
<p>Since WebSocket protocol is NOT finalized and is being improved and standardized by&nbsp;<a href="http://datatracker.ietf.org/wg/hybi/charter/">IETF Hypertext Bidirectional (HyBi) Working Group</a>,&nbsp;at the time I wrote this article, the latest WebSocket version is "<strong><a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08">draft-ietf-hybi-thewebsocketprotocol-08</a></strong>" lasted updated by<strong> Ian Fette&nbsp;on June 7, 2011</strong>, in which both request/response headers are changed comparing to version 76, the handshake mechanism was changed as well, Sec-WebSocket-Key1 and&nbsp;Sec-WebSocket-Key1 are replaced with one&nbsp;Sec-WebSocket-Key.</p>
<p>WebSocket request/response in the latest&nbsp;<strong>draft-ietf-hybi-thewebsocketprotocol-08:</strong></p>
<blockquote><strong>Request</strong><br />GET /demo HTTP/1.1<br />Host: example.com<br />Upgrade: websocket<br />Connection: Upgrade<br />Sec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==<br />Sec-WebSocket-Origin: http://example.com<br />Sec-WebSocket-Protocol: chat, superchat<br />Sec-WebSocket-Version: 8<br /><br /><strong>Response</strong><br />HTTP/1.1 101 Switching Protocols<br />Upgrade: websocket<br />Connection: Upgrade<br />Sec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=<br />Sec-WebSocket-Protocol: chat</blockquote>
<p>The <strong>Sec-WebSocket-Key</strong> is a base64 encoded randomly generated 16-byte value, in the case above it is "<strong>WebSocket rocks!</strong>", the server reads the key, concats with a magic GUID "258EAFA5-E914-47DA-95CA-C5AB0DC85B11", to "V2ViU29ja2V0IHJvY2tzIQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11", then compute its SHA1 hash, get result "540b8681a34307fade550a467c317c297799c79a", finally based64 encodes the hash and append the value to header "<strong>Sec-WebSocket-Accept</strong>".</p>
<p>I've written C# code below to demonstrate how to compute the Sec-WebSocket-Accept conforming to&nbsp;<strong>draft-ietf-hybi-thewebsocketprotocol-08</strong>:&nbsp;</p>
<pre class="source" style="font-family: '[object HTMLOptionElement]', Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #7f9f7f;">/// <span style="color: #c0c0c0;">&lt;summary&gt;</span></span><br /> <span style="color: #7f9f7f;">/// Computes server security hash for HTML5 WebSocket, handshake mechanism </span><br /> <span style="color: #7f9f7f;">/// based on draft-ietf-hybi-thewebsocketprotocol-08</span><br /> <span style="color: #7f9f7f;">/// <span style="color: #cc99ff;"><a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08#page-27"><span style="color: #cc99ff;">http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-08#page-27</span></a></span></span><br /> <span style="color: #7f9f7f;">/// <span style="color: #c0c0c0;">&lt;/summary&gt;</span></span><br /> <span style="color: #7f9f7f;">/// <span style="color: #c0c0c0;">&lt;param name="secWebSocketKey"&gt;</span>The handshake key "Sec-WebSocket-Key" from client.<span style="color: #c0c0c0;">&lt;/param&gt;</span></span><br /> <span style="color: #7f9f7f;">/// <span style="color: #c0c0c0;">&lt;returns&gt;</span>The computed security hash to fill "Sec-WebSocket-Accept" header.<span style="color: #c0c0c0;">&lt;/returns&gt;</span></span><br /> <span style="color: #e3ceab;">public</span> <span style="color: #e3ceab;">static</span> <span style="color: #dcdccc;">String</span> <span style="color: #efef8f;">ComputeWebSocketHandshakeSecurityHash08</span>(<span style="color: #dcdccc;">String</span> <span style="color: #dcdccc;">secWebSocketKey</span>)<br /> <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">const</span> <span style="color: #dcdccc;">String</span> <span style="color: #dcdccc;">MagicKEY</span> <span style="color: #dcdccc;">=</span> <span style="color: #cc9393;">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">String</span> <span style="color: #dcdccc;">secWebSocketAccept</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">String</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Empty</span>;<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// 1. Combine the request Sec-WebSocket-Key with magic key.</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">String</span> <span style="color: #dcdccc;">ret</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">secWebSocketKey</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">MagicKEY</span>;<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// 2. Compute the SHA1 hash</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">SHA1</span> <span style="color: #dcdccc;">sha</span> <span style="color: #dcdccc;">=</span> <span style="color: #e3ceab;">new</span> <span style="color: #dcdccc;">SHA1CryptoServiceProvider</span>(); <br /> &nbsp;&nbsp;&nbsp; <span style="color: #dfdfbf; font-weight: bold;">byte</span><span style="color: #dcdccc;">[]</span> <span style="color: #dcdccc;">sha1Hash</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">sha</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ComputeHash</span>(<span style="color: #dcdccc;">Encoding</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">UTF8</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">GetBytes</span>(<span style="color: #dcdccc;">ret</span>));<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// 3. Base64 encode the hash</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">secWebSocketAccept</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">Convert</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ToBase64String</span>(<span style="color: #dcdccc;">sha1Hash</span>);<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">return</span> <span style="color: #dcdccc;">secWebSocketAccept</span>;<br /> <span style="color: #dcdccc;">}</span></pre>
<p>Unit test code:</p>
<pre class="source" style="font-family: '[object HTMLOptionElement]', Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #dcdccc;">String</span> <span style="color: #dcdccc;">secWebSocketKey</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">Convert</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ToBase64String</span>(<span style="color: #dcdccc;">Encoding</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">UTF8</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">GetBytes</span>(<span style="color: #cc9393;">"WebSocket rocks!"</span>));<br /> <span style="color: #dcdccc;">Console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WriteLine</span>(<span style="color: #cc9393;">"Sec-WebSocket-Key: {0}"</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">secWebSocketKey</span>);<br /> <br /> <span style="color: #dcdccc;">String</span> <span style="color: #dcdccc;">secWebSocketAccept</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">ComputeWebSocketHandshakeSecurityHash08</span>(<span style="color: #dcdccc;">secWebSocketKey</span>);<br /> <span style="color: #dcdccc;">Console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WriteLine</span>(<span style="color: #cc9393;">"Sec-WebSocket-Accept: "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">secWebSocketAccept</span>);</pre>
<p>We would see the result by running code above:</p>
<pre>Sec-WebSocket-Key: V2ViU29ja2V0IHJvY2tzIQ==<br />Sec-WebSocket-Accept: VAuGgaNDB/reVQpGfDF8KXeZx5o=</pre>
<blockquote>Please note draft-ietf-hybi-thewebsocketprotocol-08 is <strong>NOT supported by any common web browsers since it was just published on June 7, 2011</strong>. However, we can learn it so that we know what is happening now with WebSocket and where it's going in the future.</blockquote>
<h3 id="ExperimentalDemos">Experimental Demos</h3>
<p>So far there are already many experimental WebSocket Demos built based on either draft-hixie-thewebsocketprotocol-75&nbsp;or&nbsp;draft-hixie-thewebsocketprotocol-76.<br /><br /><a href="http://rumpetroll.com/" target="_blank">http://rumpetroll.com/</a>&nbsp;<br />Play a tadpole in canvas and can chat with other tadpoles, tadpoles location and char messages could be seen by everyone in real-time. <br /><br /><a href="http://html5labs.interoperabilitybridges.com/prototypes/websockets/websockets/info">http://html5labs.interoperabilitybridges.com/prototypes/websockets/websockets/info</a>&nbsp;<br />WebSocket Demos in Microsoft HTML5 Labs<br /><br /> <a href="http://html5demos.com/web-socket">http://html5demos.com/web-socket<br /></a>A very simple "Chat room" demo using WebSocket.<br /> <br /> <a href="http://kaazing.me/">http://kaazing.me/<br /></a>Refresh stock, weather, news and twits in real-time powered by Kaazing's real-time message delivery network solution.<br /> <br /><a href="http://mrdoob.com/projects/multiuserpad/">Mr. Doob's Multiuser Sketchpad<br /></a>In this multi-user&nbsp;<code>&lt;canvas&gt;</code>&nbsp;drawing application, Web Sockets are used to pass along the coordinates of the lines that other users draw back to each client as they happen.</p>
<p>And so on.. You will also see <a href="#DevelopWebSocketInAction">a simple demo developed by me below</a>.</p>
<h3 id="BrowserSupport">Browser/Server Support</h3>
<p>WebSocket is not only designed for browser/server communication, client application can also use it. However, I guess browser will still be the major platform for WebSocket protocol taken into account the emerging handsets and the coming cloud. At the time I wrote this article, WebSocket protocol version draft-ietf-hybi-thewebsocketprotocol-76 was supported by Safari 5+/Google chrome 6+ (<a href="http://www.google.com/url?sa=t&amp;source=web&amp;cd=2&amp;sqi=2&amp;ved=0CCgQFjAB&amp;url=http%3A%2F%2Fblog.chromium.org%2F2010%2F06%2Fwebsocket-protocol-updated.html&amp;ei=6dPsTej1LoeiuQP74_G4Dw&amp;usg=AFQjCNE1pV7Gkebr-GFivY1eocAz1LqkgQ&amp;sig2=NUv_2j1YIz5j8rMdPH5PtQ">link</a>), Mozilla Firefox 4+ (disabled by default&nbsp;<a href="https://developer.mozilla.org/en/WebSockets">link</a>) and Opera 11 (disabled by default&nbsp;<a href="http://my.opera.com/core/blog/websockets">link</a>), IE 9/10 does not support... but on not supported browsers we can use Flash shim/fallback by adopting&nbsp;<a href="https://github.com/gimite/web-socket-js" rel="nofollow">web-socket-js</a>.</p>
<p>The awesome&nbsp;<a href="http://caniuse.com/#search=websocket">Can I uses it</a>&nbsp;is&nbsp;maintaining HTML5 new features&nbsp;support&nbsp;in all popular browsers, screenshot below shows WebSocket support:</p>
<p><a title="Click to enlarge" href="http://a1rvha.bay.livefilestore.com/y1p6ecKygtANGqAnIDS7zapwe9zUQgFB__gBeXmF6VF-dKBRn__thLJh3puXV-2rToxke3ufkf3ZLSXkUjBzfMo9DHPSRlvKoo8/WebSocketBrowsersupport.png?psid=1"><img title="WebSocket Browser Support Table" src="http://a1rvha.bay.livefilestore.com/y1p6ecKygtANGqAnIDS7zapwe9zUQgFB__gBeXmF6VF-dKBRn__thLJh3puXV-2rToxke3ufkf3ZLSXkUjBzfMo9DHPSRlvKoo8/WebSocketBrowsersupport.png?psid=1" alt="WebSocket Browser Support Table" width="640" height="212" /></a></p>
<p>There are also a number of WebSocket servers available:</p>
<p><a href="http://socket.io">http://socket.io</a>&nbsp; - Provides seamless support for a variety of transports (WebSocket, WebSocket over Flash, XHR polling, JSONP polling, etc.) intended for real-time communication developed by&nbsp;<a href="http://devthought.com/">Guillermo Rauch</a>&nbsp;</p>
<p><a href="https://github.com/ncr/node.ws.js">node.ws.js</a>&nbsp;- A simple WebSocket server (support both&nbsp;<span class="Apple-style-span" style="white-space: pre;">draft-hixie-thewebsocketprotocol-75 and </span><span class="Apple-style-span" style="white-space: pre;">draft-hixie-thewebsocketprotocol-76</span>) developed based on <a href="http://github.com/Guille/node.websocket.js">node.websocket.js</a>.</p>
<p><a href="https://github.com/gimite/web-socket-js" rel="nofollow">web-socket-js</a>&nbsp;- HTML5 Web Socket implementation powered by Flash</p>
<p><a href="http://nugget.codeplex.com/">http://nugget.codeplex.com</a>&nbsp;- A web socket server implemented in C#.</p>
<p><a href="http://jWebSocket">jWebSocket.org</a>&nbsp;- The Open Source Java WebSocket Server</p>
<p><a href="http://code.google.com/p/phpwebsocket">phpwebsocket</a> - PHP version of WebSocket server.</p>
<h3 id="WebSocketJavaScriptAPI">WebSocket JavaScript API</h3>
<p>W3C defined&nbsp;<a href="http://www.w3.org/TR/websockets/#the-websocket-interface">WebSocket interface</a>&nbsp;as below:</p>
<pre class="source" style="font-family: Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #dcdccc;">[</span><span style="color: #dcdccc;">Constructor</span>(<span style="color: #e3ceab;">in</span> <span style="color: #dcdccc;">DOMString</span> <span style="color: #dcdccc;">url</span><span style="color: #dcdccc;">,</span> <span style="color: #e3ceab;">in</span> <span style="color: #dcdccc;">optional</span> <span style="color: #dcdccc;">DOMString</span> <span style="color: #dcdccc;">protocols</span><span style="color: #dcdccc;">)]</span><br /> <span style="color: #dcdccc;">[</span><span style="color: #dcdccc;">Constructor</span>(<span style="color: #e3ceab;">in</span> <span style="color: #dcdccc;">DOMString</span> <span style="color: #dcdccc;">url</span><span style="color: #dcdccc;">,</span> <span style="color: #e3ceab;">in</span> <span style="color: #dcdccc;">optional</span> <span style="color: #dcdccc;">DOMString</span><span style="color: #dcdccc;">[]</span> <span style="color: #dcdccc;">protocols</span><span style="color: #dcdccc;">)]</span><br /> <span style="color: #e3ceab;">interface</span> <span style="color: #dcdccc;">WebSocket</span> <span style="color: #dcdccc;">{</span><br /> &nbsp; <span style="color: #dcdccc;">readonly</span> <span style="color: #dcdccc;">attribute</span> <span style="color: #dcdccc;">DOMString</span> <span style="color: #dcdccc;">url</span>;<br /> <br /> &nbsp; <span style="color: #7f9f7f;">// ready state</span><br /> &nbsp; <span style="color: #e3ceab;">const</span> <span style="color: #dcdccc;">unsigned</span> <span style="color: #e3ceab;">short</span> <span style="color: #dcdccc;">CONNECTING</span> <span style="color: #dcdccc;">=</span> <span style="color: #8cd0d3;">0</span>;<br /> &nbsp; <span style="color: #e3ceab;">const</span> <span style="color: #dcdccc;">unsigned</span> <span style="color: #e3ceab;">short</span> <span style="color: #dcdccc;">OPEN</span> <span style="color: #dcdccc;">=</span> <span style="color: #8cd0d3;">1</span>;<br /> &nbsp; <span style="color: #e3ceab;">const</span> <span style="color: #dcdccc;">unsigned</span> <span style="color: #e3ceab;">short</span> <span style="color: #dcdccc;">CLOSING</span> <span style="color: #dcdccc;">=</span> <span style="color: #8cd0d3;">2</span>;<br /> &nbsp; <span style="color: #e3ceab;">const</span> <span style="color: #dcdccc;">unsigned</span> <span style="color: #e3ceab;">short</span> <span style="color: #dcdccc;">CLOSED</span> <span style="color: #dcdccc;">=</span> <span style="color: #8cd0d3;">3</span>;<br /> &nbsp; <span style="color: #dcdccc;">readonly</span> <span style="color: #dcdccc;">attribute</span> <span style="color: #dcdccc;">unsigned</span> <span style="color: #e3ceab;">short</span> <span style="color: #dcdccc;">readyState</span>;<br /> &nbsp; <span style="color: #dcdccc;">readonly</span> <span style="color: #dcdccc;">attribute</span> <span style="color: #dcdccc;">unsigned</span> <span style="color: #e3ceab;">long</span> <span style="color: #dcdccc;">bufferedAmount</span>;<br /> <br /> &nbsp; <span style="color: #7f9f7f;">// networking</span><br /> &nbsp;&nbsp;<span style="color: #dcdccc;">attribute</span> <span style="color: #f0dfaf; font-weight: bold;">Function</span> <span style="color: #dcdccc;">onopen</span>;<br /> &nbsp;&nbsp;<span style="color: #dcdccc;">attribute</span> <span style="color: #f0dfaf; font-weight: bold;">Function</span> <span style="color: #dcdccc;">onmessage</span>;<br /> &nbsp;&nbsp;<span style="color: #dcdccc;">attribute</span> <span style="color: #f0dfaf; font-weight: bold;">Function</span> <span style="color: #dcdccc;">onerror</span>;<br /> &nbsp;&nbsp;<span style="color: #dcdccc;">attribute</span> <span style="color: #f0dfaf; font-weight: bold;">Function</span> <span style="color: #dcdccc;">onclose</span>;<br /> &nbsp; <span style="color: #dcdccc;">readonly</span> <span style="color: #dcdccc;">attribute</span> <span style="color: #dcdccc;">DOMString</span> <span style="color: #dcdccc;">protocol</span>;<br /> &nbsp; <span style="color: #e3ceab;">void</span> <span style="color: #dcdccc;">send</span>(<span style="color: #e3ceab;">in</span> <span style="color: #dcdccc;">DOMString</span> <span style="color: #dcdccc;">data</span>);<br /> &nbsp; <span style="color: #e3ceab;">void</span> <span style="color: #dcdccc;">close</span>();<br /> <span style="color: #dcdccc;">};</span><br /> <span style="color: #dcdccc;">WebSocket</span> <span style="color: #e3ceab;">implements</span> <span style="color: #dcdccc;">EventTarget</span>;</pre>
<p>The <em>url </em>attribute is the WebSocket server Url, the <em>protocol </em>is usually "ws" (for unencrypted plain text WebSocket) or "wss" (for secure WebSocket), <em>send</em> method sends data to server after connected, <em>close </em>is to send close signal, besides there are four important events: onopen, onmessage, onerror and onclose, I borrowed a nice picture below from <a href="http://net.tutsplus.com/tutorials/javascript-ajax/start-using-html5-websockets-today/">nettuts</a>.</p>
<p><img title="WebSocket Events" src="http://d2o0t5hpnwv4c1.cloudfront.net/751_webSocketsStarter/events.jpg" alt="WebSocket Events" width="600" height="300" /></p>
<ul>
<li><strong>onopen</strong>: When a socket has opened, i.e. after TCP three-way handshake and WebSocket handshake.</li>
<li><strong>onmessage</strong>: When a message has been received from WebSocket server.</li>
<li><strong>onerror</strong>: Triggered when error occurred.</li>
<li><strong>onclose</strong>: When a socket has been closed.</li>
</ul>
<p>JavaScript code below is to setup WebSocket connection and retrieve data:</p>
<pre class="source" style="font-family: Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">wsUrl</span> <span style="color: #dcdccc;">=</span> <span style="color: #cc9393;">'ws://localhost:8888/DummyPath'</span>;<br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">websocket</span> <span style="color: #dcdccc;">=</span> <span style="color: #e3ceab;">new</span> <span style="color: #dcdccc;">WebSocket</span>(<span style="color: #dcdccc;">wsUrl</span>);<br /> <span style="color: #dcdccc;">websocket</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onopen</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span> <span style="color: #dcdccc;">onOpen</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">};</span><br /> <span style="color: #dcdccc;">websocket</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onclose</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span> <span style="color: #dcdccc;">onClose</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">};</span><br /> <span style="color: #dcdccc;">websocket</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onmessage</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span> <span style="color: #dcdccc;">onMessage</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">};</span><br /> <span style="color: #dcdccc;">websocket</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onerror</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span> <span style="color: #dcdccc;">onError</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">};</span><br /> <br /> &nbsp;&nbsp;&nbsp; <br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">onOpen</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">"Connected to WebSocket server."</span>);<br /> &nbsp;&nbsp;&nbsp; <br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">websocket</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">send</span>(<span style="color: #cc9393;">"HTML5 WebSocket rocks!"</span>);<br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">onClose</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span> <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">"Disconnected"</span>); <span style="color: #dcdccc;">}</span><br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">onMessage</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">'Retrieved data from server: '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span>); <br /> &nbsp;&nbsp;&nbsp; <br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// Update UI...</span><br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">onError</span>(<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span> <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">'Error occured: '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span>); <span style="color: #dcdccc;">}</span></pre>
<h3 id="DevelopWebSocketInAction">Develop WebSocket In Action - Team Poker Demo<span class="Apple-style-span" style="font-size: 10px; font-weight: normal;">&nbsp;</span></h3>
<p>Estimating user story effort by using&nbsp;<a href="http://www.crisp.se/planningpoker/">Planning Poker Cards</a>&nbsp;is well-known and widely used in Agile/Scrum development, Program Manager/Scrum Master prepare user stories beforehand, hold meeting with stake holders and have them play poker to represent one's estimation on each story, the higher the card value is, the harder to implement, on the contrary, the lower the value is, the easier to implement, "0" indicates "no effort" or "has been done", "?" indicates "mission impossible" or "unclear requirement".</p>
<p>Actually there is a website - <a title="Poker Planning" href="http://pokerplanning.com">http://pokerplanning.com</a>&nbsp;does the exact work described above, my co-workers and I used it for several times, however, we found it is getting slower and slower as more team members joining the game or after several rounds of voting, we did experience the worst result: no one can vote anymore because everyone's voting page got stucked.&nbsp;I strongly suspect the major reason for this is its Ajax Polling strategy in order to ensure everyone got real-time voting status. By tracking its network activities I guess I was right.</p>
<p>Ajax polling in&nbsp;<a title="Poker Planning" href="http://pokerplanning.com">http://pokerplanning.com</a>:<br /><img title="Ajax Polling" src="http://a1rvha.bay.livefilestore.com/y1pa2JzUcKtaGjtoIXjpWoiEA17Mq5w75kRsegCjqdvOZ_G4GoKzbzy6wol_zvpR09erNYzURiWOedM3paxsWSNGVSoebfN5VH4/AJaxPolling.png?psid=1" alt="Ajax Polling" width="640" height="318" /></p>
<p>I believe HTML5 WebSocket will solve the problem! So I developed a simple demo (I named it <strong>Team Poker</strong>) which currently only has limited and basic functionalities described as below:</p>
<ol>
<li>User can login to poker room after inputting his/her nickname.</li>
<li>Everyone gets notified when one user players a poker.</li>
<li>Everyone gets notified when new player joins.</li>
<li>Newly joined player can see the current participants and voting status.</li>
</ol>
<p>The login screenshot for requirement #1:</p>
<p><img title="TeamPoker - Login" src="http://a1rvha.bay.livefilestore.com/y1pPoZ5fyE2aQNYii7Ebnl1A4FljhylbIQVLX4XXz_zKuXnGerroSBQJr7pcograDIZOPuJz_s2j4I7OWoEjhpwIbOCLsHMltiR/TeamPoker-Login.png?psid=1" alt="TeamPoker - Login" width="640" height="516" /></p>
<p>New participant(s), new voted poker(s) status update screenshot for requirement #2 and #3 (please click on the image to enlarge):</p>
<p><a title="Click to enlarge" href="http://a1rvha.bay.livefilestore.com/y1plgEc-4xlEcANc_McjugrixSwHuleRSc0sxEm8W4nShfEECx50rK_9cpvZcgbG85R5V38tq-EuJgMksFGbwVjnhwr-mk6DfI0/TeamPoker-Vote.png?psid=1"><img title="TeamPoker - Voting - Click to enlarge" src="http://a1rvha.bay.livefilestore.com/y1plgEc-4xlEcANc_McjugrixSwHuleRSc0sxEm8W4nShfEECx50rK_9cpvZcgbG85R5V38tq-EuJgMksFGbwVjnhwr-mk6DfI0/TeamPoker-Vote.png?psid=1" alt="TeamPoker - Voting" width="640" height="317" /></a></p>
<p>Newly joined participant(s) can see current game status, story #4:</p>
<p><a href="http://a1rvha.bay.livefilestore.com/y1pMaywJvAp-OoJh6hHJGO31UGfYqJu0n9z0tGGWBRCu5jS0PKE61qepvIoBge326IVyencTn8kCPk5AoQj4fkZzPxbFFPasFYC/TeamPoker-VoteFinished.png?psid=1" title="Click to enlarge"><img title="TeamPoker-Vote Status" src="http://a1rvha.bay.livefilestore.com/y1pMaywJvAp-OoJh6hHJGO31UGfYqJu0n9z0tGGWBRCu5jS0PKE61qepvIoBge326IVyencTn8kCPk5AoQj4fkZzPxbFFPasFYC/TeamPoker-VoteFinished.png?psid=1" alt="TeamPoker-Vote Status" width="640" height="337" /></a></p>
<blockquote>
<p>Please note the Team Poker demo is concentrated on&nbsp;demonstrating the power of WebSocket, in real world, player shouldn't see the poker values played by other players, and there is functionalities like moderator customizing user stories, storing game status on server side, and there is no fancy UI/animation. However, I've share all the source code at the beginning of this article, in additional, I've uploaded the source code on github: <a href="https://github.com/WayneYe/TeamPoker">https://github.com/WayneYe/TeamPoker</a>,&nbsp;wish some people make it better and productive, will you fork it with me? Dear reader:).</p>
</blockquote>
<p>Ok, now coding time, since all clients need to get notified about other client's changes (new player joining or new poker played), in additional, new joint player needs to know current status, I defined two communication contracts:</p>
<ul>
<li><em>ClientMessage</em>&nbsp;indicates message sent from client, contains&nbsp;a Type property reflects enumeration class <em>MessageType - NewParticipaint, NewVoteInfo, and a Data</em> property to store data<em>.</em></li>
<li><em>ServerStatus</em>, stores current playing players as well as current voting status - a hashtable [{PlayerName}, {VoteValue}], broadcast to all clients once receiving new client message.</li>
</ul>
<pre class="source" style="font-family: Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">TeamPoker</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">TeamPoker</span> || <span style="color: #efefaf; font-weight: bold;">function</span> () <span style="color: #dcdccc;">{</span> <span style="color: #dcdccc;">};</span><br /> <br /> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">VoteInfo</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">playerName</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">voteValue</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">PlayerName</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">playerName</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">VoteValue</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">voteValue</span>;<br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">MessageType</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">NewParticipaint</span><span style="color: #dcdccc;">:</span> <span style="color: #cc9393;">'NewParticipaint'</span><span style="color: #dcdccc;">,</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">NewVoteInfo</span><span style="color: #dcdccc;">:</span> <span style="color: #cc9393;">'NewVoteInfo'</span><br /> <span style="color: #dcdccc;">};</span><br /> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ClientMessage</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">type</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">data</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Type</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">type</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Data</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">data</span>;<br /> <span style="color: #dcdccc;">};</span><br /> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ServerStatus</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> () <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Players</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">[];</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">VoteStatus</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">[];</span><br /> <span style="color: #dcdccc;">};</span></pre>
<p>&nbsp;On client side,&nbsp;a WebSocket connection will be established after user clicking "Login" button, the nickname will be sent to WebSocket server running on nodejs, the kernal client code is shown below:</p>
<pre class="source" style="font-family: Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">connectToWsServer</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> () <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// Init Web Socket connect</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">WSURI</span> <span style="color: #dcdccc;">=</span> <span style="color: #cc9393;">"ws://192.168.1.6:8888"</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WsClient</span> <span style="color: #dcdccc;">=</span> <span style="color: #e3ceab;">new</span> <span style="color: #dcdccc;">WebSocket</span>(<span style="color: #dcdccc;">WSURI</span>);<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WsClient</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onopen</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">'Successfully connected to WebSocket server.'</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">joinGame</span>();<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">};</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WsClient</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onclose</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">'Connection closed.'</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">};</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WsClient</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onmessage</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">'Retrived msg from server: '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">updateGameStatus</span>(<span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">};</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WsClient</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">onerror</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">evt</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">console</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">log</span>(<span style="color: #cc9393;">'An error occured: '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">evt</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">data</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">};</span><br /> <span style="color: #dcdccc;">};</span><br /> <br /> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">joinGame</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> () <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">joinGameMsg</span> <span style="color: #dcdccc;">=</span> <span style="color: #e3ceab;">new</span> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">ClientMessage</span>(<span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">MessageType</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">NewParticipaint</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">CurrentPlayerName</span>);<br /> <br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">WsClient</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">send</span>(<span style="color: #dcdccc;">JSON</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">stringify</span>(<span style="color: #dcdccc;">joinGameMsg</span>));<br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #dcdccc;">TeamPoker</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">updateGameStatus</span> <span style="color: #dcdccc;">=</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">data</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// Format/fill the data from server side to HTML</span><br /> <span style="color: #dcdccc;">}</span></pre>
<p>On server side, one important task is to maintain all active client WebSocket connections so that it can "broadcast" messages to every client, and remove the closed client to avoid sending message to "dead" client. Other than this, the logic is very simple, validate message type sent from client, update players/vote status repository and then broadcast to all client:</p>
<pre class="source" style="font-family: Consolas, 'Lucida Console', 'Courier New'; color: #dcdccc; background-color: #3f3f3f;"> <span style="color: #7f9f7f;">/*</span><br /> <span style="color: #7f9f7f;">WebSocket server based on</span><br /> <span style="color: #7f9f7f;">https://github.com/ncr/node.ws.js</span><br /> <span style="color: #7f9f7f;">Written By Wayne Ye 6/4/2011</span><br /> <span style="color: #7f9f7f;">http://wayneye.com</span><br /> <span style="color: #7f9f7f;">*/</span><br /> <br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">sys</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">require</span>(<span style="color: #cc9393;">"sys"</span><span style="color: #dcdccc;">),</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">ws</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">require</span>(<span style="color: #cc9393;">"./ws"</span>);<br /> <br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">clients</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">[],</span> <span style="color: #dcdccc;">players</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">[],</span> <span style="color: #dcdccc;">voteStatus</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">[];</span><br /> <br /> <span style="color: #dcdccc;">ws</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">createServer</span>(<span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">websocket</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">websocket</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">addListener</span>(<span style="color: #cc9393;">"connect"</span><span style="color: #dcdccc;">,</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">resource</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// emitted after handshake</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">sys</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">debug</span>(<span style="color: #cc9393;">"Client connected on path: "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">resource</span>);<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// # Add to our list of clients</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">clients</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">push</span>(<span style="color: #dcdccc;">websocket</span>); <br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}).</span><span style="color: #dcdccc;">addListener</span>(<span style="color: #cc9393;">"data"</span><span style="color: #dcdccc;">,</span> <span style="color: #efefaf; font-weight: bold;">function</span> (<span style="color: #dcdccc;">data</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">clinetMsg</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">JSON</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">parse</span>(<span style="color: #dcdccc;">data</span>);<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">switch</span> (<span style="color: #dcdccc;">clinetMsg</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Type</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">case</span> <span style="color: #dcdccc;">MessageType</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">NewParticipaint</span><span style="color: #dcdccc;">:</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">newPlayer</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">clinetMsg</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Data</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">sys</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">debug</span>(<span style="color: #cc9393;">'New Participaint: '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">newPlayer</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">players</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">push</span>(<span style="color: #dcdccc;">newPlayer</span>);<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">break</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">case</span> <span style="color: #dcdccc;">MessageType</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">NewVoteInfo</span><span style="color: #dcdccc;">:</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">newVoteInfo</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">clinetMsg</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Data</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">sys</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">debug</span>(<span style="color: #cc9393;">'New VoteInfo: '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">newVoteInfo</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">PlayerName</span> <span style="color: #dcdccc;">+</span> <span style="color: #cc9393;">' voted '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">newVoteInfo</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">VoteValue</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">voteStatus</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">push</span>(<span style="color: #dcdccc;">newVoteInfo</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">break</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">default</span><span style="color: #dcdccc;">:</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">break</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// Notify all clients except the one just sent data</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">serverStatus</span> <span style="color: #dcdccc;">=</span> <span style="color: #e3ceab;">new</span> <span style="color: #dcdccc;">ServerStatus</span>();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">serverStatus</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Players</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">players</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">serverStatus</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">VoteStatus</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">voteStatus</span>;<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">srvMsgData</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">JSON</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">stringify</span>(<span style="color: #dcdccc;">serverStatus</span>);<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">sys</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">debug</span>(<span style="color: #cc9393;">'Broadcast server status to all clients: '</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">srvMsgData</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">for</span> (<span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">i</span> <span style="color: #dcdccc;">=</span> <span style="color: #8cd0d3;">0</span>; <span style="color: #dcdccc;">i</span> <span style="color: #dcdccc;">&lt;</span> <span style="color: #dcdccc;">clients</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">length</span>; <span style="color: #dcdccc;">i</span><span style="color: #dcdccc;">++</span>)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">clients</span><span style="color: #dcdccc;">[</span><span style="color: #dcdccc;">i</span><span style="color: #dcdccc;">].</span><span style="color: #dcdccc;">write</span>(<span style="color: #dcdccc;">srvMsgData</span>);<br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}).</span><span style="color: #dcdccc;">addListener</span>(<span style="color: #cc9393;">"close"</span><span style="color: #dcdccc;">,</span> <span style="color: #efefaf; font-weight: bold;">function</span> () <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// emitted when server or client closes connection</span><br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">for</span> (<span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">i</span> <span style="color: #dcdccc;">=</span> <span style="color: #8cd0d3;">0</span>; <span style="color: #dcdccc;">i</span> <span style="color: #dcdccc;">&lt;</span> <span style="color: #dcdccc;">clients</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">length</span>; <span style="color: #dcdccc;">i</span><span style="color: #dcdccc;">++</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// # Remove from our connections list so we don't send</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #7f9f7f;">// # to a dead socket</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">if</span> (<span style="color: #dcdccc;">clients</span><span style="color: #dcdccc;">[</span><span style="color: #dcdccc;">i</span><span style="color: #dcdccc;">]</span> <span style="color: #dcdccc;">==</span> <span style="color: #dcdccc;">websocket</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">sys</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">debug</span>(<span style="color: #cc9393;">"close with client: "</span> <span style="color: #dcdccc;">+</span> <span style="color: #dcdccc;">websocket</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">clients</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">splice</span>(<span style="color: #dcdccc;">i</span>);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">break</span>;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">}</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">});</span><br /> <span style="color: #dcdccc;">}).</span><span style="color: #dcdccc;">listen</span>(<span style="color: #8cd0d3;">8888</span>);<br /> <br /> <span style="color: #efefaf; font-weight: bold;">var</span> <span style="color: #dcdccc;">MessageType</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">NewParticipaint</span><span style="color: #dcdccc;">:</span> <span style="color: #cc9393;">'NewParticipaint'</span><span style="color: #dcdccc;">,</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #dcdccc;">NewVoteInfo</span><span style="color: #dcdccc;">:</span> <span style="color: #cc9393;">'NewVoteInfo'</span><br /> <span style="color: #dcdccc;">};</span><br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">ClientMessage</span>(<span style="color: #dcdccc;">type</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">data</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Type</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">type</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Data</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">data</span>;<br /> <span style="color: #dcdccc;">};</span><br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">VoteInfo</span>(<span style="color: #dcdccc;">playerName</span><span style="color: #dcdccc;">,</span> <span style="color: #dcdccc;">voteValue</span>) <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">PlayerName</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">playerName</span>;<br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">VoteValue</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">voteValue</span>;<br /> <span style="color: #dcdccc;">}</span><br /> <span style="color: #efefaf; font-weight: bold;">function</span> <span style="color: #dcdccc;">ServerStatus</span>() <span style="color: #dcdccc;">{</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">Players</span> <span style="color: #dcdccc;">=</span> <span style="color: #dcdccc;">[];</span><br /> &nbsp;&nbsp;&nbsp; <span style="color: #e3ceab;">this</span><span style="color: #dcdccc;">.</span><span style="color: #dcdccc;">VoteStatus</span> <span style="color: 

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#hack" class="page__taxonomy-item" rel="tag">Hack</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hack" class="page__taxonomy-item" rel="tag">Hack</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2011-06-10T00:00:00-07:00">June 10, 2011</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=wayneye&text=HTML5+Web+Socket+in+Essence%20https%3A%2F%2Fwayneye.com%2FHTML5-Web-Socket-In-Essence" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwayneye.com%2FHTML5-Web-Socket-In-Essence" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwayneye.com%2FHTML5-Web-Socket-In-Essence" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/Ajax-Cross-Origin-HTTP-request" class="pagination--pager" title="AJAX Cross-Origin HTTP request
">Previous</a>
    
    
      <a href="/Healing-The-Abandoned-Children" class="pagination--pager" title="å¸®åŠ©è¿™äº›è¢«é—å¼ƒçš„å­©å­ - ä»Žèº«è¾¹å¾®å°çš„äº‹åšèµ·
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Apply-UK-Visit-VISA" rel="permalink">Apply UK Visit VISA
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Background

I was planning to attend #adskfootball2019 in Dublin, Ireland from Jun 14th to Jun 16th, 2019:

    
    Autodesk Football Tournament 2019


In order to attend, I needed applying Ireland VISA, and since I was planning to fly back to Shanghai later in June, so I thought I could just fly from SF to Dublin, then Dublin to Shanghai, and soon I realized that there is no direct flight from DUB to PVG, so a practical (and also very fun and economic) option is to fly from Dublin to London, and then London to Shanghai, bingo ^_^

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Master-AWS-Development-Video-Published" rel="permalink">Master AWS Development Video Published
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Publishing information

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/self-improvement/passing-aws-certified-solutions-architect/" rel="permalink">Passing AWS Certified Solutions Architect
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/geek/Storage-Media-Home-Server-Less-Than-300/" rel="permalink">Storage+Media home server for less than $300
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Background

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="mailto:admin@wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
        
          <li><a href="https://wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> Website</a></li>
        
      
        
          <li><a href="https://twitter.com/wayneye" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://facebook.com/WayneYeDotCom" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
        
      
        
          <li><a href="https://github.com/WayneYe/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Wayne Ye. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "https://wayneye.com/HTML5-Web-Socket-In-Essence";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/HTML5-Web-Socket-in-Essence"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://wayneye.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
