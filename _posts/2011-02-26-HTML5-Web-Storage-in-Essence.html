---
title: HTML5 Web Storage in Essence
categories:
  - Hack
tags:
  - Hack
permalink: HTML5-Web-Storage-In-Essence
---

<h2>Background </h2>

<p><strong>Web Storage</strong> (also named Dom storage) is a brand new mechanism of storing temporary/permanent data introduced in HTML5 to replace cookie, it contains two new DOM objects: <strong>sessionStoragy</strong> and <strong>localStorage</strong>), in <a title="Web Storage Spec" href="http://dev.w3.org/html5/webstorage/" target="_blank">Web Storage Spec</a>, Ian Hickson documented that Web Storage are intended to solve two cases that &quot;<strong>not handled well by </strong><a href="http://tools.ietf.org/html/draft-ietf-httpstate-cookie" target="_blank"><strong>Cookie</strong></a>&quot;, they are:</p>

<ol>
  <li>The first is designed for scenarios where the user is carrying out a single transaction, but could be carrying out multiple transactions in different windows at the same time. 
    <br /></li>

  <li>The second storage mechanism is designed for storage that spans multiple windows, and lasts beyond the current session. In particular, Web applications may wish to store megabytes of user data, such as entire user-authored documents or a user's mailbox, on the client side for performance reasons. </li>
</ol>

<p>sessionStorage and localStorage are introduced by W3 in HTML5 to solve problems above, let's begin with a review of how Cookie currently works.</p>

<br />

<h2>Current HTTP State Storage â€“ <a href="http://tools.ietf.org/html/draft-ietf-httpstate-cookie" target="_blank">Cookie</a></h2>

<h3>Mechanism </h3>

<p>An HTTP Cookie was a set of key/value pairs which an HTTP web server requests a concrete client browser (i.e. User Agent - UA) to store on client's hard disk, when the UA request to the web server further, UA will wrap all the cookie data within the HTTP request header as long as following conditions are all satisfied:</p>

<ol>
  <li>The cookie data has not expired. </li>

  <li>The requested <em>domain</em> is under exactly the same domain when cookie was stored. </li>

  <li>The requested <em>path</em> under the domain is the same one where cookie was stored. </li>
</ol>

<p>Once the cookie expires, browser will delete it from local hard disk.</p>

<p>A common cookie example:</p>

<ol>
  <li>An end user types <a href="http://www.foo.net">www.foo.net</a> in a browser's navigation bar and hit enter. </li>

  <li><a href="http://www.foo.net">www.foo.net</a> returns HTTP status 200 message below (In the <span style="color: green">Green part</span>, web server expected client browser to store two Cookie key/value pairs: <strong>WayneKey1=value1;WayneKey2=Value2</strong>, they could be accessible from the entire domain, and they will expire after 1 year): 

    <br />

    <div style="border-bottom: thin solid; border-left: thin solid; padding-bottom: 0px; padding-left: 1em; width: 640px; padding-right: 1em; border-top: thin solid; border-right: thin solid; padding-top: 0px">
      <p><tt><font size="2">HTTP/1.1 200 OK 
            <br />Content-type: text/html 

            <br /><span style="color: green">Set-Cookie: WayneKey1=value1;WayneKey2=Value2;domain=www.foo.net; expires=Tue, 24-Feb-2012 07:13:22 GMT; path=/; HttpOnly</span> 

            <br />&#160; <br />(Response HTTP body)</font></tt></p>
    </div>
  </li>
$More$
  <li>Browser received the HTTP response and stored the cookie key/values in plaint text into user's hard disk. </li>

  <li>User did some interactions and requested back <a href="http://www.foo.net">www.foo.net</a>, browser will wrap the cookie data into request HTTP header. 

    <br />

    <div style="border-bottom: thin solid; border-left: thin solid; padding-bottom: 0px; padding-left: 1em; width: 640px; padding-right: 1em; border-top: thin solid; border-right: thin solid; padding-top: 0px">
      <p><tt><font size="2">GET /Index.aspx HTTP 1.1 
            <br />HOST: <a href="http://www.foo.net">www.foo.net</a></font></tt><tt><font size="2"> 
            <br />Accept: *.* 

            <br /><span style="color: green">Cookie: WayneKey1=value1;WayneKey2=Value2;</span></font></tt></p>

      <p><tt><font size="2"><span style="color: green"></span>(Request HTTP body)</font></tt></p>
    </div>
  </li>
</ol>

<blockquote>
  <p>Notes: in #4 above, if client browser does not support cookie or cookie is disabled by user , a fallback mechanism might be implemented by the HTTP Web server, which can usually store cookie data within the URL (for an instance example, ASP.NET can support storing cookie in URL by setting <code>cookieless=&quot;UseUri&quot;</code> in web.config, refer: <a href="http://msdn.microsoft.com/en-us/library/aa479314.aspx" target="_blank">Cookieless ASP.NET</a>), or alternatively, the Web server won't allow client to use its features.</p>
</blockquote>

<p>Based on a server allocated &quot;<strong>Session ID</strong>&quot; storing in <strong>client cookie</strong>, <strong>Session object</strong> is widely used in all popular web servers to store temporary data<strong> on server side </strong>(could be memory, database or a dedicated session storage server and so on), in case client disabled cookie, web server might adopt the same strategy mentioned above (storing cookie in URL), or instead, they do not allow client to use its features except client gets cookie enabled. 

  <br /></p>

<h3>Situation</h3>

<p>Nowadays countless websites (for example Google, Facebook, Amazon, New York Times) relies on HTTP cookie to store data such as user preference, login information, shopping cart and so on. If you disable cookie in your browser and try to access many<strong> extremely popular web applications</strong> (like Facebook, Twitter, Gmail, Amazon and so on) today , you probably see screenshots below: </p>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1p686gobFZyFZ7VohUS0-lj6XLdKPLZgoU70o7CHk5J0Ja-3J0ran6pnOeJFcgx-9hJN7AG4A9xCP_AtuySNBRxA/GoogleNoCookie.jpg?psid=1" /></p>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1p_s9UC7Xfq5CpJY2PfBxzRUL6bcQgUYe6h3fQ4yKNTqFwdtMDHwKxw_yvZW1d-Pe4LthjR3EuBF_WpBylRYlA3A/fbCookie.jpg?psid=1" /></p>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1p1LAxsLb-Au4jkE8ECQQdJF1UUjt1zZbiNMoEpa1yvwOWD5f0QAj-3tNDcIcP2wvIl7MBF8J0CcY0mwZ-ulXzVA/AmazonNoCookie.jpg?psid=1" /></p>

<p>In one word, <strong style="color:red">cookie enabled is a mandatory condition</strong> <strong>to use these web giants</strong>. 

  <br /></p>

<h3>Cookie Drawbacks</h3>

<p>I investigated and summarized a number of drawbacks of Cookie listed below (two W3C points mentioned at the beginning are included):</p>

<ul>
  <li><strong>Size and count limit</strong> 

    <br />Most browsers limited cookie size to 4096 bytes and 300 maximum cookie count within a domain. IETF recommended limitation standard, refer: <a href="http://www.ietf.org/rfc/rfc2109.txt">http://www.ietf.org/rfc/rfc2109.txt</a> section 6.3. </li>

  <li><strong>Performance hit</strong> 

    <br />If a website uses cookie, then every HTTP request/response between server/browser must include all cookie key/values pairs in the HTTP header. </li>

  <li><strong>Security</strong> 

    <br />Cookie is stored in user's local hard disk in plaint text. If developers didn't deal with this appropriate, <a href="http://en.wikipedia.org/wiki/HTTP_cookie#Cookie_theft_and_session_hijacking"><strong>cookie/session hijacking</strong></a> could possibly happen. </li>

  <li><strong>Ability to store data separately for more than one instance of same web application</strong> 

    <br />Cookie is not easy to handle one use case: separate instances of the same web application to run in different windows without interfering with each other (sessionStorage is going to well-support that, I will describe it later in this post). </li>
</ul>

<br />

<h2>Web Storage mechanism</h2>

<p>Unlike cookie which passed between server/client and could be accessed by both of them, sessionStorage/localStorage are <strong>100% stored in the client</strong> by a concrete browser, sessionStorage stores temporarily data in one HTTP session, localStorage stores permanent data into client hard disk. The advantage is obvious:</p>

<ul>
  <li>Data won't be passed through HTTP request/response, bandwidth will be saved. </li>

  <li>There will be no 4KB limitation, web site has much more flexibility to store large data in client. 
    <br />

    <br />

    <blockquote>Notes: W3C &quot;recommended 5 megabytes localStorage size limitation per domain&quot;, and &quot;welcome feedback&quot;, this is much larger than 4KB limitation in cookie. </blockquote>
  </li>

  <li>Now that data won't be passed through network, this will be relatively more secure. </li>

  <li>Considering further according to #3, a number of existing HTTPs connection in theory could use plaint HTTP by adopting Web Storage, because no need to encrypt the data, the data is stored in client side.&#160; Since HTTPs usually has only 10% performance comparing with HTTP,&#160; eventually either performance will be improved or cost is saved (procuring cheaper server hardware) . </li>
</ul>

<p>In my humbly opinion, Web Storage is <strong>one the greatest feature in HTML5,</strong> and<strong> </strong>I believe it will <strong>lead an HTTP web state storage revolution</strong> in the near future! Why? Considering several stories listed below, I guess they will very possibly happen soon!</p>

<p>&#160;</p>

<ol>
  <li><strong>Bandwidth save</strong>. You have an Email account of a popular Email service web application, and you use it daily, at very first time of your visit in a concrete browser. It stores your 300+ contacts list as well as your newest 20 email threads (first page) into your browser's local storage, and the data takes approximate 8 kilobytes in total. In future visits, this 8 kilobytes will not be transferred from the Email server. </li>

  <li><strong>No download time = Better UX</strong>. You like watching videos from a popular video web site, which records video list (by default 10 latest watched videos) you've watched <strong>as well as indexed real video stream data. E</strong>very time you visit the web site, you have a ability to view your watching history and most important, you can re-watch any video in the list in a second â€“ from your local storage. </li>

  <li><strong>Surfing same web sites using more than one account simultaneously</strong>. For some reason, you registered two accounts in one web site, which uses session storage, and you can login with these two account in two browser tabs and interactive in isolation. For example, checking Gmail in two Tabs using two Gmail account at the same time. </li>
</ol>

<br />

<h2>Manipulating Storage in JavaScript</h2>

<br />

<h3>The Storage Interface</h3>

<p>Both sessionStorage/localStorage are inherited from an interface Storage, it defined in Web Storage Spec:</p>

<pre style="background: #f6f8ff; color: #000020">interface Storage <span style="color: #406080">{</span>
  readonly attribute unsigned long length<span style="color: #406080">;</span>
  DOMString key<span style="color: #308080">(</span><span style="color: #200080; font-weight: bold">in</span> unsigned long <span style="color: #007d45">index</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
  getter any <span style="color: #200080; font-weight: bold">getItem</span><span style="color: #308080">(</span><span style="color: #200080; font-weight: bold">in</span> DOMString key<span style="color: #308080">)</span><span style="color: #406080">;</span>
  setter creator void setItem<span style="color: #308080">(</span><span style="color: #200080; font-weight: bold">in</span> DOMString key<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> any value<span style="color: #308080">)</span><span style="color: #406080">;</span>
  deleter void removeItem<span style="color: #308080">(</span><span style="color: #200080; font-weight: bold">in</span> DOMString key<span style="color: #308080">)</span><span style="color: #406080">;</span>
  void clear<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span><span style="color: #406080">;</span></pre>

<h3>
  <br />Basic Operations</h3>

<p>First things first, we need check whether a concrete browser supports Web Storage or not, per <a href="http://en.wikipedia.org/wiki/Comparison_of_layout_engines_(HTML5)" target="_blank">Wikipedia: Comparison of layout engines (HTML5)</a>, IE8+ (IE8 does NOT support Storage Event, while IE9 RC supports), FireFox 3.5+, Safari 4.0+, Chrome 4.0+<strong> all support Web Storage</strong>. We can write a&#160; simple JS function to check whether client browser supports Web Storage or not:</p>

<pre style="background: #f6f8ff; color: #000020"><span style="color: #200080; font-weight: bold">function</span> supportsLocalStorage<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #406080">{</span>
    <span style="color: #200080; font-weight: bold">return</span> <span style="color: #308080">(</span><span style="color: #1060b6">'localStorage'</span> <span style="color: #200080; font-weight: bold">in</span> window<span style="color: #308080">)</span> <span style="color: #308080">&amp;&amp;</span> window<span style="color: #308080">[</span><span style="color: #1060b6">'localStorage'</span><span style="color: #308080">]</span> <span style="color: #308080">!==</span> <span style="color: #0f4d75">null</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span>

<span style="color: #200080; font-weight: bold">if</span><span style="color: #308080">(</span>supportsLocalStorage<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #308080">)</span> <span style="color: #406080">{</span>
    <span style="color: #595979">// Web Storage invocation here</span>
<span style="color: #406080">}</span>
<span style="color: #200080; font-weight: bold">else</span> <span style="color: #406080">{</span>
    alert<span style="color: #308080">(</span><span style="color: #1060b6">'Sorry, your browser does not support Web Storage'</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span></pre>

<p>If the browser does support, then invoking sessionStorage and localStorage in JavaScript is fairly easy. Sample code which demonstrates set/get/remove/clear items storage shows below:</p>

<pre style="background: #f6f8ff; color: #000020"><span style="color: #595979">// Set/Get locallStorage</span>
localStorage<span style="color: #308080">.</span><span style="color: #406080">{</span>key<span style="color: #406080">}</span> <span style="color: #308080">=</span> strValue<span style="color: #406080">;</span>
<span style="color: #200080; font-weight: bold">var</span> localVal <span style="color: #308080">=</span> localStorage<span style="color: #308080">.</span><span style="color: #406080">{</span>key<span style="color: #406080">}</span><span style="color: #406080">;</span>

<span style="color: #595979">// Set/Get sessionlStorage</span>
sessionStorage<span style="color: #308080">.</span><span style="color: #406080">{</span>key<span style="color: #406080">}</span> <span style="color: #308080">=</span> strValue<span style="color: #406080">;</span>
<span style="color: #200080; font-weight: bold">var</span> sessionVal <span style="color: #308080">=</span> sessionStorage<span style="color: #308080">.</span><span style="color: #406080">{</span>key<span style="color: #406080">}</span><span style="color: #406080">;</span>

<span style="color: #595979">// Remove an storage item</span>
localStorage<span style="color: #308080">.</span>removeItem<span style="color: #308080">(</span><span style="color: #1060b6">'key'</span><span style="color: #308080">)</span>
sessionStorage<span style="color: #308080">.</span>removeItem<span style="color: #308080">(</span><span style="color: #1060b6">'key'</span><span style="color: #308080">)</span>

<span style="color: #595979">// Clear storage</span>
localStorage<span style="color: #308080">.</span>clear<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
sessionStorage<span style="color: #308080">.</span>clear<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #406080">;</span></pre>

<p>Please be aware of one thing: both sessionStorage and localStorage<strong> can only store &quot;DOM <em>string</em>&quot; value</strong>, what if we want to store JavaScript object into them, the answer is definitely JSON string, and <a href="http://stackoverflow.com/questions/2010892/storing-objects-in-html5-localstorage" target="_blank">someone at StackOverFlow has provided an elegant way</a> to extend Storage.setObject/getObject method by using JavaScript prototype, code shows below:</p>

<pre style="background: #f6f8ff; color: #000020">Storage<span style="color: #308080">.</span><span style="color: #007d45">prototype</span><span style="color: #308080">.</span>setObject <span style="color: #308080">=</span> <span style="color: #200080; font-weight: bold">function</span> <span style="color: #308080">(</span>key<span style="color: #308080">,</span> value<span style="color: #308080">)</span> <span style="color: #406080">{</span>
    <span style="color: #200080; font-weight: bold">this</span><span style="color: #308080">.</span>setItem<span style="color: #308080">(</span>key<span style="color: #308080">,</span> JSON<span style="color: #308080">.</span>stringify<span style="color: #308080">(</span>value<span style="color: #308080">)</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span>
 
Storage<span style="color: #308080">.</span><span style="color: #007d45">prototype</span><span style="color: #308080">.</span>getObject <span style="color: #308080">=</span> <span style="color: #200080; font-weight: bold">function</span> <span style="color: #308080">(</span>key<span style="color: #308080">)</span> <span style="color: #406080">{</span>
    <span style="color: #200080; font-weight: bold">return</span> <span style="color: #200080; font-weight: bold">this</span><span style="color: #308080">.</span><span style="color: #200080; font-weight: bold">getItem</span><span style="color: #308080">(</span>key<span style="color: #308080">)</span> <span style="color: #308080">&amp;&amp;</span> JSON<span style="color: #308080">.</span><span style="color: #200080; font-weight: bold">parse</span><span style="color: #308080">(</span><span style="color: #200080; font-weight: bold">this</span><span style="color: #308080">.</span><span style="color: #200080; font-weight: bold">getItem</span><span style="color: #308080">(</span>key<span style="color: #308080">)</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span>
 
<span style="color: #595979">// By extending Storage's prototype above, just simply add/get JavaScript object into Storage</span>
localStorage<span style="color: #308080">.</span>setObject<span style="color: #308080">(</span><span style="color: #1060b6">'key'</span><span style="color: #308080">,</span>objValue<span style="color: #308080">)</span><span style="color: #406080">;</span>
localStorage<span style="color: #308080">.</span>getObject<span style="color: #308080">(</span><span style="color: #1060b6">'key'</span><span style="color: #308080">,</span>objValue<span style="color: #308080">)</span><span style="color: #406080">;</span>
sessionStorage<span style="color: #308080">.</span>setObject<span style="color: #308080">(</span><span style="color: #1060b6">'key'</span><span style="color: #308080">,</span> objValue<span style="color: #308080">)</span><span style="color: #406080">;</span>
sessionStorage<span style="color: #308080">.</span>getObject<span style="color: #308080">(</span><span style="color: #1060b6">'key'</span><span style="color: #308080">,</span> objValue<span style="color: #308080">)</span><span style="color: #406080">;</span></pre>

<p>My attached WebStorageDemo shows how to store both DOM String and JSON String into sessionStorage/localStorage, code snippet and screenshot showing below:</p>

<p>Store several fake Shopping Cart items into sessionStorage:</p>

<pre style="background: #f6f8ff; color: #000020"><span style="color: #200080; font-weight: bold">function</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #406080">{</span>
    <span style="color: #200080; font-weight: bold">return</span> <span style="color: #308080">(</span><span style="color: #308080">(</span><span style="color: #308080">(</span><span style="color: #008c00">1</span> <span style="color: #308080">+</span> <span style="color: #007d45">Math</span><span style="color: #308080">.</span><span style="color: #200080; font-weight: bold">random</span><span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #308080">)</span> <span style="color: #308080">*</span> <span style="color: #008000">0x10000</span><span style="color: #308080">)</span> <span style="color: #308080">|</span> <span style="color: #008c00">0</span><span style="color: #308080">)</span><span style="color: #308080">.</span><span style="color: #200080; font-weight: bold">toString</span><span style="color: #308080">(</span><span style="color: #008c00">16</span><span style="color: #308080">)</span><span style="color: #308080">.</span><span style="color: #200080; font-weight: bold">substring</span><span style="color: #308080">(</span><span style="color: #008c00">1</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span>
<span style="color: #200080; font-weight: bold">function</span> Guid<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #406080">{</span>
    <span style="color: #200080; font-weight: bold">return</span> <span style="color: #308080">(</span>S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #308080">+</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #308080">+</span> <span style="color: #1060b6">&quot;-&quot;</span> <span style="color: #308080">+</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #308080">+</span> <span style="color: #1060b6">&quot;-&quot;</span> <span style="color: #308080">+</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #308080">+</span> <span style="color: #1060b6">&quot;-&quot;</span> <span style="color: #308080">+</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #308080">+</span> <span style="color: #1060b6">&quot;-&quot;</span> <span style="color: #308080">+</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #308080">+</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #308080">+</span> S4<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span>
<span style="color: #200080; font-weight: bold">function</span> ShoppingCartItem<span style="color: #308080">(</span><span style="color: #308080">)</span> <span style="color: #406080">{</span>
    <span style="color: #200080; font-weight: bold">this</span><span style="color: #308080">.</span>ProductID <span style="color: #308080">=</span> Guid<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
    <span style="color: #200080; font-weight: bold">this</span><span style="color: #308080">.</span>ProductName <span style="color: #308080">=</span> <span style="color: #1060b6">''</span><span style="color: #406080">;</span>
    <span style="color: #200080; font-weight: bold">this</span><span style="color: #308080">.</span>CategoryID <span style="color: #308080">=</span> <span style="color: #308080">-</span><span style="color: #008c00">1</span><span style="color: #406080">;</span>
    <span style="color: #200080; font-weight: bold">this</span><span style="color: #308080">.</span>Price <span style="color: #308080">=</span> <span style="color: #308080">-</span><span style="color: #008000">1.0</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span>

<span style="color: #595979">// Fake items in shopping cart, and store into sessionstorage</span>
<span style="color: #200080; font-weight: bold">var</span> item1 <span style="color: #308080">=</span> <span style="color: #200080; font-weight: bold">new</span> ShoppingCartItem<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
item1<span style="color: #308080">.</span>ProductName <span style="color: #308080">=</span> <span style="color: #1060b6">'HP WebOS Topaz'</span><span style="color: #406080">;</span>
item1<span style="color: #308080">.</span>CategoryID <span style="color: #308080">=</span> <span style="color: #008c00">8</span><span style="color: #406080">;</span>
item1<span style="color: #308080">.</span>Price <span style="color: #308080">=</span> <span style="color: #008000">849.99</span><span style="color: #406080">;</span>
<span style="color: #200080; font-weight: bold">var</span> item2 <span style="color: #308080">=</span> <span style="color: #200080; font-weight: bold">new</span> ShoppingCartItem<span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
item2<span style="color: #308080">.</span>ProductName <span style="color: #308080">=</span> <span style="color: #1060b6">'Apple Ipad II'</span><span style="color: #406080">;</span>
item2<span style="color: #308080">.</span>CategoryID <span style="color: #308080">=</span> <span style="color: #008c00">10</span><span style="color: #406080">;</span>
item2<span style="color: #308080">.</span>Price <span style="color: #308080">=</span> <span style="color: #008000">799.99</span><span style="color: #406080">;</span>

<span style="color: #200080; font-weight: bold">var</span> currentUserShoppingCart <span style="color: #308080">=</span> <span style="color: #200080; font-weight: bold">new</span> <span style="color: #007d45">Array</span><span style="color: #308080">(</span><span style="color: #308080">)</span><span style="color: #406080">;</span>
currentUserShoppingCart<span style="color: #308080">[</span><span style="color: #008c00">0</span><span style="color: #308080">]</span> <span style="color: #308080">=</span> item1<span style="color: #406080">;</span>
currentUserShoppingCart<span style="color: #308080">[</span><span style="color: #008c00">1</span><span style="color: #308080">]</span> <span style="color: #308080">=</span> item2<span style="color: #406080">;</span>
sessionStorage<span style="color: #308080">.</span>setObject<span style="color: #308080">(</span><span style="color: #1060b6">'UserShoppingCart'</span><span style="color: #308080">,</span> currentUserShoppingCart<span style="color: #308080">)</span><span style="color: #406080">;</span></pre>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1p3Lmdjb5JZjRnpo_sNWx57VgfIzVZNQJKhcVib6r0TUVKBDOagddIWBoqwO-J_4KcQUzuSh4pYoAeAuUXI_ufVQ/ShoppingCart.jpg?psid=1" /> </p>

<br />

<h3>Delve deep into sessionStorage/localStorage mechanism</h3>

<p>As I mentioned at the beginning, both sessionStorage/localStorage are &quot;<strong>100%</strong> <strong>stored in the client by a concrete browser</strong>&quot;, the difference between them is that sessionStorage is &quot;<strong>window/tab isolated</strong>&quot; while localStorage is <strong>shared </strong><strong>cross pages under a domain</strong>, in other words, sessionStorage takes care of storing temporary data during an HTTP session life time <strong>happened in one browser window/tab</strong>, each window/tab can maintain its own session data; <font style="background-color: #ffffff" color="#555555">While localStorage stores data persists into user's hard disk,</font> all pages under this concrete domain can manipulate the localStorage.</p>

<p>Let's again see a demo, I added a &quot;Counter&quot; which stored natural number into sessionStorage, and a clickable button can increase the Counter, code below:</p>

<pre style="background: #f6f8ff; color: #000020"><span style="color: #0057a6">&lt;</span><span style="color: #200080; font-weight: bold">input</span><span style="color: #474796"> </span><span style="color: #074726">type</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;button&quot;</span><span style="color: #474796"> </span><span style="color: #074726">value</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;Counter++&quot;</span><span style="color: #474796"> </span><span style="color: #074726">onclick</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;sessionStorage.Counter++;&quot;</span><span style="color: #474796"> </span><span style="color: #0057a6">/&gt;</span></pre>

<p>And I open two instance of the page, respectively click &quot;<strong>Counter++</strong>&quot; on each page, then we will see each of them keeps its own counter:</p>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1praukGjXm19ywHFfu7C7S8NmHiICrah-WadP17x5SUJE_YaFNiBmFxMR0Fu9PDI5lVbAH5YeukGoNJ1ds_44Y7g/IsolatedSessionStorage.jpg?psid=1" /></p>

<p><font style="background-color: #ffff00"><font style="background-color: #ffffff">On the </font></font><font style="background-color: #ffffff">contrary, data</font> stored in localStorage could be accessed by all pages under the same domain, in the demo shown below, initially I inserted a fake &quot;<strong>UserProfile</strong>&quot; into localStorage, and then open another page which has different path but under the same domain, we will see &quot;UserProfile&quot; stored by first page can be retrieved. </p>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1pqK0xEp732Tb03IiYQ81b_DkPDDhW2nwVlkqSxBxKV-JPb6a2WhfO-pLo1j6SOkAXfppbX25D7Ymm7xmByRTC8w/localStorageShare.jpg?psid=1" /></p>

<blockquote>
  <p>Notes: now that localStorage is shared, it therefore might be manipulated by more than one page simultaneously, W3 emphasized that the browser should implement &quot;Storage mutex&quot; to ensure the <strong>Thread safe</strong> of localStorage.</p>
</blockquote>

<p>By achieving these mechanisms, sessionStorage/localStorage is supposed to <font style="background-color: #ffffff">replace Cookie with a more straight-forward, effective and secure manner.</font></p>

<p>&#160;</p>

<h3>Storage Event </h3>

<p>W3 defines StorageEvent interface as below:</p>

<pre style="background: #f6f8ff; color: #000020">interface StorageEvent <span style="color: #406080">:</span> Event <span style="color: #406080">{</span>
  readonly attribute DOMString key<span style="color: #406080">;</span>
  readonly attribute any oldValue<span style="color: #406080">;</span>
  readonly attribute any newValue<span style="color: #406080">;</span>
  readonly attribute DOMString url<span style="color: #406080">;</span>
  readonly attribute Storage storageArea<span style="color: #406080">;</span>
  void initStorageEvent<span style="color: #308080">(</span><span style="color: #200080; font-weight: bold">in</span> DOMString typeArg<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> boolean canBubbleArg<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> boolean cancelableArg<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> DOMString keyArg<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> any oldValueArg<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> any newValueArg<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> DOMString urlArg<span style="color: #308080">,</span> <span style="color: #200080; font-weight: bold">in</span> Storage storageAreaArg<span style="color: #308080">)</span><span style="color: #406080">;</span>
<span style="color: #406080">}</span><span style="color: #406080">;</span></pre>

<p>Most famous browser (latest version) have implemented StorageEvent, see screenshot below below:</p>

<p><img class="BlogImage" src="http://a1pwpq.bay.livefilestore.com/y1pzrtjaORKfHsUIc7qDpm8bW3SGa8R-LDCkjB_1OzGYB0rP5OfEYjuUlZjeF5vYHoMg47nLuk8xyNVAohAxPNSj7uEGyseVI_Q/StorageEventSupport.jpg?psid=1" /></p>

<p>By reading their documents: <a href="http://msdn.microsoft.com/en-us/library/cc197059(v=vs.85).aspx" target="_blank">IE 9</a>, <a href="https://developer.mozilla.org/en/DOM/Event/StorageEvent" target="_blank">Firefox</a>, <a href="http://developer.apple.com/library/safari/#documentation/iPhone/Conceptual/SafariJSDatabaseGuide/Name-ValueStorage/Name-ValueStorage.html" target="_blank">Safari</a>, the standard way to subscribe storage event is <code>window.addEventListener('storage', onStorageChanged, false)</code>, unfortunately, after trying 2 days, I recognized that it ONLY works in IE 9 RC at this timestamp (2/24/2011), even described by <a href="http://developer.apple.com/library/safari/#documentation/iPhone/Conceptual/SafariJSDatabaseGuide/Name-ValueStorage/Name-ValueStorage.html" target="_blank">Safari official Dev document</a>, it doesn't work! So I am demonstrating StorageEvent in IE 9 RC, in code below, I subscribes storage event, once sessionStorage/localStorage items got changed, I checks storage's key to determine further reaction:</p>

<pre style="background: #f6f8ff; color: #000020">if (window<span style="color: #008c00">.</span>addEventListener) { // IE9, FF, Chrome, Safari, Opera
    window<span style="color: #008c00">.</span>addEventListener('storage', onStorageChanged, false);
}
else if (window<span style="color: #008c00">.</span>attachEvent) {
    window<span style="color: #008c00">.</span>attachEvent(&quot;onstorage&quot;, onStorageChanged); // IE 8
}
else {
    alert('Sorry, your browser does not support DOM event subscribtion!');
    return;
}

function onStorageChanged(e) {
    if (e<span style="color: #008c00">.</span>key != '') { 
        switch (e<span style="color: #008c00">.</span>key) {
            case 'Counter': // Counter stored in sessionStorage
                $('spCurCounter').innerHTML = 'Current Session Counter: <span style="color: #0057a6">&lt;</span><span style="color: #200080; font-weight: bold">b</span><span style="color: #0057a6">&gt;</span>' + e<span style="color: #008c00">.</span>newValue + '<span style="color: #0057a6">&lt;/</span><span style="color: #200080; font-weight: bold">b</span><span style="color: #0057a6">&gt;</span>';
                break;
            case 'UserShoppingCart':
                break;
            case 'UserProfile': // UserProfile stored in localStorage
                break;
            default:
                $('informationBar').innerHTML += 'New localStorage object added, Key: [<span style="color: #0057a6">&lt;</span><span style="color: #200080; font-weight: bold">span</span><span style="color: #474796"> </span><span style="color: #074726">style</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;</span><span style="color: #7779bb; font-weight: bold">color</span><span style="color: #308080">:</span><span style="color: #007d45">red</span><span style="color: #1060b6">&quot;</span><span style="color: #0057a6">&gt;</span>' + e<span style="color: #008c00">.</span>key + '<span style="color: #0057a6">&lt;/</span><span style="color: #200080; font-weight: bold">span</span><span style="color: #0057a6">&gt;</span>] Value: [<span style="color: #0057a6">&lt;</span><span style="color: #200080; font-weight: bold">span</span><span style="color: #474796"> </span><span style="color: #074726">style</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;</span><span style="color: #7779bb; font-weight: bold">color</span><span style="color: #308080">:</span><span style="color: #007d45">red</span><span style="color: #1060b6">&quot;</span><span style="color: #0057a6">&gt;</span>' + e<span style="color: #008c00">.</span>newValue + '<span style="color: #0057a6">&lt;/</span><span style="color: #200080; font-weight: bold">span</span><span style="color: #0057a6">&gt;</span>].<span style="color: #0057a6">&lt;</span><span style="color: #200080; font-weight: bold">br</span><span style="color: #474796"> </span><span style="color: #0057a6">/&gt;</span>';
                break;
        }
    }
}</pre>

<p>The GIF below demonstrates that when I insert a new object into localStorage, <code>onStorageChanged</code> function was triggered <strong>on two page instance simultaneously</strong>, and displays the new inserted data at the same time:</p>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1pv-UxmWRws4m62vUfBfMkcISPduIDCSzHT6ANfAQIAnxOUHBMs5jx-rHNBv-XnIrPyYGj89ImicXwWXN0j332dg/WayneStorageEventDemo.gif?psid=1" />&#160;&#160; </p>

<p>&#160;</p>

<h3>Storage Location/Format</h3>

<p>Let's finally look into how browser store localStorage: location and data format. Let's take IE9 and Google Chrome on Windows 7 as example, see table below:</p>

<table border="1" cellspacing="0" cellpadding="2" width="712"><tbody>
    <tr>
      <td valign="top" width="129"><strong>Browser</strong></td>

      <td valign="top" width="474"><strong>localStorage location</strong></td>

      <td valign="top" width="107"><strong>Data Format</strong></td>
    </tr>

    <tr>
      <td valign="top" width="140">IE 9 RC</td>

      <td valign="top" width="474">%userprofile%\AppData\Local\Microsoft\Internet Explorer\DOMStore\</td>

      <td valign="top" width="107">Plaint XML</td>
    </tr>

    <tr>
      <td valign="top" width="151">Chrome</td>

      <td valign="top" width="474">%userprofile%\AppData\Local\Google\Chrome\User Data\Default\Local Storage</td>

      <td valign="top" width="107">SQLite</td>
    </tr>
  </tbody></table>

<p>IE 9 actually stores localStorage items a simple xml file, below is how the XML stores &quot;UserProfile&quot; object in my demo:</p>

<pre style="background: #f6f8ff; color: #000020"><span style="color: #0057a6">&lt;</span><span style="color: #200080; font-weight: bold">root</span><span style="color: #0057a6">&gt;</span>
    <span style="color: #0057a6">&lt;</span><span style="color: #333385">item</span><span style="color: #474796"> </span>
<span style="color: #474796">&#160;&#160;&#160; </span><span style="color: #074726">name</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;UserProfile&quot;</span><span style="color: #474796"> </span>
<span style="color: #474796">&#160;&#160;&#160; </span><span style="color: #074726">value</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;{&amp;quot;NickName&amp;quot;:&amp;quot;Wayne&amp;quot;,&amp;quot;EmailAddress&amp;quot;</span>
<span style="color: #1060b6">&#160;&#160;&#160; :&amp;quot;WebMaster@WayneYe.com&amp;quot;}&quot;</span><span style="color: #474796"></span>
<span style="color: #474796">&#160;&#160;&#160; ltime</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;3439488560&quot;</span><span style="color: #474796"> </span>
<span style="color: #474796">&#160;&#160;&#160; htime</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;30135140&quot;</span><span style="color: #474796"> </span><span style="color: #0057a6">/&gt;</span>
<span style="color: #0057a6">&lt;/</span><span style="color: #200080; font-weight: bold">root</span><span style="color: #0057a6">&gt;</span></pre>

<p>Chrome stores data in a <a href="http://sqlite.org" target="_blank">SQLite</a> simple database table with two columns: <strong>Key</strong> and <strong>Value</strong>, screenshot below:</p>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1puR2-WBtF3QYGG8DYnOIfTmxL2pvHJY1Jtv2HH9Te8brVssUbNLfgDlVAP2GcDnnKYzmZ-G9T5sHYba6KJ6Ujwg/Chromesqlite.jpg?psid=1" /></p>

<p>&#160;</p>

<h3>Demo code notes</h3>

<p>I've also put the compete Demo on to my blog: <a href="http://WayneYe.com/Demo/HTML5/WebStorageDemo.htm" target="_blank">http://WayneYe.com/Demo/HTML5/WebStorageDemo.htm</a></p>

<p>Please note if you test my attached Demo or try any code related with Web Storage in IE 9, please make sure you added <strong>X-UA-Capability</strong> meta information in your HTML header, or explicitly set both Browse mode/Document mode to &quot;<strong>Internet Explorer 9 Standards</strong>&quot; in IE Developer tool, otherwise you probably see JS errors since IE 6,7 does NOT recognize session/local Storage.</p>

<pre style="background: #f6f8ff; color: #000020"><span style="color: #0057a6">&lt;</span><span style="color: #200080; font-weight: bold">meta</span><span style="color: #474796"> </span><span style="color: #074726">http-equiv</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;X-UA-Compatible&quot;</span><span style="color: #474796"> </span><span style="color: #074726">content</span><span style="color: #308080">=</span><span style="color: #1060b6">&quot;IE=9&quot;</span><span style="color: #474796"> </span><span style="color: #0057a6">/&gt;</span></pre>

<p><img class="BlogImage" src="http://public.bay.livefilestore.com/y1puR2-WBtF3QaAgbM3t7pItKNSVHSvLFrD2RQR5_Y3qFIr8amp38U7_89nHl19jiz_tqZ8y6SePJuPVgcb114m1w/DevToolIE9.jpg?psid=1" /></p>

<br />

<h2>Conclusion</h2>

<p>Compare to HTTP Cookie, HTML5 Web Storage mechanism provides relatively more convenient, flexibility, secure and faster way to store HTTP state data, it should replace HTTP Cookie gradually, especially nowadays most of popular web browsers had supported it (although there might be several issues such as StorageEvent I mentioned above), they do conform W3C standard to store data in sessionStorage/localStorage. Ian Hickson &quot;expected HTML 5 becomes <a href="http://en.wikipedia.org/wiki/W3C_recommendation#Candidate_Recommendation_.28CR.29">Candidate Recommendation</a> stage during 2012&quot;, let's be expecting and excited to see how things going in the coming future.</p>

<p>&#160;</p>

<h2>Further Read</h2>
<strong><a href="http://dev.w3.org/html5/webstorage/" target="_blank">Web Storage Specification</a></strong> 

<br /><strong><a href="http://www.switchonthecode.com/tutorials/taking-a-dive-into-html5-web-storage" target="_blank">Taking a Dive into HTML5 - Web Storage</a></strong> 

<br /><strong><a href="http://diveintohtml5.org/storage.html" target="_blank">Local Storage - Dive Into HTML5</a></strong> 

<br /><strong><a href="http://en.wikipedia.org/wiki/Comparison_of_layout_engines_(HTML5)" target="_blank">Comparison of layout engines (HTML5)</a></strong> 

<br /><strong><a href="http://en.wikipedia.org/wiki/HTTP_cookie" target="_blank">HTTP_Cookie</a> </strong>

<br /><strong><a href="http://www.quirksmode.org/dom/tests/html5_storage.html" target="_blank">HTML5 tests - storage</a></strong> 

<br /><strong><a href="http://msdn.microsoft.com/en-us/library/cc197062(v=vs.85).aspx" target="_blank">Introduction to DOM Storage</a></strong> 

<br /><strong><a href="http://developer.apple.com/library/safari/documentation/iPhone/Conceptual/SafariJSDatabaseGuide/Name-ValueStorage/Name-ValueStorage.html" target="_blank">Safari Developer Library - Key-Value Storage</a></strong> 

<br /><strong><a href="https://developer.mozilla.org/en/dom/storage" target="_blank">DOM Storage - MDC Doc Center</a></strong>
<p>&nbsp;</p>
<p>
<b>Also posted at: <a href="http://www.codeproject.com/KB/HTML/Web-Storage-In-Essence.aspx" target="_blank">http://www.codeproject.com/KB/HTML/Web-Storage-In-Essence.aspx</a></b>
</p>
