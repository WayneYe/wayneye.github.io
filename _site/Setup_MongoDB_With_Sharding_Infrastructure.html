<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Setup MongoDB with sharding infrastructure - Wayneâ€™s Geek Life</title>
<meta name="description" content="The landscape&nbsp;Sharding is the strategy that MongoDB uses to horizentally scale the entire data store infrustructure and meet the demands of data,growth, the infrastructure can be demonstrated as image below:PreparationTo simulate a production like environment, a minimum number of 7 physical/virtual servers are required, the role of them are:3 for Mongo config servers1 for&nbsp;Mongo shard server (mongos)3 for a Mongo shard (Replica set), 1&nbsp;primary&nbsp;and 2&nbsp;secondary&nbsp;(or 1 secondary and 1 arbiter).Note: all the machines above need have mongod installed, for installation, refer: Install MongoDB.SetUp StepsConcentrated steps of setting up sharded MongoDB are summarized below;&nbsp;a complete tutorial from MongoDB&#39;s official website can be found at:&nbsp;Deploy a Sharded Cluster.:1. Setup Config serversudo mkdir -p /data/configdbsudo mongod --configsvr --dbpath /data/configdb --port 270192. Setup Mongo Shard server (mongos)mongos --configdb [config_server_ip/host]3. Setup Shard 1~NIn MangoDB production deployment, a &quot;shard&quot; should be a replica set, a&nbsp;typical &quot;three member&quot; replica sets architecture is like below:Or&quot;Three member&quot; essentially are three mongod processes with heartbeat and full replication between each other, they can run on one physical machine (for development/test use) or on separate machines (real production), this infrastructure provides &quot;additional fault tolerance and high availability&quot;.&nbsp;Setup primaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate() # or explicitly:&nbsp;rs.initiate({_id: &quot;rs1&quot;, members: [{_id: 0, host: &quot;rs1-1&quot;}]})rs.conf()rs.add(&quot;{secondary_host}&quot;)Setup secondaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate()rs.conf()Setup&nbsp;arbiterArbiter is like a &quot;guard process&quot; and consumers no dedicated hardware resource, for out concrete case, I setup arbiter on the mongos server.mkdir /var/lib/mongo/arb/mongod --port 30000 --dbpath /var/lib/mongo/arb/ --replSet rs0 --smallfilesConnect to the mongo shell of the primary and run:rs.addArb(&quot;{arbiter_host}:30000&quot;)&nbsp;Verificationrs.conf()rs0:PRIMARY&gt; rs.conf(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-2&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arbiterOnly&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}rs.status()rs0:PRIMARY&gt; rs.status(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;set&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;date&quot; : ISODate(&quot;2013-12-17T08:56:41Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;myState&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-2&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;SECONDARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 299,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:40Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2013-12-17T08:56:39Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;syncingTo&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-1&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;PRIMARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 317,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;self&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 8,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;(not reachable/healthy)&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:24Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ok&quot; : 1}Trouble shootingFor experimental made mistakes, we can run the following command on mongo config server to &quot;reset&quot; the sharding status:&gt; use config&gt; db.shards.drop()&nbsp;Official documentationsDeploy a replica setAdd an Arbiter to Replica Set&nbsp;Caveats: In real production environment, a minimum of&nbsp;3 replica-sets&nbsp;is required. With two nodes, it can get replication of data (i.e.: they will copy each other), but it will not get automatic fail-over or high availability, hence we should never run production data with less than 3 nodes!After replica set are all setup we can add it to mongo sharding server as a &quot;shard&quot;:First we need make sure the local mongod process is running on each shard, then we can use mongo shell to connect to the mongos server and tell the mongos add each shard respectively:mongo --host [mongos_server_ip/host]&gt; sh.addShard(&quot;[replSetName: e.g.&nbsp;rs0/[mongod_ip/port]&quot;) # e.g. sh.addShard(&quot;rs0/ &nbsp;For single mongod in development environment,&nbsp;sh.addShard(&quot;[shard_ip/host]:27017&quot;) #&nbsp;&gt; sh.enableSharding(&quot;[database]&quot;) # Sharding a database&gt; sh.shardCollection(&quot;[database].[collection]&quot;, shard-key-pattern) # Sharding a collection with a shard keyConcrete example of setting up a Mongo shard for &quot;Collection_Name&quot;mongo --host mongossh.addShard(&quot;rs1-0&quot;)sh.enableSharding(&quot;{Database name}&quot;)sh.shardCollection(&quot;{Database name}.{Collection name}&quot;, {user_id:1})#&nbsp;Verify the sharding status by running &quot;sh.status()&quot; in mongo shell:sh.status()mongos&gt; sh.status()--- Sharding Status --- &nbsp;&nbsp;sharding version: {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;minCompatibleVersion&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;currentVersion&quot; : 4,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;clusterId&quot; : ObjectId(&quot;5264c5c753b45824c363f402&quot;)}&nbsp;&nbsp;shards:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0000&quot;,&nbsp; &quot;host&quot; : &quot;shard0&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0001&quot;,&nbsp; &quot;host&quot; : &quot;rs1-0&quot; }&nbsp;&nbsp;databases:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;admin&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;config&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;test&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;mongo_demo&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;{Database name}&quot;,&nbsp; &quot;partitioned&quot; : true,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.EntendedProfiles&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.{Collection name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0)Additional notes&nbsp;Amazon EBS volumeIf we are setting up shards on Amazon: we need mount the Amazon EBS (Elastic Block Storage) and use the EBS to store Mongo logs and DB data, run the following command on a shard instance:sudo suFdisk -l &nbsp;#To examine all disk partitions, find the partition we want to mountmkfs -t ext4 /dev/xvdf &nbsp;# Format the partition to ext4 file format (/dev/xvdf could be /dev/sdb, /dev/sdh etc) mkdir /media/mongo_volume # Make the directory where we supposed to mount the partition and store MongoDB datamount /dev/xvdf /media/mongo_volume#Modify /etc/mongo.conf, ensure Mongo used the mounted partision to store logs and DB datalogpath=/media/mongo_volume/log/mongod.logdbpath=/media/mongo_volume/dbReplica set recovery notesThere are periodically heartbeats between replica sets and mongos server, once a primary/secondary gets down, mongos will try to reconnect.Thu Jan&nbsp; 9 02:00:13.308 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:13.311 [ReplicaSetMonitorWatcher] reconnect rs1-2 failed couldn&#39;t connect to server rs1-2Thu Jan&nbsp; 9 02:00:13.315 [Balancer] distributed lock &#39;balancer/ip-10-244-81-61:27017:1389060087:1804289383&#39; unlocked.Thu Jan&nbsp; 9 02:00:15.156 [WriteBackListener-rs1-2] WriteBackListener exception : socket exception [CONNECT_ERROR] for rs1-2...Thu Jan&nbsp; 9 02:00:28.341 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:28.344 [ReplicaSetMonitorWatcher] reconnect rs1-2 okThere are heartbeats between each member within a replica set, once a primary gets down, a election will occur automatically and one of them will become primary, the old primary will join back as secondary once recover:Thu Jan&nbsp; 9 02:09:34.825 [rsHealthPoll] replset info rs1-0 heartbeat failed, retryingThu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet info rs1-0 is down (or slow to respond):Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet member rs1-0 is now in state DOWNThu Jan&nbsp; 9 02:09:35.746 [rsMgr] replSet info electSelf 1Thu Jan&nbsp; 9 02:09:36.378 [rsMgr] replSet PRIMARY&nbsp;">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Wayne's Geek Life">
<meta property="og:title" content="Setup MongoDB with sharding infrastructure">
<meta property="og:url" content="https://wayneye.com/Setup_MongoDB_With_Sharding_Infrastructure">


  <meta property="og:description" content="The landscape&nbsp;Sharding is the strategy that MongoDB uses to horizentally scale the entire data store infrustructure and meet the demands of data,growth, the infrastructure can be demonstrated as image below:PreparationTo simulate a production like environment, a minimum number of 7 physical/virtual servers are required, the role of them are:3 for Mongo config servers1 for&nbsp;Mongo shard server (mongos)3 for a Mongo shard (Replica set), 1&nbsp;primary&nbsp;and 2&nbsp;secondary&nbsp;(or 1 secondary and 1 arbiter).Note: all the machines above need have mongod installed, for installation, refer: Install MongoDB.SetUp StepsConcentrated steps of setting up sharded MongoDB are summarized below;&nbsp;a complete tutorial from MongoDB&#39;s official website can be found at:&nbsp;Deploy a Sharded Cluster.:1. Setup Config serversudo mkdir -p /data/configdbsudo mongod --configsvr --dbpath /data/configdb --port 270192. Setup Mongo Shard server (mongos)mongos --configdb [config_server_ip/host]3. Setup Shard 1~NIn MangoDB production deployment, a &quot;shard&quot; should be a replica set, a&nbsp;typical &quot;three member&quot; replica sets architecture is like below:Or&quot;Three member&quot; essentially are three mongod processes with heartbeat and full replication between each other, they can run on one physical machine (for development/test use) or on separate machines (real production), this infrastructure provides &quot;additional fault tolerance and high availability&quot;.&nbsp;Setup primaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate() # or explicitly:&nbsp;rs.initiate({_id: &quot;rs1&quot;, members: [{_id: 0, host: &quot;rs1-1&quot;}]})rs.conf()rs.add(&quot;{secondary_host}&quot;)Setup secondaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate()rs.conf()Setup&nbsp;arbiterArbiter is like a &quot;guard process&quot; and consumers no dedicated hardware resource, for out concrete case, I setup arbiter on the mongos server.mkdir /var/lib/mongo/arb/mongod --port 30000 --dbpath /var/lib/mongo/arb/ --replSet rs0 --smallfilesConnect to the mongo shell of the primary and run:rs.addArb(&quot;{arbiter_host}:30000&quot;)&nbsp;Verificationrs.conf()rs0:PRIMARY&gt; rs.conf(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-2&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arbiterOnly&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}rs.status()rs0:PRIMARY&gt; rs.status(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;set&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;date&quot; : ISODate(&quot;2013-12-17T08:56:41Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;myState&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-2&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;SECONDARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 299,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:40Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2013-12-17T08:56:39Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;syncingTo&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-1&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;PRIMARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 317,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;self&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 8,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;(not reachable/healthy)&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:24Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ok&quot; : 1}Trouble shootingFor experimental made mistakes, we can run the following command on mongo config server to &quot;reset&quot; the sharding status:&gt; use config&gt; db.shards.drop()&nbsp;Official documentationsDeploy a replica setAdd an Arbiter to Replica Set&nbsp;Caveats: In real production environment, a minimum of&nbsp;3 replica-sets&nbsp;is required. With two nodes, it can get replication of data (i.e.: they will copy each other), but it will not get automatic fail-over or high availability, hence we should never run production data with less than 3 nodes!After replica set are all setup we can add it to mongo sharding server as a &quot;shard&quot;:First we need make sure the local mongod process is running on each shard, then we can use mongo shell to connect to the mongos server and tell the mongos add each shard respectively:mongo --host [mongos_server_ip/host]&gt; sh.addShard(&quot;[replSetName: e.g.&nbsp;rs0/[mongod_ip/port]&quot;) # e.g. sh.addShard(&quot;rs0/ &nbsp;For single mongod in development environment,&nbsp;sh.addShard(&quot;[shard_ip/host]:27017&quot;) #&nbsp;&gt; sh.enableSharding(&quot;[database]&quot;) # Sharding a database&gt; sh.shardCollection(&quot;[database].[collection]&quot;, shard-key-pattern) # Sharding a collection with a shard keyConcrete example of setting up a Mongo shard for &quot;Collection_Name&quot;mongo --host mongossh.addShard(&quot;rs1-0&quot;)sh.enableSharding(&quot;{Database name}&quot;)sh.shardCollection(&quot;{Database name}.{Collection name}&quot;, {user_id:1})#&nbsp;Verify the sharding status by running &quot;sh.status()&quot; in mongo shell:sh.status()mongos&gt; sh.status()--- Sharding Status --- &nbsp;&nbsp;sharding version: {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;minCompatibleVersion&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;currentVersion&quot; : 4,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;clusterId&quot; : ObjectId(&quot;5264c5c753b45824c363f402&quot;)}&nbsp;&nbsp;shards:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0000&quot;,&nbsp; &quot;host&quot; : &quot;shard0&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0001&quot;,&nbsp; &quot;host&quot; : &quot;rs1-0&quot; }&nbsp;&nbsp;databases:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;admin&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;config&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;test&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;mongo_demo&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;{Database name}&quot;,&nbsp; &quot;partitioned&quot; : true,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.EntendedProfiles&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.{Collection name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0)Additional notes&nbsp;Amazon EBS volumeIf we are setting up shards on Amazon: we need mount the Amazon EBS (Elastic Block Storage) and use the EBS to store Mongo logs and DB data, run the following command on a shard instance:sudo suFdisk -l &nbsp;#To examine all disk partitions, find the partition we want to mountmkfs -t ext4 /dev/xvdf &nbsp;# Format the partition to ext4 file format (/dev/xvdf could be /dev/sdb, /dev/sdh etc) mkdir /media/mongo_volume # Make the directory where we supposed to mount the partition and store MongoDB datamount /dev/xvdf /media/mongo_volume#Modify /etc/mongo.conf, ensure Mongo used the mounted partision to store logs and DB datalogpath=/media/mongo_volume/log/mongod.logdbpath=/media/mongo_volume/dbReplica set recovery notesThere are periodically heartbeats between replica sets and mongos server, once a primary/secondary gets down, mongos will try to reconnect.Thu Jan&nbsp; 9 02:00:13.308 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:13.311 [ReplicaSetMonitorWatcher] reconnect rs1-2 failed couldn&#39;t connect to server rs1-2Thu Jan&nbsp; 9 02:00:13.315 [Balancer] distributed lock &#39;balancer/ip-10-244-81-61:27017:1389060087:1804289383&#39; unlocked.Thu Jan&nbsp; 9 02:00:15.156 [WriteBackListener-rs1-2] WriteBackListener exception : socket exception [CONNECT_ERROR] for rs1-2...Thu Jan&nbsp; 9 02:00:28.341 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:28.344 [ReplicaSetMonitorWatcher] reconnect rs1-2 okThere are heartbeats between each member within a replica set, once a primary gets down, a election will occur automatically and one of them will become primary, the old primary will join back as secondary once recover:Thu Jan&nbsp; 9 02:09:34.825 [rsHealthPoll] replset info rs1-0 heartbeat failed, retryingThu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet info rs1-0 is down (or slow to respond):Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet member rs1-0 is now in state DOWNThu Jan&nbsp; 9 02:09:35.746 [rsMgr] replSet info electSelf 1Thu Jan&nbsp; 9 02:09:36.378 [rsMgr] replSet PRIMARY&nbsp;">





  <meta name="twitter:site" content="@wayneye">
  <meta name="twitter:title" content="Setup MongoDB with sharding infrastructure">
  <meta name="twitter:description" content="The landscape&nbsp;Sharding is the strategy that MongoDB uses to horizentally scale the entire data store infrustructure and meet the demands of data,growth, the infrastructure can be demonstrated as image below:PreparationTo simulate a production like environment, a minimum number of 7 physical/virtual servers are required, the role of them are:3 for Mongo config servers1 for&nbsp;Mongo shard server (mongos)3 for a Mongo shard (Replica set), 1&nbsp;primary&nbsp;and 2&nbsp;secondary&nbsp;(or 1 secondary and 1 arbiter).Note: all the machines above need have mongod installed, for installation, refer: Install MongoDB.SetUp StepsConcentrated steps of setting up sharded MongoDB are summarized below;&nbsp;a complete tutorial from MongoDB&#39;s official website can be found at:&nbsp;Deploy a Sharded Cluster.:1. Setup Config serversudo mkdir -p /data/configdbsudo mongod --configsvr --dbpath /data/configdb --port 270192. Setup Mongo Shard server (mongos)mongos --configdb [config_server_ip/host]3. Setup Shard 1~NIn MangoDB production deployment, a &quot;shard&quot; should be a replica set, a&nbsp;typical &quot;three member&quot; replica sets architecture is like below:Or&quot;Three member&quot; essentially are three mongod processes with heartbeat and full replication between each other, they can run on one physical machine (for development/test use) or on separate machines (real production), this infrastructure provides &quot;additional fault tolerance and high availability&quot;.&nbsp;Setup primaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate() # or explicitly:&nbsp;rs.initiate({_id: &quot;rs1&quot;, members: [{_id: 0, host: &quot;rs1-1&quot;}]})rs.conf()rs.add(&quot;{secondary_host}&quot;)Setup secondaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate()rs.conf()Setup&nbsp;arbiterArbiter is like a &quot;guard process&quot; and consumers no dedicated hardware resource, for out concrete case, I setup arbiter on the mongos server.mkdir /var/lib/mongo/arb/mongod --port 30000 --dbpath /var/lib/mongo/arb/ --replSet rs0 --smallfilesConnect to the mongo shell of the primary and run:rs.addArb(&quot;{arbiter_host}:30000&quot;)&nbsp;Verificationrs.conf()rs0:PRIMARY&gt; rs.conf(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-2&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arbiterOnly&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}rs.status()rs0:PRIMARY&gt; rs.status(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;set&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;date&quot; : ISODate(&quot;2013-12-17T08:56:41Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;myState&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-2&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;SECONDARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 299,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:40Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2013-12-17T08:56:39Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;syncingTo&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-1&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;PRIMARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 317,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;self&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 8,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;(not reachable/healthy)&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:24Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ok&quot; : 1}Trouble shootingFor experimental made mistakes, we can run the following command on mongo config server to &quot;reset&quot; the sharding status:&gt; use config&gt; db.shards.drop()&nbsp;Official documentationsDeploy a replica setAdd an Arbiter to Replica Set&nbsp;Caveats: In real production environment, a minimum of&nbsp;3 replica-sets&nbsp;is required. With two nodes, it can get replication of data (i.e.: they will copy each other), but it will not get automatic fail-over or high availability, hence we should never run production data with less than 3 nodes!After replica set are all setup we can add it to mongo sharding server as a &quot;shard&quot;:First we need make sure the local mongod process is running on each shard, then we can use mongo shell to connect to the mongos server and tell the mongos add each shard respectively:mongo --host [mongos_server_ip/host]&gt; sh.addShard(&quot;[replSetName: e.g.&nbsp;rs0/[mongod_ip/port]&quot;) # e.g. sh.addShard(&quot;rs0/ &nbsp;For single mongod in development environment,&nbsp;sh.addShard(&quot;[shard_ip/host]:27017&quot;) #&nbsp;&gt; sh.enableSharding(&quot;[database]&quot;) # Sharding a database&gt; sh.shardCollection(&quot;[database].[collection]&quot;, shard-key-pattern) # Sharding a collection with a shard keyConcrete example of setting up a Mongo shard for &quot;Collection_Name&quot;mongo --host mongossh.addShard(&quot;rs1-0&quot;)sh.enableSharding(&quot;{Database name}&quot;)sh.shardCollection(&quot;{Database name}.{Collection name}&quot;, {user_id:1})#&nbsp;Verify the sharding status by running &quot;sh.status()&quot; in mongo shell:sh.status()mongos&gt; sh.status()--- Sharding Status --- &nbsp;&nbsp;sharding version: {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;minCompatibleVersion&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;currentVersion&quot; : 4,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;clusterId&quot; : ObjectId(&quot;5264c5c753b45824c363f402&quot;)}&nbsp;&nbsp;shards:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0000&quot;,&nbsp; &quot;host&quot; : &quot;shard0&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0001&quot;,&nbsp; &quot;host&quot; : &quot;rs1-0&quot; }&nbsp;&nbsp;databases:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;admin&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;config&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;test&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;mongo_demo&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;{Database name}&quot;,&nbsp; &quot;partitioned&quot; : true,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.EntendedProfiles&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.{Collection name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0)Additional notes&nbsp;Amazon EBS volumeIf we are setting up shards on Amazon: we need mount the Amazon EBS (Elastic Block Storage) and use the EBS to store Mongo logs and DB data, run the following command on a shard instance:sudo suFdisk -l &nbsp;#To examine all disk partitions, find the partition we want to mountmkfs -t ext4 /dev/xvdf &nbsp;# Format the partition to ext4 file format (/dev/xvdf could be /dev/sdb, /dev/sdh etc) mkdir /media/mongo_volume # Make the directory where we supposed to mount the partition and store MongoDB datamount /dev/xvdf /media/mongo_volume#Modify /etc/mongo.conf, ensure Mongo used the mounted partision to store logs and DB datalogpath=/media/mongo_volume/log/mongod.logdbpath=/media/mongo_volume/dbReplica set recovery notesThere are periodically heartbeats between replica sets and mongos server, once a primary/secondary gets down, mongos will try to reconnect.Thu Jan&nbsp; 9 02:00:13.308 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:13.311 [ReplicaSetMonitorWatcher] reconnect rs1-2 failed couldn&#39;t connect to server rs1-2Thu Jan&nbsp; 9 02:00:13.315 [Balancer] distributed lock &#39;balancer/ip-10-244-81-61:27017:1389060087:1804289383&#39; unlocked.Thu Jan&nbsp; 9 02:00:15.156 [WriteBackListener-rs1-2] WriteBackListener exception : socket exception [CONNECT_ERROR] for rs1-2...Thu Jan&nbsp; 9 02:00:28.341 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:28.344 [ReplicaSetMonitorWatcher] reconnect rs1-2 okThere are heartbeats between each member within a replica set, once a primary gets down, a election will occur automatically and one of them will become primary, the old primary will join back as secondary once recover:Thu Jan&nbsp; 9 02:09:34.825 [rsHealthPoll] replset info rs1-0 heartbeat failed, retryingThu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet info rs1-0 is down (or slow to respond):Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet member rs1-0 is now in state DOWNThu Jan&nbsp; 9 02:09:35.746 [rsMgr] replSet info electSelf 1Thu Jan&nbsp; 9 02:09:36.378 [rsMgr] replSet PRIMARY&nbsp;">
  <meta name="twitter:url" content="https://wayneye.com/Setup_MongoDB_With_Sharding_Infrastructure">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2013-10-03T00:00:00-07:00">





  

  
    <meta property="fb:app_id" content="374223339969060">
  


<link rel="canonical" href="https://wayneye.com/Setup_MongoDB_With_Sharding_Infrastructure">













<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Wayne's Geek Life Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon/favicon-16x16.png">
<link rel="manifest" href="assets/images/favicon/site.webmanifest">
<link rel="mask-icon" href="assets/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">Wayne's Geek Life</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/search/" >Search</a>
            </li><li class="masthead__menu-item">
              <a href="/album/" >Album</a>
            </li><li class="masthead__menu-item">
              <a href="/about" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/me.jpg" alt="Wayne Ye" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Wayne Ye</h3>
    
    
      <p class="author__bio" itemprop="description">
        Whatever is worth doing is worth doing well!
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">San Francisco</span>
        </li>
      

      
        
          
            <li><a href="mailto:me@wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
          
        
          
            <li><a href="https://wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> Website</a></li>
          
        
          
            <li><a href="https://twitter.com/wayneye" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://facebook.com/WayneYeDotCom" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
          
        
          
            <li><a href="https://github.com/WayneYe/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Setup MongoDB with sharding infrastructure">
    <meta itemprop="description" content="The landscape&nbsp;Sharding is the strategy that MongoDB uses to horizentally scale the entire data store infrustructure and meet the demands of data,growth, the infrastructure can be demonstrated as image below:PreparationTo simulate a production like environment, a minimum number of 7 physical/virtual servers are required, the role of them are:3 for Mongo config servers1 for&nbsp;Mongo shard server (mongos)3 for a Mongo shard (Replica set), 1&nbsp;primary&nbsp;and 2&nbsp;secondary&nbsp;(or 1 secondary and 1 arbiter).Note: all the machines above need have mongod installed, for installation, refer: Install MongoDB.SetUp StepsConcentrated steps of setting up sharded MongoDB are summarized below;&nbsp;a complete tutorial from MongoDB&#39;s official website can be found at:&nbsp;Deploy a Sharded Cluster.:1. Setup Config serversudo mkdir -p /data/configdbsudo mongod --configsvr --dbpath /data/configdb --port 270192. Setup Mongo Shard server (mongos)mongos --configdb [config_server_ip/host]3. Setup Shard 1~NIn MangoDB production deployment, a &quot;shard&quot; should be a replica set, a&nbsp;typical &quot;three member&quot; replica sets architecture is like below:Or&quot;Three member&quot; essentially are three mongod processes with heartbeat and full replication between each other, they can run on one physical machine (for development/test use) or on separate machines (real production), this infrastructure provides &quot;additional fault tolerance and high availability&quot;.&nbsp;Setup primaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate() # or explicitly:&nbsp;rs.initiate({_id: &quot;rs1&quot;, members: [{_id: 0, host: &quot;rs1-1&quot;}]})rs.conf()rs.add(&quot;{secondary_host}&quot;)Setup secondaryModify /etc/mongo.conf and ensure the following value are set correctly:port = 27017bind_ip = 0.0.0.0dbpath = /media/mongo_volume/db/fork = truereplSet = rs0Start the mongod process:mongod --config /etc/mongodb.confrs.initiate()rs.conf()Setup&nbsp;arbiterArbiter is like a &quot;guard process&quot; and consumers no dedicated hardware resource, for out concrete case, I setup arbiter on the mongos server.mkdir /var/lib/mongo/arb/mongod --port 30000 --dbpath /var/lib/mongo/arb/ --replSet rs0 --smallfilesConnect to the mongo shell of the primary and run:rs.addArb(&quot;{arbiter_host}:30000&quot;)&nbsp;Verificationrs.conf()rs0:PRIMARY&gt; rs.conf(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-2&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arbiterOnly&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}rs.status()rs0:PRIMARY&gt; rs.status(){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;set&quot; : &quot;rs0&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;date&quot; : ISODate(&quot;2013-12-17T08:56:41Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;myState&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;members&quot; : [&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-2&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;SECONDARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 299,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:40Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;2013-12-17T08:56:39Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;syncingTo&quot; : &quot;rs1-1&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;rs1-1&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;PRIMARY&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 317,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optime&quot; : Timestamp(1387270069, 1),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;optimeDate&quot; : ISODate(&quot;2013-12-17T08:47:49Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;self&quot; : true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;name&quot; : &quot;mongos&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;health&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;state&quot; : 8,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stateStr&quot; : &quot;(not reachable/healthy)&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uptime&quot; : 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeat&quot; : ISODate(&quot;2013-12-17T08:56:24Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;lastHeartbeatRecv&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pingMs&quot; : 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ok&quot; : 1}Trouble shootingFor experimental made mistakes, we can run the following command on mongo config server to &quot;reset&quot; the sharding status:&gt; use config&gt; db.shards.drop()&nbsp;Official documentationsDeploy a replica setAdd an Arbiter to Replica Set&nbsp;Caveats: In real production environment, a minimum of&nbsp;3 replica-sets&nbsp;is required. With two nodes, it can get replication of data (i.e.: they will copy each other), but it will not get automatic fail-over or high availability, hence we should never run production data with less than 3 nodes!After replica set are all setup we can add it to mongo sharding server as a &quot;shard&quot;:First we need make sure the local mongod process is running on each shard, then we can use mongo shell to connect to the mongos server and tell the mongos add each shard respectively:mongo --host [mongos_server_ip/host]&gt; sh.addShard(&quot;[replSetName: e.g.&nbsp;rs0/[mongod_ip/port]&quot;) # e.g. sh.addShard(&quot;rs0/ &nbsp;For single mongod in development environment,&nbsp;sh.addShard(&quot;[shard_ip/host]:27017&quot;) #&nbsp;&gt; sh.enableSharding(&quot;[database]&quot;) # Sharding a database&gt; sh.shardCollection(&quot;[database].[collection]&quot;, shard-key-pattern) # Sharding a collection with a shard keyConcrete example of setting up a Mongo shard for &quot;Collection_Name&quot;mongo --host mongossh.addShard(&quot;rs1-0&quot;)sh.enableSharding(&quot;{Database name}&quot;)sh.shardCollection(&quot;{Database name}.{Collection name}&quot;, {user_id:1})#&nbsp;Verify the sharding status by running &quot;sh.status()&quot; in mongo shell:sh.status()mongos&gt; sh.status()--- Sharding Status --- &nbsp;&nbsp;sharding version: {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_id&quot; : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;version&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;minCompatibleVersion&quot; : 3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;currentVersion&quot; : 4,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;clusterId&quot; : ObjectId(&quot;5264c5c753b45824c363f402&quot;)}&nbsp;&nbsp;shards:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0000&quot;,&nbsp; &quot;host&quot; : &quot;shard0&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;shard0001&quot;,&nbsp; &quot;host&quot; : &quot;rs1-0&quot; }&nbsp;&nbsp;databases:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;admin&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;config&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;test&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;mongo_demo&quot;,&nbsp; &quot;partitioned&quot; : false,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp; &quot;_id&quot; : &quot;{Database name}&quot;,&nbsp; &quot;partitioned&quot; : true,&nbsp; &quot;primary&quot; : &quot;shard0000&quot; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.EntendedProfiles&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Database name}.{Collection name}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard key: { &quot;user_id&quot; : 1 }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunks:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;user_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;user_id&quot; : { &quot;$maxKey&quot; : 1 } } on : shard0000 Timestamp(1, 0)Additional notes&nbsp;Amazon EBS volumeIf we are setting up shards on Amazon: we need mount the Amazon EBS (Elastic Block Storage) and use the EBS to store Mongo logs and DB data, run the following command on a shard instance:sudo suFdisk -l &nbsp;#To examine all disk partitions, find the partition we want to mountmkfs -t ext4 /dev/xvdf &nbsp;# Format the partition to ext4 file format (/dev/xvdf could be /dev/sdb, /dev/sdh etc) mkdir /media/mongo_volume # Make the directory where we supposed to mount the partition and store MongoDB datamount /dev/xvdf /media/mongo_volume#Modify /etc/mongo.conf, ensure Mongo used the mounted partision to store logs and DB datalogpath=/media/mongo_volume/log/mongod.logdbpath=/media/mongo_volume/dbReplica set recovery notesThere are periodically heartbeats between replica sets and mongos server, once a primary/secondary gets down, mongos will try to reconnect.Thu Jan&nbsp; 9 02:00:13.308 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:13.311 [ReplicaSetMonitorWatcher] reconnect rs1-2 failed couldn&#39;t connect to server rs1-2Thu Jan&nbsp; 9 02:00:13.315 [Balancer] distributed lock &#39;balancer/ip-10-244-81-61:27017:1389060087:1804289383&#39; unlocked.Thu Jan&nbsp; 9 02:00:15.156 [WriteBackListener-rs1-2] WriteBackListener exception : socket exception [CONNECT_ERROR] for rs1-2...Thu Jan&nbsp; 9 02:00:28.341 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2Thu Jan&nbsp; 9 02:00:28.344 [ReplicaSetMonitorWatcher] reconnect rs1-2 okThere are heartbeats between each member within a replica set, once a primary gets down, a election will occur automatically and one of them will become primary, the old primary will join back as secondary once recover:Thu Jan&nbsp; 9 02:09:34.825 [rsHealthPoll] replset info rs1-0 heartbeat failed, retryingThu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet info rs1-0 is down (or slow to respond):Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet member rs1-0 is now in state DOWNThu Jan&nbsp; 9 02:09:35.746 [rsMgr] replSet info electSelf 1Thu Jan&nbsp; 9 02:09:36.378 [rsMgr] replSet PRIMARY&nbsp;">
    <meta itemprop="datePublished" content="October 03, 2013">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Setup MongoDB with sharding infrastructure
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#SettingupMongoDBwithshardinginfrastructure-Thelandscape">The landscapeÂ </a></li>
  <li><a href="#SettingupMongoDBwithshardinginfrastructure-Preparation">Preparation</a></li>
  <li><a href="#SettingupMongoDBwithshardinginfrastructure-SetUpSteps">SetUp Steps</a>
    <ul>
      <li><a href="#SettingupMongoDBwithshardinginfrastructure-1.SetupConfigserver">1. Setup Config server</a></li>
      <li><a href="#SettingupMongoDBwithshardinginfrastructure-2.SetupMongoShardserver%28mongos%29">2. Setup Mongo Shard server (mongos)</a></li>
      <li><a href="#SettingupMongoDBwithshardinginfrastructure-3.SetupShard1~N">3. Setup Shard 1~N</a>
        <ul>
          <li><a href="#SettingupMongoDBwithshardinginfrastructure-Setupprimary">Setup primary</a></li>
          <li><a href="#SettingupMongoDBwithshardinginfrastructure-Setupsecondary">Setup secondary</a></li>
          <li><a href="#SettingupMongoDBwithshardinginfrastructure-Setuparbiter">SetupÂ arbiter</a></li>
          <li><a href="#SettingupMongoDBwithshardinginfrastructure-Verification">Verification</a></li>
          <li><a href="#SettingupMongoDBwithshardinginfrastructure-Troubleshooting">Trouble shooting</a></li>
          <li><a href="#SettingupMongoDBwithshardinginfrastructure-Officialdocumentations">Official documentations</a></li>
          <li><a href="#SettingupMongoDBwithshardinginfrastructure-FinalinfrastructureforOxygen%27s{Collection name}">Additional notesÂ </a></li>
        </ul>
      </li>
      <li><a href="#SettingupMongoDBwithshardinginfrastructure-AmazonEBSvolume">Amazon EBS volume</a></li>
      <li><a href="#SettingupMongoDBwithshardinginfrastructure-Replicasetrecoverynotes">Replica set recovery notes</a></li>
    </ul>
  </li>
</ul>
            </nav>
          </aside>
        
        <h2 id="SettingupMongoDBwithshardinginfrastructure-Thelandscape">The landscape&nbsp;</h2>
<p>Sharding is the strategy that MongoDB uses to horizentally scale the entire data store infrustructure and meet the demands of data,growth, the infrastructure can be demonstrated as image below:</p>
<p><img class="confluence-embedded-image" alt="sharding" src="https://ejlfia.dm2301.livefilestore.com/y2p9rDBHBoQyOPgwqzq_r8IFm0VjCKQcXtIBeV1CqrWSCZys2zy3HoAkcRGctX2nuet133GdHvphYKi7tXLqYNYqu3TyHwBYOd65E0_1UIhDoE/ShardReplica.jpg?psid=1" /></p>
<h2 id="SettingupMongoDBwithshardinginfrastructure-Preparation">Preparation</h2>
<p>To simulate a production like environment, a minimum number of <strong>7 physical/virtual servers</strong> are required, the role of them are:</p>
<ul>
<li><strong>3 for Mongo config servers</strong></li>
<li><strong>1 for&nbsp;Mongo shard server (mongos)</strong></li>
<li><strong>3 for a Mongo shard (<strong>Replica set</strong>), 1&nbsp;<strong><a class="external-link" href="http://docs.mongodb.org/manual/reference/glossary/#term-primary" rel="nofollow">primary&nbsp;</a>and 2&nbsp;<a class="external-link" href="http://docs.mongodb.org/manual/reference/glossary/#term-secondary" rel="nofollow">secondary</a>&nbsp;(or 1 secondary and 1 arbiter).</strong></strong></li>
</ul>
<p>Note: all the machines above need have <em>mongod</em> installed, for installation, refer: <a class="external-link" href="http://docs.mongodb.org/manual/installation/" rel="nofollow">Install MongoDB</a>.</p>
<!--more-->
<h2 id="SettingupMongoDBwithshardinginfrastructure-SetUpSteps">SetUp Steps</h2>
<p>Concentrated steps of setting up sharded MongoDB are summarized below;&nbsp;a complete tutorial from MongoDB's official website can be found at:&nbsp;<strong><a class="external-link" href="http://docs.mongodb.org/manual/tutorial/deploy-shard-cluster/" rel="nofollow">Deploy a Sharded Cluster</a></strong>.:</p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-1.SetupConfigserver">1. Setup Config server</h3>
<p>sudo mkdir -p /data/configdb<br />sudo mongod --configsvr --dbpath /data/configdb --port 27019</p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-2.SetupMongoShardserver%28mongos%29">2. Setup Mongo Shard server (mongos)</h3>
<p>mongos --configdb [config_server_ip/host]</p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-3.SetupShard1~N">3. Setup Shard 1~N</h3>
<p>In MangoDB production deployment, a "shard" should be a replica set, a<span style="background-color: transparent; line-height: 1.4285715;">&nbsp;typical "three member" replica sets architecture is like below:</span></p>
<p><img class="confluence-embedded-image confluence-external-resource" alt="" src="http://docs.mongodb.org/master/_images/replica-set-primary-with-two-secondaries.png" data-image-src="http://docs.mongodb.org/master/_images/replica-set-primary-with-two-secondaries.png" /></p>
<p>Or</p>
<p><img class="confluence-embedded-image confluence-external-resource" alt="" src="http://docs.mongodb.org/master/_images/replica-set-primary-with-secondary-and-arbiter.png" data-image-src="http://docs.mongodb.org/master/_images/replica-set-primary-with-secondary-and-arbiter.png" /></p>
<p>"Three member" essentially are three <strong><em>mongod</em> </strong>processes with heartbeat and full replication between each other, they can run on one physical machine (for development/test use) or on separate machines (real production), this infrastructure provides "<strong>additional fault tolerance and high availability</strong>".&nbsp;</p>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Setupprimary">Setup primary</h4>
<ol>
<li>
<p>Modify /etc/mongo.conf and ensure the following value are set correctly:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_663228" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">port = 27017</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">bind_ip = 0.0.0.0</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">dbpath = </code><code class="bash plain">/media/mongo_volume/db/</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">fork = </code><code class="bash functions">true</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">replSet = rs0</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
<li>Start the mongod process:<br /><em>mongod --config /etc/mongodb.conf</em></li>
<li>rs.initiate() # or explicitly:&nbsp;rs.initiate({_id: "rs1", members: [{_id: 0, host: "rs1-1"}]})</li>
<li>rs.conf()</li>
<li>rs.add("{secondary_host}")</li>
</ol>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Setupsecondary">Setup secondary</h4>
<ol>
<li>
<p>Modify /etc/mongo.conf and ensure the following value are set correctly:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_193651" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">port = 27017</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">bind_ip = 0.0.0.0</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">dbpath = </code><code class="bash plain">/media/mongo_volume/db/</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">fork = </code><code class="bash functions">true</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">replSet = rs0</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</li>
<li>Start the mongod process:<br /><em>mongod --config /etc/mongodb.conf</em></li>
<li>rs.initiate()</li>
<li>rs.conf()</li>
</ol>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Setuparbiter">Setup&nbsp;<a class="external-link" href="http://docs.mongodb.org/manual/core/replica-set-arbiter/" rel="nofollow">arbiter</a></h4>
<p>Arbiter is like a "guard process" and consumers no dedicated hardware resource, for out concrete case, I setup arbiter on the mongos server.</p>
<ol>
<li>mkdir /var/lib/mongo/arb/</li>
<li>mongod --port 30000 --dbpath /var/lib/mongo/arb/ --replSet rs0 --smallfiles</li>
<li>Connect to the mongo shell of the primary and run:<br />rs.addArb("{arbiter_host}<a class="external-link" href="http://net:30000/" rel="nofollow">:30000</a>")&nbsp;</li>
</ol>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Verification">Verification</h4>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>rs.conf()</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_41421" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">rs0:PRIMARY&gt; rs.conf()</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">{</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"rs0"</code><code class="bash plain">,</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"version"</code> <code class="bash plain">: 3,</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"members"</code> <code class="bash plain">: [</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 0,</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"rs1-2"</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 1,</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"rs1-1"</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 2,</code></div>
<div class="line number16 index15 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"mongos"</code><code class="bash plain">,</code></div>
<div class="line number17 index16 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"arbiterOnly"</code> <code class="bash plain">: </code><code class="bash functions">true</code></div>
<div class="line number18 index17 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div>
<div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">]</code></div>
<div class="line number20 index19 alt1"><code class="bash plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>rs.status()</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_945508" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">rs0:PRIMARY&gt; rs.status()</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">{</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"set"</code> <code class="bash plain">: </code><code class="bash string">"rs0"</code><code class="bash plain">,</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"date"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:41Z"</code><code class="bash plain">),</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"myState"</code> <code class="bash plain">: 1,</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"members"</code> <code class="bash plain">: [</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 0,</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"name"</code> <code class="bash plain">: </code><code class="bash string">"rs1-2"</code><code class="bash plain">,</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"health"</code> <code class="bash plain">: 1,</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"state"</code> <code class="bash plain">: 2,</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"stateStr"</code> <code class="bash plain">: </code><code class="bash string">"SECONDARY"</code><code class="bash plain">,</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"uptime"</code> <code class="bash plain">: 299,</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optime"</code> <code class="bash plain">: Timestamp(1387270069, 1),</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optimeDate"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:47:49Z"</code><code class="bash plain">),</code></div>
<div class="line number16 index15 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeat"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:40Z"</code><code class="bash plain">),</code></div>
<div class="line number17 index16 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeatRecv"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:39Z"</code><code class="bash plain">),</code></div>
<div class="line number18 index17 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"pingMs"</code> <code class="bash plain">: 0,</code></div>
<div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"syncingTo"</code> <code class="bash plain">: </code><code class="bash string">"rs1-1"</code></div>
<div class="line number20 index19 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number21 index20 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number22 index21 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 1,</code></div>
<div class="line number23 index22 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"name"</code> <code class="bash plain">: </code><code class="bash string">"rs1-1"</code><code class="bash plain">,</code></div>
<div class="line number24 index23 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"health"</code> <code class="bash plain">: 1,</code></div>
<div class="line number25 index24 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"state"</code> <code class="bash plain">: 1,</code></div>
<div class="line number26 index25 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"stateStr"</code> <code class="bash plain">: </code><code class="bash string">"PRIMARY"</code><code class="bash plain">,</code></div>
<div class="line number27 index26 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"uptime"</code> <code class="bash plain">: 317,</code></div>
<div class="line number28 index27 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optime"</code> <code class="bash plain">: Timestamp(1387270069, 1),</code></div>
<div class="line number29 index28 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"optimeDate"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:47:49Z"</code><code class="bash plain">),</code></div>
<div class="line number30 index29 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"self"</code> <code class="bash plain">: </code><code class="bash functions">true</code></div>
<div class="line number31 index30 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">},</code></div>
<div class="line number32 index31 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{</code></div>
<div class="line number33 index32 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 2,</code></div>
<div class="line number34 index33 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"name"</code> <code class="bash plain">: </code><code class="bash string">"mongos"</code><code class="bash plain">,</code></div>
<div class="line number35 index34 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"health"</code> <code class="bash plain">: 0,</code></div>
<div class="line number36 index35 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"state"</code> <code class="bash plain">: 8,</code></div>
<div class="line number37 index36 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"stateStr"</code> <code class="bash plain">: </code><code class="bash string">"(not reachable/healthy)"</code><code class="bash plain">,</code></div>
<div class="line number38 index37 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"uptime"</code> <code class="bash plain">: 0,</code></div>
<div class="line number39 index38 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeat"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"2013-12-17T08:56:24Z"</code><code class="bash plain">),</code></div>
<div class="line number40 index39 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"lastHeartbeatRecv"</code> <code class="bash plain">: ISODate(</code><code class="bash string">"1970-01-01T00:00:00Z"</code><code class="bash plain">),</code></div>
<div class="line number41 index40 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"pingMs"</code> <code class="bash plain">: 0</code></div>
<div class="line number42 index41 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">}</code></div>
<div class="line number43 index42 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">],</code></div>
<div class="line number44 index43 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"ok"</code> <code class="bash plain">: 1</code></div>
<div class="line number45 index44 alt2"><code class="bash plain">}</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Troubleshooting">Trouble shooting</h4>
<p>For experimental made mistakes, we can run the following command on mongo config server to "reset" the sharding status:</p>
<p><em>&gt; use config</em><br /><em>&gt; db.shards.drop()&nbsp;</em></p>
<h4 id="SettingupMongoDBwithshardinginfrastructure-Officialdocumentations">Official documentations</h4>
<ul>
<li><a class="external-link" href="http://docs.mongodb.org/manual/tutorial/deploy-replica-set/" rel="nofollow">Deploy a replica set</a></li>
<li><a class="external-link" href="http://docs.mongodb.org/manual/tutorial/add-replica-set-arbiter/" rel="nofollow">Add an Arbiter to Replica Set</a>&nbsp;</li>
</ul>
<blockquote><strong>Caveats</strong>: In real production environment, a minimum of&nbsp;<strong>3 replica-sets</strong>&nbsp;is required. With two nodes, it can get replication of data (i.e.: they will copy each other), but it will not get automatic fail-over or high availability, hence we should never run production data with less than 3 nodes!</blockquote>
<p>After replica set are all setup we can add it to mongo sharding server as a "<strong>shard</strong>":</p>
<p>First we need make sure the local mongod process is running on each shard, then we can use mongo shell to connect to the mongos server and tell the mongos add each shard respectively:<br /><em>mongo --host [mongos_server_ip/host]</em></p>
<p><em style="line-height: 1.4285715;">&gt; <em>sh.addShard("[<strong>replSetName</strong>: e.g.&nbsp;rs0/[<strong>mongod_ip</strong>/port]") # e.g. sh.addShard("rs0/ &nbsp;</em><em>For single mongod in development environment,&nbsp;</em>sh.addShard("[shard_ip/host]:27017") #&nbsp;</em></p>
<p><em>&gt; sh.enableSharding("[database]") # Sharding a database</em><br /><em>&gt; sh.shardCollection("[database].[collection]", shard-key-pattern) # Sharding a collection with a shard key</em></p>
<p>Concrete example of setting up a Mongo shard for "Collection_Name"<br /><em>mongo --host mongos</em><br /><em>sh.addShard("rs1-0")</em><br /><em>sh.enableSharding("{Database name}")</em><br /><em>sh.shardCollection("{Database name}.{Collection name}", {user_id:1})</em></p>
<p>#&nbsp;Verify the sharding status by running "<strong><em>sh.status()</em></strong>" in mongo shell:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>sh.status()</b></div>
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_466316" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">mongos&gt; sh.status()</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">--- Sharding Status --- </code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">sharding version: {</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"_id"</code> <code class="bash plain">: 1,</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"version"</code> <code class="bash plain">: 3,</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"minCompatibleVersion"</code> <code class="bash plain">: 3,</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"currentVersion"</code> <code class="bash plain">: 4,</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash string">"clusterId"</code> <code class="bash plain">: ObjectId(</code><code class="bash string">"5264c5c753b45824c363f402"</code><code class="bash plain">)</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">}</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">shards:</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"shard0"</code> <code class="bash plain">}</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"shard0001"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"host"</code> <code class="bash plain">: </code><code class="bash string">"rs1-0"</code> <code class="bash plain">}</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">databases:</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"admin"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">false</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"config"</code> <code class="bash plain">}</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"test"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">false</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code> <code class="bash plain">}</code></div>
<div class="line number16 index15 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"mongo_demo"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">false</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code> <code class="bash plain">}</code></div>
<div class="line number17 index16 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{&nbsp; </code><code class="bash string">"_id"</code> <code class="bash plain">: </code><code class="bash string">"{Database name}"</code><code class="bash plain">,&nbsp; </code><code class="bash string">"partitioned"</code> <code class="bash plain">: </code><code class="bash functions">true</code><code class="bash plain">,&nbsp; </code><code class="bash string">"primary"</code> <code class="bash plain">: </code><code class="bash string">"shard0000"</code> <code class="bash plain">}</code></div>
<div class="line number18 index17 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{Database name}.EntendedProfiles</code></div>
<div class="line number19 index18 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard key: { </code><code class="bash string">"user_id"</code> <code class="bash plain">: 1 }</code></div>
<div class="line number20 index19 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chunks:</code></div>
<div class="line number21 index20 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</code></div>
<div class="line number22 index21 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{ </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$minKey"</code> <code class="bash plain">: 1 } } --&gt;&gt; { </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$maxKey"</code> <code class="bash plain">: 1 } } on : shard0000 Timestamp(1, 0) </code></div>
<div class="line number23 index22 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{Database name}.{Collection name}</code></div>
<div class="line number24 index23 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard key: { </code><code class="bash string">"user_id"</code> <code class="bash plain">: 1 }</code></div>
<div class="line number25 index24 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chunks:</code></div>
<div class="line number26 index25 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">shard0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</code></div>
<div class="line number27 index26 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">{ </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$minKey"</code> <code class="bash plain">: 1 } } --&gt;&gt; { </code><code class="bash string">"user_id"</code> <code class="bash plain">: { </code><code class="bash string">"$maxKey"</code> <code class="bash plain">: 1 } } on : shard0000 Timestamp(1, 0)</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<h4 id="SettingupMongoDBwithshardinginfrastructure-FinalinfrastructureforOxygen%27s{Collection name}"><span style="font-size: 1.5em;">Additional notes&nbsp;</span></h4>
<h3 id="SettingupMongoDBwithshardinginfrastructure-AmazonEBSvolume"><span style="background-color: transparent; line-height: 1.4285715;">Amazon EBS volume</span></h3>
<p><span style="background-color: transparent; line-height: 1.4285715;">If we are setting up shards on Amazon: we need mount the Amazon </span><strong style="background-color: transparent; line-height: 1.4285715;">EBS</strong><span style="background-color: transparent; line-height: 1.4285715;"> (Elastic Block Storage) and use the EBS to store Mongo logs and DB data, run the following command on a shard instance:</span></p>
<p><em>sudo su</em><br /><em>Fdisk -l &nbsp;#To examine all disk partitions, find the partition we want to mount</em><br /><em>mkfs -t ext4 /dev/xvdf &nbsp;# Format the partition to ext4 file format (/dev/xvdf could be /dev/sdb, /dev/sdh etc) </em><br /><em>mkdir /media/mongo_volume # Make the directory where we supposed to mount the partition and store MongoDB data</em><br /><em>mount /dev/xvdf /media/mongo_volume</em></p>
<p>#Modify /etc/mongo.conf, ensure Mongo used the mounted partision to store logs and DB data<br /><em>logpath=/media/mongo_volume/log/mongod.log</em><br /><em>dbpath=/media/mongo_volume/db</em></p>
<h3 id="SettingupMongoDBwithshardinginfrastructure-Replicasetrecoverynotes">Replica set recovery notes</h3>
<p>There are periodically heartbeats between replica sets and mongos server, once a primary/secondary gets down, mongos will try to reconnect.</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_755250" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:00:13.308 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:00:13.311 [ReplicaSetMonitorWatcher] reconnect rs1-2 failed couldn't connect to server rs1-2</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:00:13.315 [Balancer] distributed lock </code><code class="bash string">'balancer/ip-10-244-81-61:27017:1389060087:1804289383'</code> <code class="bash plain">unlocked.</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:00:15.156 [WriteBackListener-rs1-2] WriteBackListener exception : socket exception [CONNECT_ERROR] </code><code class="bash keyword">for</code> <code class="bash plain">rs1-2</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">...</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:00:28.341 [ReplicaSetMonitorWatcher] trying reconnect to rs1-2</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:00:28.344 [ReplicaSetMonitorWatcher] reconnect rs1-2 ok</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>There are heartbeats between each member within a replica set, once a primary gets down, a election will occur automatically and one of them will become primary, the old primary will join back as secondary once recover:</p>
<div class="code panel pdl" style="border-width: 1px;">
<div class="codeContent panelContent pdl">
<div>
<div id="highlighter_975735" class="syntaxhighlighter nogutter  bash">
<table border="0">
<tbody>
<tr>
<td class="code">
<div class="container" title="Hint: double-click to select code">
<div class="line number1 index0 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:09:34.825 [rsHealthPoll] replset info rs1-0 heartbeat failed, retrying</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet info rs1-0 is down (or slow to respond):</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:09:34.826 [rsHealthPoll] replSet member rs1-0 is now </code><code class="bash keyword">in</code> <code class="bash plain">state DOWN</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">Thu Jan&nbsp; 9 02:09:35.746 [rsMgr] replSet info electSelf 1</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">Thu Jan&nbsp; 9 02:09:36.378 [rsMgr] replSet PRIMARY</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>&nbsp;</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#hack" class="page__taxonomy-item" rel="tag">Hack</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hack" class="page__taxonomy-item" rel="tag">Hack</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2013-10-03T00:00:00-07:00">October 03, 2013</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=wayneye&text=Setup+MongoDB+with+sharding+infrastructure%20https%3A%2F%2Fwayneye.com%2FSetup_MongoDB_With_Sharding_Infrastructure" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwayneye.com%2FSetup_MongoDB_With_Sharding_Infrastructure" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwayneye.com%2FSetup_MongoDB_With_Sharding_Infrastructure" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/MongoDB_Schema_Design_And_Common_Practices" class="pagination--pager" title="MongoDB Schema Design and Common Practices
">Previous</a>
    
    
      <a href="/My-New-iMac" class="pagination--pager" title="My New iMac
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section class="fb-comments" data-href="https://wayneye.com/Setup_MongoDB_With_Sharding_Infrastructure" data-mobile="true" data-num-posts="5" data-width="100%" data-colorscheme="light"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Master-AWS-Development-Video-Published" rel="permalink">Master AWS Development Video Published
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Publishing information

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/Passing-AWS-Certified-Solutions-Architect" rel="permalink">Passing AWS Certified Solutions Architect
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">
3 years of AWS hands on experience, two months of preparation, 30 hours of course learning, 300+ exam practices, this was the work I've done to pass the&nbs...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/self-improvement/passing-aws-certified-solutions-architect/" rel="permalink">Passing AWS Certified Solutions Architect
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/geek/Storage-Media-Home-Server-Less-Than-300/" rel="permalink">Storage+Media home server for less than $300
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Background
I have been researched and watched many NAS options to setup a home storage+media server during the past year, and so far there was no perfect ans...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="mailto:admin@wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
        
          <li><a href="https://wayneye.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> Website</a></li>
        
      
        
          <li><a href="https://twitter.com/wayneye" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://facebook.com/WayneYeDotCom" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
        
      
        
          <li><a href="https://github.com/WayneYe/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Wayne Ye. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>







    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5&appId=374223339969060";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
  





  </body>
</html>
